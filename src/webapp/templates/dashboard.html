{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}

{% block main_class %}container-fluid py-4{% endblock %}

{% block content %}
<div class="dashboard-root">
    <div class="row g-4">

        <div class="col-12 col-xl-8 d-flex flex-column gap-4">

            <div class="dashboard-card bg-white rounded-3 shadow-sm p-4 dashboard-welcome">
                <div class="d-flex align-items-center flex-wrap gap-3">
                    <div class="bg-success bg-opacity-10 rounded-circle p-3 flex-shrink-0">
                        <i class="bi bi-person-circle text-success" style="font-size: 3rem"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h1 class="h3 mb-0">
                            ¡Bienvenido/a, <span class="text-success fw-bold">{{ username }}</span>!
                        </h1>
                    </div>
                </div>
            </div>

            <div class="row g-4 align-items-stretch">

                <div class="col-12 col-lg-5">
                    <div class="dashboard-card bg-white rounded-3 shadow-sm p-3 h-100">
                        <div class="dashboard-map-frame border border-2 border-success position-relative">
                                                        {% if minimap_img_url %}
                            <img src="{{ minimap_img_url }}" alt="Vista satélite del municipio"
                                class="dashboard-map-image">
                            {% else %}
                            <div class="dashboard-map-fallback">
                                <div class="dashboard-map-fallback-inner">
                                    <strong>Vista no disponible</strong>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="col-12 col-md-6 col-lg-3">
                    <div class="dashboard-card bg-white rounded-3 shadow-sm p-3 h-100 d-flex flex-column justify-content-between gap-3">
                        
                        <div class="d-flex flex-column gap-2">
                            <a href="{{ url_for('dashboard.visor') }}" class="btn btn-primary w-100 text-truncate">
                                <i class="bi bi-map me-2"></i>Acceder al Mapa
                            </a>

                            <a href="{{ url_for('auth.mis_recintos') }}" class="btn btn-success w-100 text-truncate">
                                <i class="bi bi-grid me-2"></i>Mis Recintos
                            </a>

                            <a class="btn btn-success disabled w-100 text-truncate" aria-disabled="true" tabindex="-1">
                                <i class="bi bi-journal-text me-2"></i>Plan de Cultivo
                            </a>
                        </div>

                        {% if is_admin %}
                        <div class="card border-0 bg-light shadow-sm mt-auto">
                            <div class="card-body p-2 p-md-3">
                                <div class="text-uppercase fw-bold small text-secondary mb-2 border-bottom pb-1">
                                    <i class="bi bi-shield-lock me-1"></i> Panel de Administrador
                                </div>
                                <div class="d-flex flex-column gap-2">
                                    <a href="{{ url_for('admin.gestion_usuarios') }}" class="btn btn-dark btn-sm text-start text-truncate">
                                        <i class="bi bi-people me-2"></i>Gestión de Usuarios
                                    </a>
                                    <a href="{{ url_for('admin.gestion_recintos') }}" class="btn btn-dark btn-sm text-start text-truncate">
                                        <i class="bi bi-grid-3x3-gap me-2"></i>Gestión de Recintos
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <div class="col-12 col-lg-4">
                    <div class="dashboard-card bg-white rounded-3 shadow-sm p-3 h-100">
                        <div class="d-flex align-items-center justify-content-between mb-2 flex-wrap gap-2">
                            <div class="fw-bold text-primary d-flex align-items-center gap-2">
                                <i class="bi bi-droplet-half"></i>
                                <span>Estimación Riego</span>
                            </div>
                            <button class="btn btn-primary btn-sm" disabled>Ver detalle</button>
                        </div>

                        <div class="dashboard-map-frame dashboard-map-frame--placeholder border-0">
                            <div class="dashboard-etp-placeholder w-100 h-100">
                                <div class="placeholder-img-overlay d-flex align-items-center justify-content-center text-center p-3" 
                                     style="background: linear-gradient(135deg, #6610f2 0%, #6f42c1 100%); color: white; border-radius: 8px; height: 100%;">
                                     <div>
                                        <i class="bi bi-layers-half fs-1 mb-2"></i>
                                        <p class="small mb-0">Mapa de estimación de riego pendiente</p>
                                     </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="w-100 mt-2">
                <p class="text-muted mb-2 text-center small">
                    <i class="bi bi-info-circle me-1"></i> Mostrando el tiempo del municipio asociado a tus recintos
                </p>
                <div class="dashboard-aemet card shadow-sm border-0 overflow-hidden">
                    <iframe
                        name="iframe_aemet"
                        tabindex="0"
                        src="{{ url_widget }}"
                        frameborder="0"
                        scrolling="no"
                        style="width: 100%; min-height: 600px; display: block;">
                    </iframe>
                </div>
            </div>

        </div>

        <div class="col-12 col-xl-4">
            <div class="dashboard-summary card shadow-sm border-0 h-100">
                
                <div class="card-header bg-success text-white py-3 text-center">
                    <h5 class="mb-0 fw-bold"><i class="bi bi-clipboard-data me-2"></i>Resumen Rápido</h5>
                </div>

                <div class="card-body p-0 dashboard-summary-scroll">
                    
                    <div class="p-3">
                        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                            <div class="d-flex align-items-center gap-3">
                                <div class="bg-success bg-opacity-10 p-2 rounded flex-shrink-0">
                                    <i class="bi bi-grid fs-4 text-success"></i>
                                </div>
                                <span class="fw-semibold">Recintos Registrados:</span>
                            </div>
                            <div>
                                {% if recintos_count and recintos_count > 0 %}
                                <span class="badge bg-success fs-5">{{ recintos_count }}</span>
                                {% else %}
                                <span class="text-muted">—</span>
                                {% endif %}
                            </div>
                        </div>

                        <div class="dashboard-divider my-3"></div>

                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                            <div class="d-flex align-items-center gap-3">
                                <div class="bg-success bg-opacity-10 p-2 rounded flex-shrink-0">
                                    <i class="fa-solid fa-wheat-awn fs-4 text-success"></i>
                                </div>
                                <span class="fw-semibold">Cultivo Principal:</span>
                            </div>
                            <div class="text-end">
                                {% if cultivo_principal %}
                                <span class="text-success fw-bold fs-5">{{ cultivo_principal }}</span>
                                {% else %}
                                <span class="badge bg-secondary">Sin Cultivo</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="dashboard-divider dashboard-divider--thick"></div>

                    <div class="dashboard-section">
                        <div class="dashboard-section-header bg-primary bg-opacity-10 text-primary p-3 d-flex flex-wrap justify-content-between align-items-center gap-2">
                            <div class="fw-bold d-flex align-items-center">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>ALERTAS
                            </div>
                            <button class="btn btn-sm btn-outline-primary" disabled>Ver Detalle</button>
                        </div>

                        <div class="p-3">
                            <div class="text-muted small text-center py-3 bg-light rounded border border-dashed">
                                <i class="bi bi-check-circle text-success mb-1 d-block" style="font-size: 1.5rem;"></i>
                                No hay alertas de riego activas.
                            </div>
                        </div>
                    </div>

                    <div class="dashboard-divider dashboard-divider--thick"></div>

                    <div class="dashboard-section">
                        <div class="dashboard-section-header bg-success bg-opacity-10 text-success p-3 d-flex flex-wrap justify-content-between align-items-center gap-2">
                            <div class="fw-bold d-flex align-items-center">
                                <i class="fa-solid fa-chart-line me-2"></i>OPERACIONES
                            </div>
                            <button class="btn btn-sm btn-outline-success" disabled>Plan Cultivo</button>
                        </div>

                        <div class="p-3">
                            {% if not operaciones_resumen or operaciones_resumen|length == 0 %}
                            <div class="text-center text-muted py-3">
                                <i class="bi bi-inbox fs-1 d-block mb-2 opacity-25"></i>
                                Ahora mismo no hay operaciones activas.
                            </div>
                            {% else %}
                            {% for r in operaciones_resumen %}
                            <div class="mb-3 border-bottom pb-3 last-no-border">
                                <div class="fw-bold text-dark mb-2 border-start border-3 border-success ps-2 text-truncate">{{ r.nombre }}</div>

                                {% if r.ops and r.ops|length > 0 %}
                                <div class="d-flex flex-column gap-2">
                                    {% for op in r.ops %}
                                    <div class="bg-light p-2 rounded">
                                        <div class="d-flex justify-content-between align-items-center mb-1 flex-wrap gap-1">
                                            <span class="badge {{ op.badge_class }}">{{ op.tipo_label }}</span>
                                            <span class="text-muted small" style="font-size: 0.75rem;">{{ op.fecha }}</span>
                                        </div>
                                        <div class="text-secondary small lh-sm">{{ op.resumen }}</div>
                                    </div>
                                    {% endfor %}
                                </div>
                                {% else %}
                                <div class="text-muted small fst-italic">Sin operaciones recientes.</div>
                                {% endif %}
                            </div>
                            {% endfor %}
                            {% endif %}
                        </div>
                    </div>

                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script id="dashboard-start-view" type="application/json">
  {{ start_view|tojson }}
</script>
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}