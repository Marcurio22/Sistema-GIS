{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}

{% block main_class %}container-fluid py-4{% endblock %}

{% block content %}
<div class="dashboard-root">
    <div class="row g-4 align-items-stretch">

    <!-- Columna izquierda (principal) -->
    <div class="col-12 col-xl-8 h-100 overflow-hidden">

        <!-- Bienvenida -->
        <div class="dashboard-card bg-white rounded-3 shadow-sm p-4 mb-4 dashboard-welcome">
        <div class="d-flex align-items-center">
            <div class="bg-success bg-opacity-10 rounded-circle p-3 me-3 flex-shrink-0">
            <i class="bi bi-person-circle text-success" style="font-size: 3rem"></i>
            </div>
            <div class="flex-grow-1">
            <h1 class="h3 mb-0">
                ¡Bienvenido/a, <span class="text-success fw-bold">{{ username }}</span>!
            </h1>
            </div>
        </div>
        </div>

        <!-- Fila: minimapa + acciones + riego -->
        <div class="row g-4 align-items-stretch mb-4">

        <!-- Minimapa situación -->
        <div class="col-12 col-lg-5">
            <div class="dashboard-card bg-white rounded-3 shadow-sm p-3 h-100">
                <div class="dashboard-map-frame">
                    {% if minimap_img_url %}
                        <img
                        src="{{ minimap_img_url }}"
                        alt="Vista satélite del municipio"
                        class="dashboard-map-image"
                        >
                    {% else %}
                        <div class="dashboard-map-fallback">
                        <div class="dashboard-map-fallback-inner">
                            <strong>Vista no disponible</strong>
                        </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Acciones (botones) -->
        <div class="col-12 col-lg-3">
            <div class="dashboard-card bg-white rounded-3 shadow-sm p-3 h-100 d-flex flex-column">

            <div class="d-grid gap-2">
                <a href="{{ url_for('dashboard.visor') }}" class="btn btn-primary">
                <i class="bi bi-map me-2"></i>Acceder al Mapa
                </a>

                <a href="{{ url_for('auth.mis_recintos') }}" class="btn btn-success">
                <i class="bi bi-grid me-2"></i>Acceder a Mis Recintos
                </a>

                <a class="btn btn-success disabled" aria-disabled="true" tabindex="-1">
                <i class="bi bi-journal-text me-2"></i>Plan de Cultivo
                </a>
            </div>

            {% if is_admin %}
            <div class="mt-3 p-3 dashboard-admin-panel rounded-3">
                <div class="text-uppercase fw-bold small text-muted mb-2">Panel de Administrador</div>

                <div class="d-grid gap-2">
                <a href="{{ url_for('admin.gestion_usuarios') }}" class="btn btn-success">
                    <i class="bi bi-people me-2"></i>Gestión de Usuarios
                </a>
                <a href="{{ url_for('admin.gestion_recintos') }}" class="btn btn-success">
                    <i class="bi bi-grid-3x3-gap me-2"></i>Gestión de Recintos
                </a>
                </div>
            </div>
            {% endif %}

            <div class="flex-grow-1"></div>
            </div>
        </div>

        <!-- Minimapa riego (placeholder) -->
        <div class="col-12 col-lg-4">
            <div class="dashboard-card bg-white rounded-3 shadow-sm p-3 h-100">

            <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="fw-bold text-primary d-flex align-items-center gap-2">
                <i class="bi bi-droplet-half"></i>
                <span>Estimación de Riego</span>
                </div>
                <button class="btn btn-primary btn-sm" disabled>
                Más detalle
                </button>
            </div>

            <div class="dashboard-map-frame dashboard-map-frame--placeholder">
                <div class="dashboard-etp-placeholder">
                <div class="text-muted small">
                    (Mapa de estimación de riego pendiente)
                </div>
                </div>
            </div>

            </div>
        </div>

        </div>

        <!-- AEMET -->
        <p class="text-muted mt-2 mb-2 text-center" style="font-size: 1.05rem;">
        Mostrando el tiempo del municipio asociado a tus recinto o el de un municipio de referencia
        </p>

        <div class="dashboard-aemet mb-2">
        <iframe
            name="iframe_aemet"
            width="100%"
            height="100%"
            tabindex="0"
            src="{{ url_widget }}"
            frameborder="0"
            scrolling="no"></iframe>
        </div>

    </div>

    <!-- Columna derecha (Resumen rápido) -->
    <div class="col-12 col-xl-4 h-100">
        <div class="dashboard-summary card shadow-sm h-100">
        <div class="card-header dashboard-summary-header">
            Resumen Rápido
        </div>

        <div class="dashboard-summary-scroll card-body">

            <!-- Número de recintos -->
            <div class="dashboard-summary-item">
            <div class="d-flex align-items-center gap-3">
                <i class="bi bi-grid fs-4"></i>
                <div class="fw-semibold">Número de Recintos Registrados:</div>
            </div>

            <div class="ms-auto">
                {% if recintos_count and recintos_count > 0 %}
                <span class="badge bg-success fs-6">{{ recintos_count }}</span>
                {% else %}
                <span class="text-muted">No hay recintos asociados todavía</span>
                {% endif %}
            </div>
            </div>

            <!-- Cultivo principal -->
            <div class="dashboard-summary-item">
            <div class="d-flex align-items-center gap-3">
                <i class="bi bi-wheat fs-4"></i>
                <div class="fw-semibold">Cultivo Principal:</div>
            </div>

            <div class="ms-auto">
                {% if cultivo_principal %}
                <span class="text-success fw-bold">{{ cultivo_principal }}</span>
                {% else %}
                <span class="text-muted">No hay cultivos implantados todavía</span>
                {% endif %}
            </div>
            </div>

            <!-- Alertas de riego -->
            <div class="dashboard-section">
            <div class="dashboard-section-header">
                <div class="d-flex align-items-center gap-2">
                <i class="bi bi-exclamation-triangle-fill"></i>
                <span>ALERTAS DE RIEGO</span>
                </div>
                <button class="btn btn-primary btn-sm" disabled>
                Acceder a Detalle de Riego
                </button>
            </div>

            <div class="dashboard-section-body">
                <div class="text-muted">Todavía no hay alertas de riego.</div>
            </div>
            </div>

            <!-- Operaciones activas -->
            <div class="dashboard-section">
            <div class="dashboard-section-header dashboard-section-header--success">
                <div class="d-flex align-items-center gap-2">
                <i class="bi bi-check-circle-fill"></i>
                <span>OPERACIONES ACTIVAS</span>
                </div>
                <button class="btn btn-success btn-sm" disabled>
                Acceder a Plan de Cultivo
                </button>
            </div>

            <div class="dashboard-section-body">

                {% if not operaciones_resumen or operaciones_resumen|length == 0 %}
                    <div class="text-muted">
                        Ahora mismo no hay operaciones activas.
                    </div>
                {% else %}
                {% for r in operaciones_resumen %}
                    <div class="dashboard-recinto-block">
                    <div class="dashboard-recinto-title">{{ r.nombre }}</div>

                    {% if r.ops and r.ops|length > 0 %}
                        <div class="dashboard-ops-list">
                        {% for op in r.ops %}
                            <div class="dashboard-op-item">
                            <div class="d-flex align-items-center gap-2 flex-wrap">
                                <span class="badge {{ op.badge_class }}">{{ op.tipo_label }}</span>
                                <span class="text-muted small">{{ op.fecha }}</span>
                            </div>
                            <div class="dashboard-op-resumen">{{ op.resumen }}</div>
                            </div>
                        {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-muted">Ahora mismo no hay operaciones asociadas a esta parcela</div>
                    {% endif %}
                    </div>
                {% endfor %}
                {% endif %}

            </div>
            </div>

        </div>
        </div>
    </div>

    </div>

</div>

<!-- Tarjeta del Tiempo -->

<!-- 
<div class="row mb-4">
    <div class="col-12">
        <div class="bg-primary bg-opacity-10 rounded-3 shadow-sm p-5">
            <div class="row align-items-center">
                <div class="col-md-6 text-center text-md-start mb-4 mb-md-0">
                    <div class="d-flex align-items-center justify-content-center justify-content-md-start">
                        <i class="bi bi-{{ weather.icono }} {{ weather.color_icono }}" style="font-size: 6rem;"></i>
                        <div class="ms-4">
                            <div class="display-1 fw-bold text-primary">{{ weather.temperatura }}°</div>
                            <p class="h4 text-muted mb-0">{{ weather.descripcion }}</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="row g-3">
                        {% if weather.humedad %}
                        <div class="col-4">
                            <div class="bg-white rounded-3 p-3 text-center shadow-sm h-100">
                                <i class="bi bi-droplet-fill text-info" style="font-size: 2.5rem;"></i>
                                <h3 class="mb-0 mt-2">{{ weather.humedad }}%</h3>
                                <small class="text-muted">Humedad</small>
                            </div>
                        </div>
                        {% endif %}
                        {% if weather.viento_velocidad %}
                        <div class="col-4">
                            <div class="bg-white rounded-3 p-3 text-center shadow-sm h-100">
                                <i class="bi bi-wind text-secondary" style="font-size: 2.5rem;"></i>
                                <h3 class="mb-0 mt-2">{{ weather.viento_velocidad }}</h3>
                                <small class="text-muted">
                                    km/h
                                    {% if weather.viento_grados is not none %}
                                    <i class="bi bi-arrow-down-short text-secondary d-inline-block align-middle" 
                                       style="font-size: 1.5rem; --rotation: {{ weather.viento_grados }}deg; transform: rotate(var(--rotation));"></i>
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                        {% endif %}
                        {% if weather.prob_precipitacion %}
                        <div class="col-4">
                            <div class="bg-white rounded-3 p-3 text-center shadow-sm h-100">
                                <i class="bi bi-cloud-rain-fill text-primary" style="font-size: 2.5rem;"></i>
                                <h3 class="mb-0 mt-2">{{ weather.prob_precipitacion }}%</h3>
                                <small class="text-muted">Prob. lluvia</small>
                            </div>
                        </div>
                        {% endif %}
                        <div class="col-12">
                            <div class="text-center text-md-start mt-2">
                                <small class="text-muted">
                                    <i class="bi bi-geo-alt-fill"></i> {{ weather.municipio }}, {{
                                    weather.provincia }}, España
                                    <span class="mx-2">•</span>
                                    <i class="bi bi-cloud-check-fill"></i> Datos de AEMET
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
-->

{% endblock %}

{% block extra_js %}
<script id="dashboard-start-view" type="application/json">
  {{ start_view|tojson }}
</script>

<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}
