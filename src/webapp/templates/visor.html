{% extends "base.html" %}

{% block title %}Visor SIG{% endblock %}

{% block content %}

<!-- Leaflet CSS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>

<style>
  /* El mapa ocupa toda la ventana menos la barra verde superior */
  html,
  body {
    height: 100%;
  }

  #map {
    position: fixed;
    top: 65px; /* altura aproximada de la navbar; ajusta si hace falta */
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1;
  }

  /* ---------- Bot√≥n y panel de mapas de detalle ---------- */

  #basemap-panel-container {
    position: fixed;
    top: 80px;     /* un poco por debajo de la barra verde */
    right: 20px;
    z-index: 1000; /* por encima del mapa */
    font-family: inherit;
  }

  #basemap-toggle {
    width: 40px;
    height: 40px;
    border-radius: 4px;
    border: none;
    background-color: #ffffff;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s, color 0.2s;
  }

  #basemap-toggle span {
    font-size: 20px;
    line-height: 1;
  }

  #basemap-toggle.active {
    background-color: #1b5e20; /* verde tipo barra superior */
    color: #ffffff;
  }

  #basemap-panel {
    margin-top: 8px;
    width: 320px;
    max-height: 70vh;
    background-color: #ffffff;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    border-radius: 4px;
    padding: 10px 14px;
    display: none; /* oculto por defecto */
    overflow-y: auto;
  }

  #basemap-panel.visible {
    display: block;
  }

  #basemap-panel h6 {
    font-size: 0.9rem;
    font-weight: 600;
    margin-top: 6px;
    margin-bottom: 6px;
  }

  .basemap-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 10px;
  }

  .basemap-option {
    width: 90px;
    cursor: pointer;
    text-align: center;
    font-size: 0.8rem;
  }

  .basemap-thumb {
    width: 90px;
    height: 60px;
    border-radius: 3px;
    border: 2px solid transparent;
    background-size: cover;
    background-position: center;
    margin-bottom: 3px;
  }

  /* mini ‚Äúpreviews‚Äù de ejemplo */
  .thumb-sat {
    background-image: linear-gradient(135deg, #4caf50, #795548);
  }

  .thumb-ndvi {
    background-image: linear-gradient(135deg, #1b5e20, #aeea00);
  }

  .thumb-etp {
    background-image: linear-gradient(135deg, #01579b, #4dd0e1);
  }

  .basemap-option.active .basemap-thumb {
    border-color: #1b5e20;
  }

  .basemap-option.disabled {
    opacity: 0.4;
    cursor: default;
  }
</style>

<div id="map"></div>

<!-- Bot√≥n + panel de selecci√≥n de mapa de detalle -->
<div id="basemap-panel-container">
  <button id="basemap-toggle" title="Cambiar mapa de detalle">
    <span>üó∫Ô∏è</span>
  </button>

  <div id="basemap-panel">
    <h6>Mapa Principal</h6>
    <div class="basemap-grid">
      <!-- Opci√≥n activa por defecto: imagen sat√©lite -->
      <div class="basemap-option basemap-main active" data-layer="satellite">
        <div class="basemap-thumb thumb-sat"></div>
        <div>Imagen Satelital</div>
      </div>

      <!-- NDVI: seleccionable -->
      <div class="basemap-option basemap-main" data-layer="ndvi">
        <div class="basemap-thumb thumb-ndvi"></div>
        <div>Vigor Vegetal (NDVI)</div>
      </div>

      <!-- ETP a√∫n sin l√≥gica -->
      <div class="basemap-option basemap-main disabled">
        <div class="basemap-thumb thumb-etp"></div>
        <div>ETP</div>
      </div>
    </div>

    <h6>Nivel de Detalle</h6>
    <div class="basemap-grid">
      <!-- De momento s√≥lo esqueletos informativos -->
      <div class="basemap-option basemap-detail disabled">
        <div class="basemap-thumb thumb-sat"></div>
        <div>Mis Parcelas</div>
      </div>

      <!-- *** Recintos SigPac: ACTIVO POR DEFECTO Y CONMUTA LA CAPA *** -->
      <div
        class="basemap-option basemap-detail active"
        data-detail="sigpac"
      >
        <div class="basemap-thumb thumb-sat"></div>
        <div>Recintos SigPac</div>
      </div>

      <div class="basemap-option basemap-detail disabled">
        <div class="basemap-thumb thumb-sat"></div>
        <div>Parcelas Calculadas</div>
      </div>
    </div>
  </div>
</div>

<!-- Leaflet JS -->
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // -----------------------------------------
    // 1) ROI desde Flask: roi_bbox = (minx, miny, maxx, maxy)
    // -----------------------------------------
    const roiBbox = [
      {{ roi_bbox[0] }},
      {{ roi_bbox[1] }},
      {{ roi_bbox[2] }},
      {{ roi_bbox[3] }}
    ];

    // Leaflet usa [lat, lng] -> [S,W] y [N,E]
    const ROI_BOUNDS = L.latLngBounds(
      [roiBbox[1], roiBbox[0]], // (miny, minx) = sudoeste
      [roiBbox[3], roiBbox[2]]  // (maxy, maxx) = nordeste
    );

    // Zoom a partir del cual:
    //   - cambiamos a mapa de detalle (sat√©lite / NDVI)
    //   - mostramos y cargamos recintos (si est√°n activados)
    const ZOOM_RECINTOS = 15;

    // -----------------------------------------
    // 2) Crear mapa limitado al ROI
    // -----------------------------------------
    const map = L.map("map", {
      maxBounds: ROI_BOUNDS,
      maxBoundsViscosity: 1.0,
      zoomControl: true,
    });

    map.fitBounds(ROI_BOUNDS);

    // -----------------------------------------
    // 3) Capas base
    // -----------------------------------------

    // Mapa base 1 ‚Äì OSM (fondo claro, zoom lejano)
    const baseOSM = L.tileLayer(
      "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
      {
        attribution: "&copy; OpenStreetMap contributors",
        minZoom: 8,
        maxZoom: 19,
      }
    ).addTo(map);

    // Mapa base 2 ‚Äì Sat√©lite (Esri World Imagery)
    const baseSat = L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      {
        attribution: "Tiles &copy; Esri",
        minZoom: 8,
        maxZoom: 19,
      }
    );

    // Capa NDVI (por ahora una imagen overlay sobre todo el ROI)
    const baseNdvi = L.imageOverlay(
      "/static/ndvi/ndvi_latest.png", // AJUSTA ESTA RUTA A TU PNG NDVI
      ROI_BOUNDS,
      { opacity: 1.0 }
    );

    const highZoomLayers = {
      satellite: baseSat,
      ndvi: baseNdvi
    };

    let activeHighLayerKey = "satellite";
    function getActiveHighLayer() {
      return highZoomLayers[activeHighLayerKey];
    }

    // -----------------------------------------
    // 4) Capa de recintos (vac√≠a al principio)
    // -----------------------------------------
    const recintosLayer = L.geoJSON(null, {
      style: {
        color: "#ff8800",
        weight: 1,
      },
      onEachFeature: function (feature, layer) {
        const p = feature.properties || {};
        const html = `
          <strong>Provincia:</strong> ${p.provincia ?? "-"}<br>
          <strong>Municipio:</strong> ${p.municipio ?? "-"}<br>
          <strong>Pol√≠gono:</strong> ${p.poligono ?? "-"}<br>
          <strong>Parcela:</strong> ${p.parcela ?? "-"}<br>
          <strong>Recinto:</strong> ${p.recinto ?? "-"}
        `;
        layer.bindPopup(html);
      },
    }).addTo(map);

    // *** Recintos activos por defecto (porque el tile viene activo) ***
    let recintosActivos = true;

    // -----------------------------------------
    // 5) Funci√≥n: pedir recintos SOLO si el zoom es suficiente y est√°n activos
    // -----------------------------------------
    function cargarRecintosSiProcede() {
      const z = map.getZoom();

      // Si zoom es bajo o la capa est√° desactivada, se limpian
      if (z < ZOOM_RECINTOS || !recintosActivos) {
        recintosLayer.clearLayers();
        return;
      }

      const b = map.getBounds();

      const bbox = [
        b.getWest().toFixed(6),
        b.getSouth().toFixed(6),
        b.getEast().toFixed(6),
        b.getNorth().toFixed(6),
      ].join(",");

      console.log("Solicitando recintos para bbox:", bbox);

      fetch(`/api/recintos?bbox=${bbox}`)
        .then((response) => {
          if (!response.ok) {
            throw new Error("Respuesta no OK de /api/recintos");
          }
          return response.json();
        })
        .then((fc) => {
          console.log(
            "Recintos recibidos:",
            fc && fc.features ? fc.features.length : 0
          );

          recintosLayer.clearLayers();

          if (!fc || !fc.features || fc.features.length === 0) {
            return;
          }

          recintosLayer.addData(fc);
        })
        .catch((err) => {
          console.error("Error al cargar recintos:", err);
        });
    }

    // -----------------------------------------
    // 6) Funci√≥n: cambiar fondo seg√∫n zoom
    // -----------------------------------------
    function actualizarMapaSegunZoom() {
      const z = map.getZoom();
      const activeHighLayer = getActiveHighLayer();

      if (z >= ZOOM_RECINTOS) {
        // Zoom ‚Äúcerca‚Äù: capa de detalle activa
        if (map.hasLayer(baseOSM)) {
          map.removeLayer(baseOSM);
        }

        Object.values(highZoomLayers).forEach((layer) => {
          if (layer && layer !== activeHighLayer && map.hasLayer(layer)) {
            map.removeLayer(layer);
          }
        });

        if (activeHighLayer && !map.hasLayer(activeHighLayer)) {
          activeHighLayer.addTo(map);
        }
      } else {
        // Zoom ‚Äúlejos‚Äù: s√≥lo OSM, sin detalles ni recintos
        Object.values(highZoomLayers).forEach((layer) => {
          if (layer && map.hasLayer(layer)) {
            map.removeLayer(layer);
          }
        });

        if (!map.hasLayer(baseOSM)) {
          baseOSM.addTo(map);
        }

        recintosLayer.clearLayers();
      }
    }

    // -----------------------------------------
    // 7) Eventos del mapa
    // -----------------------------------------
    map.on("zoomend", () => {
      actualizarMapaSegunZoom();
      cargarRecintosSiProcede();
    });

    map.on("moveend", () => {
      cargarRecintosSiProcede();
    });

    actualizarMapaSegunZoom();
    cargarRecintosSiProcede();

    // -----------------------------------------
    // 8) L√≥gica del bot√≥n y panel
    // -----------------------------------------
    const toggleBtn = document.getElementById("basemap-toggle");
    const panel = document.getElementById("basemap-panel");

    toggleBtn.addEventListener("click", () => {
      panel.classList.toggle("visible");
      toggleBtn.classList.toggle("active");
    });

    // --- Selecci√≥n de mapa principal (sat√©lite / NDVI) ---
    document
      .querySelectorAll(".basemap-option.basemap-main[data-layer]")
      .forEach((option) => {
        option.addEventListener("click", () => {
          const layerKey = option.dataset.layer;
          if (!highZoomLayers[layerKey]) {
            return;
          }

          // Solo afectamos a las opciones de "Mapa Principal"
          document
            .querySelectorAll(".basemap-option.basemap-main")
            .forEach((el) => el.classList.remove("active"));
          option.classList.add("active");

          activeHighLayerKey = layerKey;
          actualizarMapaSegunZoom();
        });
      });

    // --- Toggle Recintos SigPac (nivel de detalle) ---
    const recintosOption = document.querySelector(
      '.basemap-option.basemap-detail[data-detail="sigpac"]'
    );

    if (recintosOption) {
      recintosOption.addEventListener("click", () => {
        // alternar estado
        recintosActivos = !recintosActivos;

        if (recintosActivos) {
          recintosOption.classList.add("active");
          // si estamos en zoom suficiente, recargar recintos
          cargarRecintosSiProcede();
        } else {
          recintosOption.classList.remove("active");
          recintosLayer.clearLayers();
        }
      });
    }
  });
</script>

{% endblock %}