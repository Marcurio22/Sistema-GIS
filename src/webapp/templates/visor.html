{% extends "base.html" %}

{% block title %}Visor SIG{% endblock %}

{% block navbar_extra %}
<div class="d-none d-md-flex align-items-center gap-3 bg-white rounded-3 px-3 py-2 shadow-sm">
  <!-- Temperatura principal -->
  <div class="d-flex align-items-center">
    <i class="bi bi-{{ weather.icono }} {{ weather.color_icono }}" style="font-size: 1.5rem;"></i>
    <span class="ms-2 fw-bold fs-5 text-dark">{{ weather.temperatura }}°</span>
  </div>

  <!-- Separador -->
  <div class="vr opacity-50"></div>

  <!-- Datos compactos -->
  <div class="d-flex gap-3 small text-dark">
    {% if weather.humedad %}
    <div class="d-flex align-items-center">
      <i class="bi bi-droplet-fill text-info me-1"></i>
      <span>{{ weather.humedad }}%</span>
    </div>
    {% endif %}

    {% if weather.viento_velocidad %}
    <div class="d-flex align-items-center">
      <i class="bi bi-wind text-secondary me-1"></i>
      <span>{{ weather.viento_velocidad }} km/h</span>
    </div>
    {% endif %}

    {% if weather.prob_precipitacion %}
    <div class="d-flex align-items-center">
      <i class="bi bi-cloud-rain text-primary me-1"></i>
      <span>{{ weather.prob_precipitacion }}%</span>
    </div>
    {% endif %}
  </div>

  <div class="d-none d-lg-block text-muted small">
    <i class="bi bi-geo-alt-fill"></i> {{ weather.municipio }}
  </div>
</div>
<div id="notification-container"></div>
<div id="lightbox" class="lightbox" style="display: none;">
  <span class="lightbox-close">&times;</span>
  <img class="lightbox-content" id="lightbox-img">
  <div class="lightbox-caption" id="lightbox-caption"></div>
  <button class="lightbox-prev" id="lightbox-prev">&#10094;</button>
  <button class="lightbox-next" id="lightbox-next">&#10095;</button>
</div>
{% endblock %}

{% block content %}


<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<link rel="stylesheet" href="{{ url_for('static', filename='css/visor.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/galeria.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/ndvi.css') }}">
<script src="{{ url_for('static', filename='js/galeria.js') }}"></script>
<script src="{{ url_for('static', filename='js/ndvi.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>


<div id="map"></div>

<!-- Botón de capas -->
<div id="basemap-panel-container">
  <button id="basemap-toggle" title="Capas">
    <i class="bi bi-layers-fill"></i>
  </button>
</div>

<!-- Panel de capas -->
<div id="basemap-panel">
  <h6>Mapa Principal</h6>
  <div class="basemap-grid">
    <div class="basemap-option basemap-main active" data-layer="satellite">
      <div class="basemap-thumb">
        <img src="{{ url_for('static', filename='img/thumb_satellite.png') }}" alt="Imagen satélite" />
      </div>
      <div class="basemap-option-label">Imagen<br>Satelital</div>
    </div>

    <div class="basemap-option basemap-main {% if sentinel2_version == 0 %}disabled{% endif %}" data-layer="sentinel_recent">
      <div class="basemap-thumb">
        <img src="{{ url_for('static', filename='img/thumb_sentinel2.png') }}" alt="Sentinel-2 reciente" />
      </div>
      <div class="basemap-option-label">Satélite<br>reciente</div>
    </div>

    <div class="basemap-option basemap-main" data-layer="ndvi">
      <div class="basemap-thumb">
        <img src="{{ url_for('static', filename='img/thumb_ndvi.png') }}" alt="Vigor Vegetal (NDVI)" />
      </div>
      <div class="basemap-option-label">Vigor Vegetal<br>(NDVI)</div>
    </div>

    <div class="basemap-option disabled">
      <div class="basemap-thumb">
        <img src="{{ url_for('static', filename='img/thumb_etp.png') }}" alt="ETP" />
      </div>
      <div class="basemap-option-label">ETP</div>
    </div>
  </div>

  <h6>Nivel de Detalle</h6>
  <div class="basemap-grid">
    <div class="basemap-option basemap-detail active" data-detail="mis">
      <div class="basemap-thumb">
        <img src="{{ url_for('static', filename='img/thumb_mis_recintos.png') }}" alt="Mis Recintos" />
      </div>
      <div class="basemap-option-label">Mis Recintos</div>
    </div>

    <div class="basemap-option basemap-detail active" data-detail="sigpac">
      <div class="basemap-thumb">
        <img src="{{ url_for('static', filename='img/thumb_recintos.png') }}" alt="Recintos SigPac" />
      </div>
      <div class="basemap-option-label">Recintos SigPac</div>
    </div>

    <div class="basemap-option disabled">
      <div class="basemap-thumb">
        <img src="{{ url_for('static', filename='img/thumb_cultivos.png') }}" alt="Cultivos SigPac" />
      </div>
      <div class="basemap-option-label">Cultivos SigPac</div>
    </div>
  </div>
</div>


<!-- Botón de filtros -->
<div id="filtro-container">
  <button id="filtro-toggle" title="Filtros">
    <i class="bi bi-funnel-fill"></i>
  </button>
</div>

<!-- Botón de dibujar -->
<div id="editar-container">
  <button id="dibujar-btn" class="hidden" title="Dibujar Rectángulo">
    <i class="bi bi-square"></i>
  </button>
  <button id="poligono-btn" class="hidden" title="Dibujar Polígono">
    <i class="bi bi-pentagon"></i>
  </button>
  <button id="editar-btn" title="Editar">
    <i class="bi bi-pencil-fill"></i>
  </button>
  <button id="aceptar-btn" class="hidden" title="Aceptar">
    <i class="bi bi-check-lg"></i>
  </button>
  <button id="limpiar-btn" class="hidden" title="Limpiar todo">
    <i class="bi bi-trash-fill"></i>
  </button>
  <button id="cancelar-btn" class="hidden" title="Cancelar">
    <i class="bi bi-x-lg"></i>
  </button>
</div>


<!-- Dibujos guardados-->

<div id="dibujos-panel-container">
  <button id="dibujos-toggle" title="Mis Dibujos NDVI">
    <i class="bi bi-bookmark-fill"></i>
    <span id="dibujos-count" class="badge-count" style="display:none;">0</span>
  </button>
</div>

<div id="dibujos-panel" class="hidden">
  <div class="dibujos-header">
  <h6><i class="bi bi-bookmark-fill me-2"></i>Mis Dibujos NDVI</h6>
</div>
  
  <div id="dibujos-list" class="dibujos-list"></div>
</div>

<!-- Panel derecho (split) -->
<aside id="side-panel" aria-hidden="true">

  <div class="side-content">
    <div class="side-sticky-top">
      <div class="side-header">
        <h1 id="side-title">Nombre Parcela</h1>

        <div class="side-actions">
          <button id="btn-edit-name" type="button" class="icon-btn edit" title="Editar nombre">
            <i class="bi bi-pencil-fill"></i>
          </button>
          <button id="btn-delete-recinto" type="button" class="icon-btn delete" title="Eliminar recinto">
            <i class="bi bi-trash-fill"></i>
          </button>       
          <button id="side-close" type="button" class="btn-side-close" title="Cerrar">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
      </div>

      <div class="side-divider"></div>
    </div>

    <div class="side-row">
      <i class="bi bi-globe2 side-ico"></i>

      <div class="side-line" style="display:flex;align-items:center;width:100%;">
        <span class="side-row-title">Superficie:</span>
        <span id="side-area" class="side-row-value ms-2">-</span>

        <!-- Icono localización decorativo a la derecha -->
        <i class="bi bi-geo-alt-fill ms-auto text-success" style="font-size:1.6rem" aria-hidden="true">
        </i>

        <!-- Coordenadas -->
        <span id="side-coords" class="side-row-value ms-2"></span>
      </div>
    </div>

    <div class="side-row">
      <i class="bi bi-person-fill side-ico"></i>
      <div class="side-row-text">
        <div class="side-row-title">Propietario:</div>
        <div id="side-owner" class="side-row-value">-</div>
      </div>
    </div>

    <label class="side-toggle">
      <input id="side-active" type="checkbox" checked />
      <span>Recinto activo</span>
    </label>
    <div class="side-divider"></div>

   <div class="side-section">
      <div class="side-section-head">
        <div></div>
    
        <h2 class="side-section-title mb-4">
          <i class="fa-solid fa-wheat-awn me-2" style="color:#198754"></i>
          <span class="side-section-label">Cultivos</span>
        </h2>
    
        <button id="btn-historico-cultivos" type="button" class="btn btn-success btn-historico">
          Histórico de cultivos
        </button>
      </div>
    
      <div id="cultivos-container"></div>
    </div>

    <div class="side-divider"></div>

    <!-- SECCIÓN NDVI -->
    <div class="side-section">
      <div class="side-section-head">
        <div></div>
    
        <h2 class="side-section-title mb-4">
          <i class="fa-solid fa-leaf me-2" style="color:#198754"></i>
          <span class="side-section-label">NDVI</span>
        </h2>
    
        <button id="btn-detalle-ndvi" type="button" class="btn btn-success btn-historico">
          Más detalle
        </button>
      </div>
    
      <div id="ndvi-container"></div>
    </div>

    <div class="side-divider"></div>

    <!-- OPERACIONES -->
    <div class="side-section" id="operaciones-section">
      <div class="side-section-head">
        <div></div>

        <h2 class="side-section-title mb-4">
          <i class="fa-solid fa-chart-line me-2" style="color:#198754"></i>
          <span class="side-section-label">Operaciones</span>
        </h2>

        <button id="btn-historico-operaciones" class="btn btn-outline-success btn-sm ms-auto">
          <i class="bi bi-clock-history me-1"></i> Ver histórico
        </button>
      </div>

      <div id="operaciones-container"></div>
    </div>

    <div class="side-divider"></div>

    <!-- OVERLAY HISTÓRICO OPERACIONES -->
    <div id="operaciones-historico-panel" class="side-overlay d-none" aria-hidden="true">
      <div class="overlay-topbar">
        <button id="btn-volver-operaciones-historico" class="btn btn-outline-secondary" type="button">
          <i class="bi bi-arrow-left me-1"></i> Volver
        </button>

        <div class="overlay-title">
          <i class="fa-solid fa-chart-line" style="color:#198754"></i>
          <span>Operaciones</span>
        </div>

        <button id="btn-cerrar-operaciones-historico" class="btn-side-close" type="button" title="Cerrar">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>

      <div class="side-divider"></div>
      <div id="operaciones-historico-list" class="pb-3"></div>
    </div>
    
    <!-- GALERÍA-->
    <div id="galeria-imagenes" class="galeria-container mt-4">
      <h2 class="side-section-title mb-3">
        <i class="fa-solid fa-image me-2" style="color:#198754"></i>
        Galería
      </h2>

      <!-- Botón Añadir Imagen -->
      <div class="mb-3">
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalSubida">
          <i class="fa-solid fa-plus me-1"></i> Añadir Imagen
        </button>
      </div>

      <!-- Grid de imágenes -->
      <div class="galeria-grid" id="galeria-grid">
        <!-- Se llenará dinámicamente -->
      </div>

    </div>

    <!-- OVERLAY HISTÓRICO CULTIVOS -->
    <div id="cultivos-historico-panel" class="side-overlay d-none" aria-hidden="true">

      <div class="overlay-topbar">
        <button id="btn-volver-historico" class="btn btn-outline-secondary" type="button">
          <i class="bi bi-arrow-left me-1"></i> Volver
        </button>

        <div class="overlay-title">
          <i class="fa-solid fa-wheat-awn" style="color:#198754"></i>
          <span>Cultivos</span>
        </div>

        <button id="btn-cerrar-historico" class="btn-side-close" type="button" title="Cerrar">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>

      <div class="side-divider"></div>
      <div id="cultivos-historico-list" class="pb-3"></div>
    </div>

    <!-- OVERLAY HISTÓRICO NDVI -->
    <div id="ndvi-historico-panel" class="side-overlay d-none" aria-hidden="true">

      <div class="overlay-topbar">
        <button id="btn-volver-historico-ndvi" class="btn btn-outline-secondary" type="button">
          <i class="bi bi-arrow-left me-1"></i> Volver
        </button>

        <div class="overlay-title">
          <i class="fa-solid fa-leaf" style="color:#198754"></i>
          <span>NDVI</span>
        </div>

        <button id="btn-cerrar-historico-ndvi" class="btn-side-close" type="button" title="Cerrar">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>

      <div class="side-divider"></div>
      <div id="ndvi-historico-list" class="pb-3"></div>
    </div>

    <!-- OVERLAY GALERÍA COMPLETA -->
    <div id="galeria-panel" class="side-overlay d-none" aria-hidden="true">
      <div class="overlay-topbar">
        <button id="btn-volver-galeria" class="btn btn-outline-secondary" type="button">
          <i class="bi bi-arrow-left me-1"></i> Volver
        </button>

        <div class="overlay-title">
          <i class="fa-solid fa-image" style="color:#198754"></i>
          <span>Galería</span>
        </div>

        <button id="btn-cerrar-galeria" class="btn-side-close" type="button" title="Cerrar">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>

      <div class="side-divider"></div>
      <div class="overlay-subbar">
        <div class="overlay-subtitle">
          Galería completa
          <span id="galeria-count" class="badge bg-success ms-2">0</span>
        </div>
      </div>

      <div id="galeria-panel-body"></div>
    </div>

    <div id="side-alerts"></div>
  </div>



</aside>

<!-- Modal confirmación -->
<div id="app-confirm-backdrop" class="app-confirm-backdrop d-none" aria-hidden="true">
  <div class="app-confirm-modal" role="dialog" aria-modal="true" aria-labelledby="app-confirm-title">
    <div class="app-confirm-header">
      <i class="bi bi-exclamation-triangle-fill" style="font-size:28px; color:#ffc107;"></i>
      <div>
        <div id="app-confirm-title" class="app-confirm-title">Confirmación</div>
        <div id="app-confirm-text" class="app-confirm-text"></div>
      </div>
    </div>

    <div class="app-confirm-actions">
      <button id="app-confirm-cancel" type="button" class="btn btn-secondary">Cancelar</button>
      <button id="app-confirm-ok" type="button" class="btn btn-danger">Eliminar</button>
    </div>
  </div>
</div>

<!-- Modal para subir nueva imagen -->
<div class="modal fade" id="modalSubida" tabindex="-1" aria-labelledby="modalSubidaLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="form-subida" enctype="multipart/form-data">
        <div class="modal-header">
          <h5 class="modal-title" id="modalSubidaLabel">Subir Nueva Imagen</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="imagen-file" class="form-label">Selecciona Imagen</label>
            <input class="form-control" type="file" id="imagen-file" accept="image/*" required>
          </div>
          <div class="mb-3">
            <label for="imagen-titulo" class="form-label">Título</label>
            <input type="text" class="form-control" id="imagen-titulo" required>
          </div>
          <div class="mb-3">
            <label for="imagen-descripcion" class="form-label">Descripción</label>
            <textarea class="form-control" id="imagen-descripcion" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-success">Subir Imagen</button>
        </div>
      </form>
    </div>
  </div>
</div>
<!-- Modal para editar imagen -->
<div class="modal fade" id="modalEditar" tabindex="-1" aria-labelledby="modalEditarLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="form-editar">
        <div class="modal-header">
          <h5 class="modal-title" id="modalEditarLabel">Editar Imagen</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editar-id-imagen">
          
           <div class="mb-3 text-center">
            <img id="editar-preview" 
                 src="" 
                 alt="Preview" 
                 style="max-width: 200px; max-height: 200px; border-radius: 8px; object-fit: cover; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          </div>
          <div class="mb-3">
            <label for="editar-titulo" class="form-label">Título</label>
            <input type="text" class="form-control" id="editar-titulo" required>
          </div>
          
          <div class="mb-3">
            <label for="editar-descripcion" class="form-label">Descripción</label>
            <textarea class="form-control" id="editar-descripcion" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-success">Guardar cambios</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Avanzado Cultivo -->
<div class="modal fade" id="modalAvanzadoCultivo" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Avanzado (cultivo)</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body" id="modalAvanzadoCultivoBody">
        <!-- contenido dinámico -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<script>
  const NotificationSystem = {
    container: null,
    initialized: false,

    init() {
      if (this.initialized) return;

      this.container = document.getElementById('notification-container');

      if (!this.container) {
        // Crear el contenedor si no existe
        this.container = document.createElement('div');
        this.container.id = 'notification-container';
        document.body.appendChild(this.container);
      
      } else {
      }
      this.initialized = true;
    },

    show({ type = 'info', title, message, duration = 5000 }) {
      // Inicializar si no está listo
      if (!this.initialized) {
        this.init();
      }

      if (!this.container) {
        alert(`${title}\n${message}`);
        return;
      }

      const notification = document.createElement('div');
      notification.className = `notification ${type}`;

      const icons = {
        success: '✓',
        error: '✕',
        warning: '⚠',
        info: 'i'
      };

      notification.innerHTML = `
        <div class="notification-icon">${icons[type]}</div>
        <div class="notification-content">
          <div class="notification-title">${this.escapeHtml(title)}</div>
          <div class="notification-message">${this.escapeHtml(message)}</div>
        </div>
        <button class="notification-close" aria-label="Cerrar">×</button>
        <div class="notification-progress"></div>
      `;

      // Evento de cierre
      const closeBtn = notification.querySelector('.notification-close');
      closeBtn.addEventListener('click', () => this.close(closeBtn));

      this.container.appendChild(notification);

      // Auto-cierre
      if (duration > 0) {
        setTimeout(() => {
          this.close(closeBtn);
        }, duration);
      }
    },

    close(button) {
      const notification = button.closest('.notification');
      if (!notification) return;

      notification.classList.add('removing');
      setTimeout(() => {
        if (notification.parentNode) {
          notification.remove();
        }
      }, 300);
    },

    // Escapar HTML para prevenir XSS
    escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  };

  // Función para establecer la variable CSS con la altura de la navbar
  function setNavbarHeightVar() {
    const candidates = [
      'nav.navbar.fixed-top',
      'nav.navbar.sticky-top',
      '.navbar.fixed-top',
      '.navbar.sticky-top',
      'header.fixed-top',
      'header.sticky-top',
      'nav'
    ];

    let el = null;
    for (const sel of candidates) {
      const found = document.querySelector(sel);
      if (!found) continue;

      const cs = window.getComputedStyle(found);
      const pos = cs.position;
      if (pos === 'fixed' || pos === 'sticky') {
        el = found;
        break;
      }
    }

    let h = 65;
    if (el) {
      const rect = el.getBoundingClientRect();
      h = Math.round(rect.bottom);
    }

    if (h < 40 || h > 120) h = 65;
    document.documentElement.style.setProperty('--navbar-h', `${h}px`);
  }

  // calcular al cargar
  setNavbarHeightVar();
  // recalcular por si cambia (responsive)
  window.addEventListener("resize", setNavbarHeightVar);

  const AppConfirm = (() => {
    let backdrop, titleEl, textEl, btnOk, btnCancel;
    let resolveFn = null;
    let escHandler = null;

    function ensure() {
      if (backdrop) return;
      backdrop = document.getElementById("app-confirm-backdrop");
      titleEl = document.getElementById("app-confirm-title");
      textEl = document.getElementById("app-confirm-text");
      btnOk = document.getElementById("app-confirm-ok");
      btnCancel = document.getElementById("app-confirm-cancel");

      // No cerrar al clicar fuera
      backdrop.addEventListener("click", (e) => {
        if (e.target === backdrop) {
          e.preventDefault();
          e.stopPropagation();
        }
      });

      btnCancel.addEventListener("click", () => close(false));
      btnOk.addEventListener("click", () => close(true));
    }

    function open({ title, message, okText = "Aceptar", cancelText = "Cancelar", okClass = "btn-danger" }) {
      ensure();

      titleEl.textContent = title || "Confirmación";
      textEl.textContent = message || "";
      btnOk.textContent = okText;
      btnCancel.textContent = cancelText;

      btnOk.className = `btn ${okClass}`;

      backdrop.classList.remove("d-none");
      backdrop.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";

      // No cerrar con ESC
      escHandler = (e) => {
        if (e.key === "Escape") {
          e.preventDefault();
          e.stopPropagation();
        }
      };
      document.addEventListener("keydown", escHandler, true);

      return new Promise((resolve) => {
        resolveFn = resolve;
        setTimeout(() => btnOk.focus(), 0);
      });
    }

    function close(result) {
      if (!backdrop) return;

      backdrop.classList.add("d-none");
      backdrop.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";

      if (escHandler) {
        document.removeEventListener("keydown", escHandler, true);
        escHandler = null;
      }

      const r = resolveFn;
      resolveFn = null;
      r?.(!!result);
    }

    return { open };
  })();


  // -----------------------------------------
  // DOM Content Loaded
  // -----------------------------------------
  document.addEventListener("DOMContentLoaded", function () {
    function guardarEstadoMapa() {
  const estado = {
    zoom: map.getZoom(),
    center: map.getCenter(),
    sidePanelAbierto: splitOpen,
    recintoActual: currentSideRecintoId,
    timestamp: Date.now()
  };
  
  try {
    sessionStorage.setItem('mapaEstado', JSON.stringify(estado));
  } catch (e) {
    console.warn('No se pudo guardar el estado del mapa:', e);
  }
}

// Función para restaurar el estado del mapa y panel
async function restaurarEstadoMapa() {
  try {
    const estadoStr = sessionStorage.getItem('mapaEstado');
    if (!estadoStr) return false;
    
    const estado = JSON.parse(estadoStr);
    
    // Verificar que no sea muy antiguo (opcional, 30 minutos)
    const tiempoMaximo = 30 * 60 * 1000; // 30 minutos
    if (Date.now() - estado.timestamp > tiempoMaximo) {
      sessionStorage.removeItem('mapaEstado');
      return false;
    }
    
    // Restaurar vista del mapa
    if (estado.center && estado.zoom) {
      map.setView([estado.center.lat, estado.center.lng], estado.zoom);
    }
    
    // Restaurar side panel si estaba abierto
    if (estado.sidePanelAbierto && estado.recintoActual) {
      // Esperar un poco a que el mapa se estabilice
      await new Promise(resolve => setTimeout(resolve, 500));
      
      try {
        // Intentar cargar los datos del recinto
        const response = await fetch(`/api/mis-recinto/${estado.recintoActual}`);
        if (!response.ok) throw new Error('Recinto no encontrado');
        
        const data = await response.json();
        
        // Abrir el panel con los datos
        abrirRecintoEnPanel(data);
        
        console.log('Estado del mapa restaurado correctamente');
        return true;
      } catch (err) {
        console.warn('No se pudo restaurar el recinto:', err);
        sessionStorage.removeItem('mapaEstado');
        return false;
      }
    }
    
    return true;
  } catch (e) {
    console.warn('Error al restaurar estado del mapa:', e);
    sessionStorage.removeItem('mapaEstado');
    return false;
  }
}


  const CURRENT_USER_ID = {{ current_user.id_usuario if current_user.is_authenticated else 'null' }};
  NotificationSystem.init();

  // -----------------------------------------
  // 1) ROI desde Flask
  // -----------------------------------------
  const roiBbox = [
    {{ roi_bbox[0] }},
    {{ roi_bbox[1] }},
    {{ roi_bbox[2] }},
    {{ roi_bbox[3] }}
  ];

  const ROI_BOUNDS = L.latLngBounds(
    [roiBbox[1], roiBbox[0]],
    [roiBbox[3], roiBbox[2]]
  );

  const S2_BOUNDS = L.latLngBounds({{ s2_bounds | tojson | safe }});

  const NDVI_BOUNDS = L.latLngBounds({{ ndvi_bounds | tojson | safe }});

  const ZOOM_RECINTOS = 15;

  // -----------------------------------------
  // 2) Crear mapa
  // -----------------------------------------
  const map = L.map("map", {
    maxBounds: ROI_BOUNDS,
    maxBoundsViscosity: 1.0,
    zoomControl: true,
  });

  map.fitBounds(ROI_BOUNDS);


  

  // --- Panes (orden de dibujo) ---
  map.createPane('sigpacPane');
  map.getPane('sigpacPane').style.zIndex = 400;

  map.createPane('misPane');
  map.getPane('misPane').style.zIndex = 450;

  map.createPane('highlightPane');
  map.getPane('highlightPane').style.zIndex = 650;

  // --- Modo split (panel derecho vacío) ---
  let splitOpen = false;

  function setSplitMode(on) {
  splitOpen = !!on;

  if (splitOpen) {
    setNavbarHeightVar();
  }

  document.body.classList.toggle("split-mode", splitOpen);

  const sp = document.getElementById("side-panel");
  if (sp) sp.setAttribute("aria-hidden", splitOpen ? "false" : "true");

  setTimeout(() => {
    try { map.invalidateSize(); } catch (e) {}
  }, 280);
  
  // NUEVO: Guardar estado cuando se abre/cierra el panel
  if (splitOpen && currentSideRecintoId) {
    guardarEstadoMapa();
  } else {
    sessionStorage.removeItem('mapaEstado');
  }
}

  window.addEventListener('resize', () => {
    if (splitOpen) {
      setNavbarHeightVar();
      try { map.invalidateSize(); } catch (e) {}
    }
  });

  // Cerrar split
  const sideCloseBtn = document.getElementById("side-close");
  if (sideCloseBtn) {
    sideCloseBtn.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();

      // 1) cerrar cualquier popup abierto
      try { map.closePopup(); } catch (_) {}

      // 2) quitar resaltado rojo
      clearHighlight();

      // 3) cerrar panel
      closeHistoricoPanel();
      closeOperacionesPanel();
      // closeGaleriaPanel?.();   //REVISAR
      setSplitMode(false);

      // reset id actual
      window.currentSideRecintoId = null;
    });
  }

  // ============================
  // EDITAR NOMBRE (lápiz)
  // Enter o blur => guardar
  // Escape => cancelar
  // ============================

  let currentSideRecintoId = null;
  let originalTitleText = "";

  const btnEdit = document.getElementById("btn-edit-name");
  const titleEl = document.getElementById("side-title");


  if (btnEdit && titleEl) {

    btnEdit.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();

      if (!currentSideRecintoId) {
        console.warn("No hay currentSideRecintoId");
        return;
      }

      originalTitleText = titleEl.textContent.trim();
      titleEl.setAttribute("contenteditable", "true");
      titleEl.focus();

      // Seleccionar todo el texto
      const range = document.createRange();
      range.selectNodeContents(titleEl);
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(range);
    });

    titleEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        titleEl.blur();
      }

      if (e.key === "Escape") {
        e.preventDefault();
        titleEl.textContent = originalTitleText;
        titleEl.removeAttribute("contenteditable");
      }
    });

    titleEl.addEventListener("blur", async () => {
      titleEl.removeAttribute("contenteditable");

      const nuevoNombre = titleEl.textContent.trim();

      if (!nuevoNombre || nuevoNombre === originalTitleText) {
        titleEl.textContent = originalTitleText;
        return;
      }

      try {
        const r = await fetch(
          `/api/mis-recinto/${currentSideRecintoId}/nombre`,
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ nombre: nuevoNombre })
          }
        );

        if (!r.ok) throw new Error();

      } catch (err) {
        console.error(err);
        titleEl.textContent = originalTitleText;
        mostrarErrorInline("No se pudo guardar el nombre");
      }
    });

  }

  function safeText(v, fallback = "-") {
    if (v === null || v === undefined) return fallback;
    const s = String(v).trim();
    return s === "" ? fallback : s;
  }

  function parseBool(v, def = true) {
    if (v === undefined || v === null) return def;
    if (typeof v === "boolean") return v;
    if (typeof v === "number") return v !== 0;
    const s = String(v).toLowerCase().trim();
    if (["t","true","1","yes","y","si","sí"].includes(s)) return true;
    if (["f","false","0","no","n"].includes(s)) return false;
    return def;
  }

  function formatAreaHa(p) {
    const a = p.superficie_ha ?? p.superficie ?? p.area_ha ?? p.area ?? null;
    if (a === null || a === undefined || a === "") return "-";
    const n = Number(a);
    if (!Number.isFinite(n)) return safeText(a);
    return `${n.toFixed(2).replace(".", ",")} ha`;
  }

  function formatDateValue(v) {
    if (!v) return "-";
    const d = new Date(v);
    if (Number.isNaN(d.getTime())) return safeText(v);

    const dd = String(d.getDate()).padStart(2, "0");
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const yyyy = String(d.getFullYear());
    const hh = String(d.getHours()).padStart(2, "0");
    const min = String(d.getMinutes()).padStart(2, "0");
    return `${dd}/${mm}/${yyyy} ${hh}:${min}`;
  }

  function renderSidePanelFromProps(p) {
    window.currentSideRecintoId = p.id || p.id_recinto;
    document.getElementById("side-title").textContent = safeText(p.nombre, "Recinto");
    document.getElementById("side-area").textContent = (p.superficie_ha == null)
      ? "-"
      : `${Number(p.superficie_ha).toFixed(2).replace(".", ",")} ha`;
    document.getElementById("side-owner").textContent = safeText(p.propietario, "N/A");
    document.getElementById("side-active").checked = (p.activa == null) ? true : !!p.activa;

    // Mostrar coordenadas del centroide
    const coordsText = document.getElementById("side-coords");
    if (p.centroid_lat != null && p.centroid_lng != null) {
      coordsText.textContent = `${p.centroid_lat.toFixed(6)}, ${p.centroid_lng.toFixed(6)}`;
    } else {
      coordsText.textContent = "-";
    }


    window.galeria.setRecintoId(window.currentSideRecintoId);
    window.ndviManager.setRecintoId(window.currentSideRecintoId);
    

    renderCultivosForRecinto(currentSideRecintoId);
    renderOperacionesForRecinto(currentSideRecintoId);
  }



const btnDelete = document.getElementById("btn-delete-recinto");
if (btnDelete) {
  btnDelete.addEventListener("click", async (e) => {
    e.preventDefault();
    e.stopPropagation();
    
    if (!currentSideRecintoId) {
      console.warn("No hay recinto seleccionado");
      return;
    }

    // Abrir modal de confirmación
    const ok = await AppConfirm.open({
      title: "Solicitar eliminación de recinto",
      message: "¿Estás seguro de que deseas solicitar la eliminación de este recinto? Un administrador deberá aprobar la solicitud antes de que el recinto sea eliminado.",
      okText: "Solicitar eliminación",
      cancelText: "Cancelar",
      okClass: "btn-danger"
    });

    // Si el usuario cancela, salir
    if (!ok) return;

    // Si confirma, proceder con la eliminación
    try {
      const response = await fetch(`/api/solicitud-eliminar-recinto/${currentSideRecintoId}/borrar`, {
        method: "POST",
        headers: { "Content-Type": "application/json" }
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || "Error al crear la solicitud");
      }

      NotificationSystem.show({
        type: "success",
        title: "Solicitud enviada",
        message: data.mensaje || "La solicitud se creó correctamente"
      });

    } catch (err) {
      console.error("Error al solicitar eliminación:", err);
      NotificationSystem.show({
        type: "error",
        title: "Error",
        message: err.message || "Error al solicitar eliminación"
      });
    }
  });
}

// Función auxiliar para mostrar mensajes de éxito

  // ==========================================================
  // Cultivos (UI del panel derecho)
  // Requiere endpoints (a implementar en backend):
  //   GET    /api/catalogos/usos-sigpac
  //   GET    /api/catalogos/productos-fega
  //   GET    /api/mis-recinto/<id>/cultivo            -> 404 si no hay
  //   POST   /api/cultivos                           -> crea
  //   PATCH  /api/cultivos/<id_cultivo>              -> actualiza
  //   DELETE /api/cultivos/<id_cultivo>              -> elimina
  // ==========================================================

  let _usosSigpac = null;     // [{codigo, descripcion, grupo}]
  let _productosFega = null;  // [{codigo, descripcion}]

  // Para "N/A - ALTRAMUZ", etc...
  const _cultivosCustom = [
    { codigo: null, descripcion: "SIN CULTIVO" },
    { codigo: null, descripcion: "ALTRAMUZ" },
    { codigo: null, descripcion: "ALTRAMUZ DULCE" }
  ];

  async function fetchJson(url, opts) {
    const resp = await fetch(url, opts);
    const txt = await resp.text().catch(() => "");
    let data = null;
    try { data = txt ? JSON.parse(txt) : null; } catch (_) {}

    if (!resp.ok) {
      const err = new Error(`HTTP ${resp.status} en ${url}`);
      err.status = resp.status;
      err.body = txt;
      err.data = data;
      throw err;
    }

    // Si no hay JSON, devuelve null
    return data;
  }

  // Convierte fechas de inputs a ISO (YYYY-MM-DD).
  // Acepta: YYYY-MM-DD (input type="date"), DD/MM/YYYY y DD-MM-YYYY.
  function parseDateToISO(v) {
    if (!v) return null;
    const s = String(v).trim();
    if (!s) return null;

    // Ya viene en ISO
    if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;

    // DD/MM/YYYY
    let m = s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
    if (m) return `${m[3]}-${m[2]}-${m[1]}`;

    // DD-MM-YYYY
    m = s.match(/^(\d{2})-(\d{2})-(\d{4})$/);
    if (m) return `${m[3]}-${m[2]}-${m[1]}`;

    // Como último recurso: intenta Date()
    const d = new Date(s);
    if (!isNaN(d.getTime())) return d.toISOString().slice(0, 10);

    return null;
  }

  async function loadUsosSigpac() {
    if (_usosSigpac) return _usosSigpac;
    _usosSigpac = await fetchJson("/api/catalogos/usos-sigpac");
    return _usosSigpac;
  }

  async function loadProductosFega() {
    if (_productosFega) return _productosFega;
    _productosFega = await fetchJson("/api/catalogos/productos-fega");
    return _productosFega;
  }

  const _productosFegaByUso = new Map();

  async function loadProductosFegaPorUso(usoSigpac) {
    const key = String(usoSigpac || "").trim();
    if (!key) return [];
    if (_productosFegaByUso.has(key)) return _productosFegaByUso.get(key);
    const list = await fetchJson(`/api/catalogos/productos-fega/${encodeURIComponent(key)}`);
    _productosFegaByUso.set(key, list || []);
    return list || [];
  }

  function byCodigo(list) {
    const m = new Map();
    (list || []).forEach(it => m.set(String(it.codigo), it));
    return m;
  }

  function norm(s) {
    return String(s ?? "").normalize("NFD").replace(/\p{Diacritic}/gu, "").toLowerCase();
  }

  function formatCodigoDesc(codigo, descripcion) {
    const code = (codigo === null || codigo === undefined || codigo === "") ? "N/A" : String(codigo);
    const desc = safeText(descripcion, "N/A");
    return `${code}-${desc}`;
  }

  function guessGrupoUso(usoCode, usosMap) {
    const u = usosMap.get(String(usoCode));
    return u?.grupo || null;
  }

  async function getCultivoRecinto(recintoId) {
    const c = await fetchJson(`/api/mis-recinto/${recintoId}/cultivo`);
    return normalizeCultivoFromApi(c);
  }

  async function renderCultivosForRecinto(recintoId) {
    const container = document.getElementById("cultivos-container");
    if (!container) return;

    container.innerHTML = `<div class="text-muted">Cargando cultivos...</div>`;

    let usos = [];
    let productos = [];
    try {
      [usos, productos] = await Promise.all([loadUsosSigpac(), loadProductosFega()]);
    } catch (e) {
      console.warn(e);
      container.innerHTML = `
        <div class="text-danger">No se pudieron cargar los catálogos (SIGPAC/FEGA).</div>
        <div class="text-muted" style="font-size:12px">Revisa /api/catalogos/usos-sigpac y /api/catalogos/productos-fega</div>
      `;
      return;
    }

    try {
      const cultivo = await getCultivoRecinto(recintoId);
      renderCultivoView(container, recintoId, cultivo, usos, productos);
    } catch (e) {
      if (e && e.status === 404) {
        renderCultivoEmpty(container, recintoId, usos, productos);
        return;
      }
      console.warn(e);
      container.innerHTML = `<div class="text-danger">Error cargando cultivo del recinto.</div>`;
    }
  }

  function renderCultivoEmpty(container, recintoId, usos, productos) {
    container.innerHTML = `
      <button id="btn-add-cultivo" type="button" class="btn btn-success w-100">
        Añadir cultivo
      </button>
      <div class="text-muted" style="font-size:12px; margin-top:8px">
        Añade un cultivo a este recinto (FEGA o personalizado).
      </div>
    `;
    container.querySelector("#btn-add-cultivo").addEventListener("click", () => {
      renderCultivoForm(container, { recintoId, cultivo: null, usos, productos });
    });
  }

  function estadoLabel(v){
    const s = String(v || "").toLowerCase().trim();
    const map = {
      planificado: "Planificado",
      en_curso: "En curso",
      implantado: "Plantado",
      cosechado: "Cosechado",
      abandonado: "Abandonado"
    };
    return map[s] || safeText(v, "N/A");
  }

  let needsRefreshActualCultivo = false;

  function openHistoricoPanel(){
    const sp = document.getElementById("side-panel");
    const panel = document.getElementById("cultivos-historico-panel");
    if (!sp || !panel) return;
    sp.classList.add("cultivos-historico-open");
    panel.classList.remove("d-none");
    panel.setAttribute("aria-hidden", "false");
  }

  function closeHistoricoPanel(){
    const sp = document.getElementById("side-panel");
    const panel = document.getElementById("cultivos-historico-panel");
    if (!sp || !panel) return;
    sp.classList.remove("cultivos-historico-open");
    panel.classList.add("d-none");
    panel.setAttribute("aria-hidden", "true");

    // si se tocó el cultivo actual desde el histórico, repinta el actual al volver
    if (needsRefreshActualCultivo && currentSideRecintoId) {
      needsRefreshActualCultivo = false;
      renderCultivosForRecinto(currentSideRecintoId);
    }
  }

  window.openGaleriaPanel = function openGaleriaPanel(){
    const sp = document.getElementById("side-panel");
    const overlay = document.getElementById("galeria-panel");
    const body = document.getElementById("galeria-panel-body");
    const gal = document.getElementById("galeria-imagenes");
    const historico = document.getElementById("cultivos-historico-panel");
    if (!sp || !overlay || !body || !gal || !historico) return;

    // Cierra histórico si estuviera abierto
    closeHistoricoPanel?.();

    // Mover galería dentro del overlay (evita duplicados / pisadas)
    body.appendChild(gal);

    // Activar estado
    sp.classList.add("galeria-open");
    overlay.classList.remove("d-none");
    overlay.setAttribute("aria-hidden", "false");
  };

  window.closeGaleriaPanel = function closeGaleriaPanel(){
    const sp = document.getElementById("side-panel");
    const overlay = document.getElementById("galeria-panel");
    const gal = document.getElementById("galeria-imagenes");
    const historico = document.getElementById("cultivos-historico-panel");
    if (!sp || !overlay || !gal || !historico) return;

    // Devolver galería a su sitio (antes del histórico)
    historico.parentNode.insertBefore(gal, historico);

    // Desactivar estado
    sp.classList.remove("galeria-open");
    overlay.classList.add("d-none");
    overlay.setAttribute("aria-hidden", "true");
  };

  // Botones del overlay (una sola vez)
  document.getElementById("btn-volver-galeria")?.addEventListener("click", (e) => {
    e.preventDefault(); e.stopPropagation();
    window.galeria?.contraerGaleria(); // ya cierra overlay desde dentro
  });

  document.getElementById("btn-cerrar-galeria")?.addEventListener("click", (e) => {
    e.preventDefault(); e.stopPropagation();
    document.getElementById("side-close")?.click();
  });

  // Botones del overlay
  document.getElementById("btn-volver-galeria")?.addEventListener("click", (e) => {
    e.preventDefault(); e.stopPropagation();
    closeGaleriaPanel();
  });

  document.getElementById("btn-cerrar-galeria")?.addEventListener("click", (e) => {
    e.preventDefault(); e.stopPropagation();
    document.getElementById("side-close")?.click(); // cierra el split completo
  });


  document.getElementById("btn-cerrar-historico")?.addEventListener("click", (e) => {
    e.preventDefault();
    e.stopPropagation();
    sideCloseBtn?.click();
  });

  document.getElementById("btn-volver-historico")?.addEventListener("click", (e) => {
    e.preventDefault();
    e.stopPropagation();
    closeHistoricoPanel();
  });

  function hasAvanzado(a){
    if (!a || typeof a !== "object") return false;

    // soporta string JSON
    if (typeof a === "string") { try { a = JSON.parse(a); } catch(_) { return false; } }
    if (!a || typeof a !== "object") return false;

    const flat = [];

    for (const v of Object.values(a)) {
      if (!v) continue;
      if (typeof v === "object") {
        // material_vegetal o {codigo,label}
        if (v.codigo || v.label) flat.push(v);
        else {
          for (const vv of Object.values(v)) {
            if (vv && (vv.codigo || vv.label)) flat.push(vv);
          }
        }
      } else if (String(v).trim() !== "") {
        flat.push(v);
      }
    }
    return flat.length > 0;
  }

  function openAvanzadoModal(av){
    const body = document.getElementById("modalAvanzadoCultivoBody");
    if (!body) return;

    if (typeof av === "string") { try { av = JSON.parse(av); } catch(_) { av = null; } }

    if (!hasAvanzado(av)) {
      body.innerHTML = `<div class="text-muted">No hay datos avanzados.</div>`;
    } else {
      const rows = [];

      function addRow(label, obj){
        if (!obj || typeof obj !== "object") return;
        const v = obj.label || obj.codigo;
        if (!v) return;
        rows.push(`<tr><th style="width:45%">${escapeHtml(label)}</th><td>${escapeHtml(v)}</td></tr>`);
      }

      addRow("Aprovechamiento", av.aprovechamiento);
      addRow("Tipo cobertura del suelo", av.tipo_cobertura_suelo);
      addRow("Destino del cultivo", av.destino_cultivo);

      // material vegetal
      if (av.material_vegetal) {
        addRow("Material vegetal - tipo", av.material_vegetal.tipo);
        addRow("Material vegetal - detalle", av.material_vegetal.detalle);
      }

      addRow("Tipo de labor", av.tipo_labor);
      addRow("Procedencia material vegetal", av.procedencia_material_vegetal);
      addRow("SENP", av.senp);

      body.innerHTML = `
        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <tbody>${rows.join("")}</tbody>
          </table>
        </div>
      `;
    }

    const el = document.getElementById("modalAvanzadoCultivo");
    const modal = bootstrap.Modal.getOrCreateInstance(el);
    modal.show();
  }

  document.getElementById("btn-historico-cultivos")?.addEventListener("click", async (e) => {
    e.preventDefault();
    e.stopPropagation();

    if (!currentSideRecintoId) return;

    openHistoricoPanel();

    const listEl = document.getElementById("cultivos-historico-list");

    // Repinta histórico entero
    const reloadHistorico = async () => {
      if (!currentSideRecintoId) return;

      listEl.innerHTML = `<div class="text-muted">Cargando histórico...</div>`;

      let currentCultivoId = null;
      try {
        const cur = await getCultivoRecinto(currentSideRecintoId);
        currentCultivoId = cur?.id_cultivo ?? null;
      } catch (e) {
        if (!(e && e.status === 404)) throw e;
      }

      try {
        const [usos, productos, hist] = await Promise.all([
          loadUsosSigpac(),
          loadProductosFega(),
          fetchJson(`/api/mis-recinto/${currentSideRecintoId}/cultivos-historico`)
        ]);

        const usosMap = byCodigo(usos);
        const prodMap = byCodigo(productos);

        const arr = (Array.isArray(hist) ? hist : []).map(normalizeCultivoFromApi);
        const count = arr.length;

        listEl.innerHTML = `
          <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
            <div class="d-flex align-items-center gap-2">
              <i class="bi bi-journal-check text-success"></i>
              <span>Registro completo</span>
              <span class="badge bg-success">${count}</span>
            </div>

            <div class="d-flex gap-2 ms-auto">
              <button id="btn-download-cultivos-csv"
                class="btn btn-outline-success btn-sm"
                ${Number(count) > 0 ? "" : "disabled"}
                title="${count ? "" : "No hay datos para exportar"}" type="button">
                <i class="bi bi-download me-1"></i> CSV
              </button>
              <button id="btn-add-historico" class="btn btn-success btn-sm">
                + Añadir al Histórico
              </button>
            </div>
          </div>

          <div class="side-divider"></div>
          <div id="historico-cards"></div>
        `;

        // CSV disabled: gris + tooltip (el title no funciona en button disabled)
        const csvBtn = listEl.querySelector("#btn-download-cultivos-csv");
        if (csvBtn && csvBtn.disabled){
          csvBtn.classList.remove("btn-outline-success");
          csvBtn.classList.add("btn-outline-secondary");

          const wrap = document.createElement("span");
          wrap.className = "d-inline-block";
          wrap.title = "Ahora mismo no se puede descargar CSV";

          csvBtn.parentNode.insertBefore(wrap, csvBtn);
          wrap.appendChild(csvBtn);
        }

        const cardsEl = listEl.querySelector("#historico-cards");

        if (!arr.length) {
          cardsEl.innerHTML = `<div class="text-muted">No hay histórico todavía.</div>`;
        } else {
            const COLS = 11;

            cardsEl.innerHTML = `
              <div class="table-responsive historico-table-wrap">
                <table class="table table-sm table-hover align-middle historico-table mb-0">
                  <thead>
                    <tr>
                      <th style="min-width:140px;">Fechas</th>
                      <th style="min-width:180px;">Uso SIGPAC</th>
                      <th style="min-width:180px;">Tipo cultivo</th>
                      <th style="min-width:140px;">Variedad</th>
                      <th style="min-width:120px;">Explotación</th>
                      <th style="min-width:170px;">Sistema cultivo</th>
                      <th style="min-width:150px;">Avanzado</th>
                      <th style="min-width:160px;">Campaña / Registro</th>
                      <th style="min-width:120px;">Estado</th>
                      <th style="min-width:220px;">Observaciones</th>
                      <th style="min-width:170px;" class="text-end">Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${arr.map((c) => {
                      const isCamp = String(c.tipo_registro || "").toUpperCase().includes("CAMP");
                      const inicio = isCamp ? c.fecha_siembra : c.fecha_implantacion;
                      const fin = c.fecha_cosecha_real || c.fecha_cosecha_estimada;

                      const isCurrent = currentCultivoId && String(c.id_cultivo) === String(currentCultivoId);

                      const u = usosMap.get(String(c.uso_sigpac));
                      const usoLbl = formatCodigoDesc(c.uso_sigpac, u?.descripcion || c.uso_sigpac);

                      let tipoLbl = "N/A";
                      const origen = String(c.origen_cultivo || "").toUpperCase();
                      if (origen === "F" && c.cod_producto != null) {
                        const p = prodMap.get(String(c.cod_producto));
                        tipoLbl = formatCodigoDesc(c.cod_producto, p?.descripcion || c.tipo_cultivo);
                      } else {
                        tipoLbl = formatCodigoDesc(null, c.cultivo_custom || c.tipo_cultivo);
                      }

                      const campOrReg = isCamp
                        ? safeText(c.campana, "N/A")
                        : safeText(tipoRegistroLabel(c.tipo_registro));

                      const obsText = (c.observaciones && String(c.observaciones).trim()) ? String(c.observaciones) : "";
                      const hasObs = !!obsText.trim();

                      const sisCult = c.sistema_cultivo;
                      const sisCultLbl =
                        (sisCult && typeof sisCult === "object")
                          ? (sisCult.label || sisCult.codigo || "—")
                          : (sisCult || "—");

                      const advYes = hasAvanzado(c.avanzado);

                      // Preview corto (sin saltos) + botón Ver/Ocultar
                      const obsOneLine = hasObs ? obsText.replace(/\s+/g, " ").trim() : "";
                      const obsPreview = hasObs
                        ? escapeHtml(obsOneLine.slice(0, 70) + (obsOneLine.length > 70 ? "…" : ""))
                        : "";

                      const showToggle = hasObs || isCurrent; // aunque no haya obs, el actual tiene aviso útil
                      const targetId = `hist-obs-${c.id_cultivo}`;

                      const obsCellHtml = hasObs
                        ? `<span class="hist-obs-preview">${obsPreview}</span>`
                        : `<span class="text-muted">(Sin observaciones)</span>`;

                      const toggleBtn = showToggle
                        ? `<button type="button"
                                  class="btn btn-outline-success btn-sm btn-toggle-obs"
                                  data-target="${targetId}"
                                  aria-expanded="false">
                              Ver
                          </button>`
                        : ``;

                      const obsFullHtml = hasObs
                        ? `<div class="border rounded-3 p-2 hist-obs-box" style="white-space:pre-wrap;">${escapeHtml(obsText)}</div>`
                        : `<div class="text-muted">(Sin observaciones)</div>`;

                      return `
                        <tr>
                          <td class="hist-fechas">
                            ${safeText(formatDateOnly(inicio))} → ${safeText(formatDateOnly(fin))}
                            ${isCurrent ? `<span class="badge bg-success ms-2">Actual</span>` : ``}
                          </td>

                          <td>${safeText(usoLbl)}</td>
                          <td>${safeText(tipoLbl)}</td>
                          <td>${safeText(c.variedad, "N/A")}</td>
                          <td>${safeText(sistemaLabel(c.sistema_explotacion))}</td>
                          <td>${escapeHtml(sisCultLbl)}</td>
                          <td>
                            ${advYes
                              ? `<span class="badge bg-success me-2">Sí</span>
                                <button type="button"
                                        class="btn btn-outline-success btn-sm btn-ver-avanzado"
                                        data-id="${c.id_cultivo}">
                                  Ver
                                </button>`
                              : `<span class="badge bg-secondary">No</span>`
                            }
                          </td>
                          <td>${campOrReg}</td>
                          <td>${estadoLabel(c.estado)}</td>

                          <td>
                            <div class="d-flex align-items-center gap-2 flex-wrap">
                              ${obsCellHtml}
                              ${toggleBtn}
                            </div>
                          </td>

                          <td class="text-end">
                            <div class="d-flex gap-2 justify-content-end flex-wrap hist-actions">
                              <button class="btn btn-success btn-sm btn-edit-hist" data-id="${c.id_cultivo}">
                                <i class="bi bi-pencil-fill me-1"></i> Editar
                              </button>
                              <button class="btn btn-danger btn-sm btn-del-hist" data-id="${c.id_cultivo}" ${isCurrent ? "disabled" : ""}>
                                <i class="bi bi-trash-fill me-1"></i> Eliminar
                              </button>
                            </div>
                          </td>
                        </tr>

                        <tr id="${targetId}" class="hist-obs-row d-none">
                          <td colspan="${COLS}">
                            <div class="hist-obs-detail">
                              <div class="fw-bold mb-2">Observaciones</div>
                              ${obsFullHtml}

                              ${isCurrent ? `
                                <div class="text-muted mt-2" style="font-size:12px">
                                  Este es el cultivo actual. Para eliminarlo, hazlo desde la página principal del cultivo.
                                </div>
                              ` : ``}
                            </div>
                          </td>
                        </tr>
                      `;
                    }).join("")}
                  </tbody>
                </table>
              </div>
            `;

            // Toggle Observaciones (Ver/Ocultar)
            cardsEl.querySelectorAll(".btn-toggle-obs").forEach(btn => {
              btn.addEventListener("click", (ev) => {
                const b = ev.currentTarget;
                const targetId = b.dataset.target;
                const row = cardsEl.querySelector(`#${CSS.escape(targetId)}`);
                if (!row) return;

                const isHidden = row.classList.contains("d-none");
                row.classList.toggle("d-none", !isHidden);

                b.textContent = isHidden ? "Ocultar" : "Ver";
                b.setAttribute("aria-expanded", isHidden ? "true" : "false");
              });
            });

            // Eliminar registro (igual que antes)
            cardsEl.querySelectorAll(".btn-del-hist").forEach(btn => {
              btn.addEventListener("click", async (ev) => {
                const id = ev.currentTarget.dataset.id;

                const ok = await AppConfirm.open({
                  title: "Eliminar cultivo",
                  message: "¿Seguro que deseas eliminar el cultivo? Este proceso no es reversible.",
                  okText: "Eliminar",
                  cancelText: "Cancelar",
                  okClass: "btn-danger"
                });
                if (!ok) return;

                await fetchJson(`/api/cultivos/${id}`, { method: "DELETE" });
                await reloadHistorico();
              });
            });

            // Editar registro (igual que antes)
            cardsEl.querySelectorAll(".btn-edit-hist").forEach(btn => {
              btn.addEventListener("click", (ev) => {
                const id = ev.currentTarget.dataset.id;
                const item = arr.find(x => String(x.id_cultivo) === String(id));
                if (!item) return;

                renderCultivoForm(listEl, {
                  recintoId: currentSideRecintoId,
                  cultivo: item,
                  usos,
                  productos,
                  mode: "historico_edit",
                  cultivoId: Number(id),
                  currentCultivoId,
                  onDone: reloadHistorico,
                  onCancel: reloadHistorico
                });
              });
            });

            // Ver modal Avanzado
            cardsEl.querySelectorAll(".btn-ver-avanzado").forEach(btn => {
              btn.addEventListener("click", () => {
                const id = btn.dataset.id;
                const item = arr.find(x => String(x.id_cultivo) === String(id));
                openAvanzadoModal(item?.avanzado || null);
              });
            });
          }

        // Añadir al histórico
        listEl.querySelector("#btn-add-historico")?.addEventListener("click", () => {
          renderCultivoForm(listEl, {
            recintoId: currentSideRecintoId,
            cultivo: null,
            usos,
            productos,
            mode: "historico_add",
            onDone: reloadHistorico,
            onCancel: reloadHistorico
          });
        });

        listEl.querySelector("#btn-download-cultivos-csv")?.addEventListener("click", () => {
          if (!Array.isArray(arr) || arr.length === 0) return;
          const headers = [
            "id_cultivo",
            "fecha_inicio",
            "fecha_fin",
            "uso_sigpac_codigo",
            "uso_sigpac_desc",
            "tipo_cultivo_codigo",
            "tipo_cultivo_desc",
            "variedad",
            "explotacion",
            "campana_o_registro",
            "estado",
            "sistema_cultivo",
            "avanzado_si_no",
            "avanzado_json",
            "observaciones"
          ];

          const rows = arr.map((c) => {
            const isCamp = String(c.tipo_registro || "").toUpperCase().includes("CAMP");
            const inicio = isCamp ? c.fecha_siembra : c.fecha_implantacion;
            const fin = c.fecha_cosecha_real || c.fecha_cosecha_estimada;

            const u = usosMap.get(String(c.uso_sigpac));
            const usoDesc = u?.descripcion || "";

            let tipoCod = "";
            let tipoDesc = "";

              const p = prodMap.get(String(c.cod_producto));
              tipoCod = String(c.cod_producto);
              tipoDesc = p?.descripcion || (c.tipo_cultivo || "");

            const campOrReg = isCamp ? (c.campana ?? "") : tipoRegistroLabel(c.tipo_registro);

            return [
              c.id_cultivo ?? "",
              formatDateOnly(inicio),
              formatDateOnly(fin),
              c.uso_sigpac ?? "",
              usoDesc,
              tipoCod,
              tipoDesc,
              c.variedad ?? "",
              sistemaLabel(c.sistema_explotacion),
              campOrReg ?? "",
              estadoLabel(c.estado),
              sisCultLbl,
              (hasAvanzado(c.avanzado) ? "Sí" : "No"),
              (c.avanzado ? JSON.stringify(c.avanzado) : ""),
              c.observaciones ?? ""
            ];
          });

          const csv = rowsToCsv(headers, rows, ";");
          const file = `cultivos_historico_recinto_${currentSideRecintoId || "NA"}.csv`;
          downloadCsv(file, csv);
        });

      } catch (err) {
        console.warn(err);
        listEl.innerHTML = `<div class="text-danger">No se pudo cargar el histórico.</div>`;
      }
    };

    // Primer pintado al abrir
    await reloadHistorico();
  });

  function formatDateOnly(v) {
    if (!v) return "N/A";
    const d = new Date(v);
    if (Number.isNaN(d.getTime())) return safeText(v);
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const yy = d.getFullYear();
    return `${dd}/${mm}/${yy}`;
  }

  function escapeHtml(s) {
    const div = document.createElement("div");
    div.textContent = s ?? "";
    return div.innerHTML;
  }

  function parseMaybeJson(v) {
    if (v === null || v === undefined) return null;
    if (typeof v === "object") return v;
    if (typeof v !== "string") return null;

    const s = v.trim();
    if (!s) return null;

    try { return JSON.parse(s); } catch (_) { return null; }
  }

  function normalizeCatalogObj(v){
    if (v == null || v === "") return null;

    if (typeof v === "string"){
      const s = v.trim();
      if (!s) return null;

      if ((s.startsWith("{") && s.endsWith("}")) || (s.startsWith("[") && s.endsWith("]"))){
        try{
          const parsed = JSON.parse(s);
          return normalizeCatalogObj(parsed);
        }catch(e){
          // sigue como string normal
        }
      }

      return { codigo: s, label: s, fuente: "SIEX" };
    }

    if (typeof v === "object"){
      if (Array.isArray(v)){
        if (!v.length) return null;
        return normalizeCatalogObj(v[0]);
      }
      const codigo = String(v.codigo ?? v.codigo_siex ?? v.code ?? v.id ?? "").trim();
      const label = String(v.label ?? v.nombre ?? v.descripcion ?? v.valor ?? codigo).trim();
      const fuente = String(v.fuente || "SIEX");

      if (!codigo && !label) return null;

      return { ...v, codigo: codigo || label, label: label || codigo, fuente };
    }

    return null;
  }


  function normalizeCultivoFromApi(c) {
    if (!c || typeof c !== "object") return c;

    // Copia superficial
    const out = { ...c };

    // Compat: algunos endpoints/versiones pueden devolver claves distintas
    if (out.sistema_cultivo == null){
      out.sistema_cultivo =
        out.sistemaCultivo ??
        out.sistema_de_cultivo ??
        out.sistemaCultivoSIEX ??
        out.sistemaCultivoObj ??
        null;
    }

    if (out.avanzado == null){
      out.avanzado =
        out.avanzado_cultivo ??
        out.cultivo_avanzado ??
        out.avanzadoCultivo ??
        out.avanzado_json ??
        null;
    }

    // sistema_cultivo puede venir como objeto o string
    out.sistema_cultivo = normalizeCatalogObj(out.sistema_cultivo);

    // Fallback: en histórico puede venir solo sistema_cultivo_codigo (texto) desde BBDD
    if (!out.sistema_cultivo && out.sistema_cultivo_codigo) {
      const cod = String(out.sistema_cultivo_codigo).trim();
      if (cod) out.sistema_cultivo = { codigo: cod, label: cod, fuente: "SIEX" };
    }

    // avanzado puede venir como objeto o string JSON
    out.avanzado = (typeof out.avanzado === "string") ? parseMaybeJson(out.avanzado) : out.avanzado;
    if (out.avanzado && typeof out.avanzado !== "object") out.avanzado = null;

    // Normaliza también los nested típicos del avanzado (por si vienen como strings)
    if (out.avanzado) {
      const a = out.avanzado;
      if (a.aprovechamiento) a.aprovechamiento = normalizeCatalogObj(a.aprovechamiento);
      if (a.tipo_cobertura_suelo) a.tipo_cobertura_suelo = normalizeCatalogObj(a.tipo_cobertura_suelo);
      if (a.destino_cultivo) a.destino_cultivo = normalizeCatalogObj(a.destino_cultivo);
      if (a.tipo_labor) a.tipo_labor = normalizeCatalogObj(a.tipo_labor);
      if (a.procedencia_material_vegetal) a.procedencia_material_vegetal = normalizeCatalogObj(a.procedencia_material_vegetal);
      if (a.senp) a.senp = normalizeCatalogObj(a.senp);

      if (a.material_vegetal && typeof a.material_vegetal === "object") {
        if (a.material_vegetal.tipo) a.material_vegetal.tipo = normalizeCatalogObj(a.material_vegetal.tipo);
        if (a.material_vegetal.detalle) a.material_vegetal.detalle = normalizeCatalogObj(a.material_vegetal.detalle);
      }
    }

    return out;
  }

  // Check robusto (para "Sí/No" y para normalizar a null)
  function hasAvanzado(a) {
    a = (typeof a === "string") ? parseMaybeJson(a) : a;
    if (!a || typeof a !== "object") return false;

    const stack = [a];
    while (stack.length) {
      const x = stack.pop();
      if (!x) continue;

      if (typeof x === "string") {
        if (x.trim()) return true;
        continue;
      }
      if (typeof x === "number") {
        if (Number.isFinite(x)) return true;
        continue;
      }
      if (Array.isArray(x)) {
        for (const it of x) stack.push(it);
        continue;
      }
      if (typeof x === "object") {
        for (const [k, v] of Object.entries(x)) {
          if (v === null || v === undefined) continue;
          if (k === "fuente") continue; // no cuenta como "relleno"
          stack.push(v);
        }
      }
    }
    return false;
  }


  function csvEscape(value, delimiter = ";") {
    if (value === null || value === undefined) return "";
    let s = String(value);

    // normaliza saltos de línea
    s = s.replace(/\r\n/g, "\n").replace(/\r/g, "\n");

    // si contiene comillas, delimitador o salto de línea => entrecomillar
    const mustQuote = s.includes('"') || s.includes("\n") || s.includes(delimiter);
    if (s.includes('"')) s = s.replace(/"/g, '""');
    return mustQuote ? `"${s}"` : s;
  }

  function rowsToCsv(headers, rows, delimiter = ";") {
    const head = headers.map(h => csvEscape(h, delimiter)).join(delimiter);
    const body = rows.map(r => r.map(v => csvEscape(v, delimiter)).join(delimiter)).join("\n");
    return head + "\n" + body;
  }

  function downloadCsv(filename, csvText) {
    const blob = new Blob(["\ufeff", csvText], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();

    setTimeout(() => URL.revokeObjectURL(url), 2000);
  }


  function cultivoTipoLabel(c) {
    const code = (c.cod_producto == null) ? "N/A" : String(c.cod_producto);
    const name = safeText(c.tipo_cultivo || c.cultivo_custom, "N/A");
    return `${code}-${name}`;
  }

  function cultivoUsoLabel(c, usosMap) {
    const u = usosMap.get(String(c.uso_sigpac));
    return formatCodigoDesc(c.uso_sigpac, u?.descripcion || c.uso_sigpac);
  }

  function sistemaLabel(val) {
    const v = String(val || "").toUpperCase();
    if (v === "R") return "Regadío";
    if (v === "S") return "Secano";
    return "N/A";
  }

  function tipoRegistroLabel(val) {
    const v = String(val || "").toUpperCase();
    if (v.includes("IMPL")) return "Plantación";
    if (v.includes("CAMP")) return "Campaña";
    return safeText(val, "N/A");
  }

  function renderCultivoView(container, recintoId, cultivo, usos, productos) {
    const usosMap = byCodigo(usos);
    const tipoReg = tipoRegistroLabel(cultivo.tipo_registro);
    const isCamp = String(cultivo.tipo_registro || "").toUpperCase().includes("CAMP");

    const inicio = isCamp ? cultivo.fecha_siembra : cultivo.fecha_implantacion;
    const fin = cultivo.fecha_cosecha_real || cultivo.fecha_cosecha_estimada;

    const variedad = cultivo.variedad ? safeText(cultivo.variedad) : "N/A";
    const obs = cultivo.observaciones || "";

    container.innerHTML = `
      <div class="cultivo-grid">
        <div class="cultivo-field">
          <div class="k">Uso SIGPAC</div>
          <div class="v">${safeText(cultivoUsoLabel(cultivo, usosMap))}</div>
        </div>
        <div class="cultivo-field">
          <div class="k">Tipo cultivo</div>
          <div class="v">${safeText(cultivoTipoLabel(cultivo))}</div>
        </div>

        <div class="cultivo-field">
          <div class="k">Variedad</div>
          <div class="v">${safeText(variedad)}</div>
        </div>
        <div class="cultivo-field">
          <div class="k">Explotación</div>
          <div class="v">${safeText(sistemaLabel(cultivo.sistema_explotacion))}</div>
        </div>

        <div class="cultivo-field">
          <div class="k">Sistema de cultivo</div>
          <div class="v">${
            escapeHtml(
              (cultivo?.sistema_cultivo && typeof cultivo.sistema_cultivo === "object")
                ? (cultivo.sistema_cultivo.label || cultivo.sistema_cultivo.codigo || "—")
                : (cultivo?.sistema_cultivo || "—")
            )
          }</div>
        </div>

        <div class="cultivo-field">
          <div class="k">${isCamp ? "Campaña" : "Tipo registro"}</div>
          <div class="v">${isCamp ? safeText(cultivo.campana, "N/A") : safeText(tipoReg)}</div>
        </div>
        <div class="cultivo-field">
          <div class="k">Estado</div>
          <div class="v">${estadoLabel(cultivo.estado)}</div>
        </div>

        <div class="cultivo-field">
          <div class="k">Fecha inicio</div>
          <div class="v">${safeText(formatDateOnly(inicio))}</div>
        </div>
        <div class="cultivo-field">
          <div class="k">Fecha fin</div>
          <div class="v">${safeText(formatDateOnly(fin))}</div>
        </div>
      </div>

      <div class="side-soft-divider"></div>
      <div class="cultivo-field">
        <div class="k">Avanzado</div>
        <div class="v">
          ${hasAvanzado(cultivo.avanzado)
            ? `<button type="button" class="btn btn-outline-success btn-sm" id="btn-ver-avanzado-main">Ver</button>`
            : "—"}
        </div>
      </div>

      <div class="side-soft-divider"></div>
      <div class="mt-3">
        <div class="fw-bold mb-1">Observaciones</div>

        <!-- Texto normal (no editable) -->
        <div id="obs-view" class="border rounded-3 p-2" style="min-height:90px; white-space:pre-wrap;"></div>

        <!-- Textarea sólo cuando el usuario pulsa “Editar observaciones” -->
        <textarea id="obs-edit" class="form-control d-none" rows="3" placeholder="(Opcional)"></textarea>

        <div class="cultivo-actions mt-2" id="obs-view-actions">
          <button id="btn-edit-obs" class="btn btn-outline-success btn-sm" type="button">
            Editar observaciones
          </button>
          <button id="btn-edit-cultivo" class="btn btn-outline-success btn-sm" type="button">
            Editar cultivo
          </button>
          <button id="btn-del-cultivo" class="btn btn-outline-danger btn-sm" type="button">
            Eliminar cultivo
          </button>
        </div>

            <div class="cultivo-actions mt-2 d-none" id="obs-edit-actions">
              <button id="btn-obs-accept" class="btn btn-success btn-sm" type="button">Aceptar</button>
              <button id="btn-obs-cancel" class="btn btn-secondary btn-sm" type="button">Cancelar</button>
            </div>
          </div>
    `;

    // --- Observaciones: render “texto normal” ---
    const obsView = container.querySelector("#obs-view");
    const obsEdit = container.querySelector("#obs-edit");
    const viewActions = container.querySelector("#obs-view-actions");
    const editActions = container.querySelector("#obs-edit-actions");

    // Ver avanzado (si existe)
    const btnVerAv = container.querySelector("#btn-ver-avanzado-main");
    if (btnVerAv) {
      btnVerAv.addEventListener("click", () => openAvanzadoModal(cultivo.avanzado));
    }

    function renderObsText(text) {
      const t = String(text || "");
      if (!t.trim()) {
        obsView.innerHTML = `<span class="text-muted">(Sin observaciones)</span>`;
      } else {
        obsView.textContent = t;
      }
    }

    renderObsText(obs);
    obsEdit.value = obs;

    let obsOriginal = obsEdit.value;

    container.querySelector("#btn-edit-obs").addEventListener("click", () => {
      obsOriginal = obsEdit.value;

      obsView.classList.add("d-none");
      obsEdit.classList.remove("d-none");

      viewActions.classList.add("d-none");
      editActions.classList.remove("d-none");

      obsEdit.focus();
    });

    container.querySelector("#btn-obs-cancel").addEventListener("click", () => {
      obsEdit.value = obsOriginal;

      obsEdit.classList.add("d-none");
      obsView.classList.remove("d-none");

      editActions.classList.add("d-none");
      viewActions.classList.remove("d-none");
    });

    container.querySelector("#btn-obs-accept").addEventListener("click", async () => {
      try {
        const val = obsEdit.value;

        await fetchJson(`/api/cultivos/${cultivo.id_cultivo}`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ observaciones: val }),
        });

        cultivo.observaciones = val;
        obsOriginal = val;

        renderObsText(val);

        obsEdit.classList.add("d-none");
        obsView.classList.remove("d-none");

        editActions.classList.add("d-none");
        viewActions.classList.remove("d-none");

        NotificationSystem.show({
          type: "success",
          title: "Observaciones guardadas",
          message: ""
        });
      } catch (e) {
        console.warn(e);
        NotificationSystem.show({
          type: "error",
          title: "Error",
          message: "No se pudieron guardar las observaciones"
        });
      }
    });

    // Editar cultivo
    container.querySelector("#btn-edit-cultivo").addEventListener("click", async () => {
      try {
        const cultivoFresh = await getCultivoRecinto(recintoId);
        renderCultivoForm(container, { recintoId: cultivoFresh.id_recinto || recintoId, cultivo: cultivoFresh, usos, productos });
      } catch (e) {
        console.warn("No se pudo refrescar cultivo antes de editar, uso el objeto en memoria.", e);
        renderCultivoForm(container, { recintoId: cultivo.id_recinto || recintoId, cultivo, usos, productos });
      }
    });

    // Eliminar cultivo
    container.querySelector("#btn-del-cultivo").addEventListener("click", () => {
      abrirConfirmacionEliminarCultivo(recintoId);
    });
  }

  async function abrirConfirmacionEliminarCultivo(recintoId) {
    const ok = await AppConfirm.open({
      title: "Eliminar cultivo",
      message: "¿Seguro que deseas eliminar el cultivo actual? Este proceso no es reversible y también se eliminará su entrada correspondiente en el histórico.",
      okText: "Eliminar",
      cancelText: "Cancelar",
      okClass: "btn-danger"
    });

    if (!ok) return;

    try {
      await fetchJson(`/api/mis-recinto/${recintoId}/cultivo`, { method: "DELETE" });
      NotificationSystem.show({
        type: "success",
        title: "Cultivo eliminado",
        message: ""
      });
      renderCultivosForRecinto(recintoId);
    } catch (e) {
      console.warn(e);
      NotificationSystem.show({
        type: "error",
        title: "Error",
        message: "No se pudo eliminar el cultivo"
      });
    }
  }

  function openSs(ssEl) { ssEl.classList.add("open"); }
  function closeSs(ssEl) { ssEl.classList.remove("open"); }

  function attachSearchSelect(ssEl, items, opts) {
    const input = ssEl.querySelector("input");
    const menu = ssEl.querySelector(".ss-menu");
    const hidden = ssEl.querySelector("input[type=hidden]");
    const {
      getLabel,
      getValue,
      onSelect,
      allowFreeText = false,
      emptyText = "Sin resultados",
    } = opts;

    function renderList(list) {
      menu.innerHTML = "";
      if (!list.length) {
        const d = document.createElement("div");
        d.className = "ss-item text-muted";
        d.textContent = emptyText;
        menu.appendChild(d);
        return;
      }
      for (const it of list) {
        const d = document.createElement("div");
        d.className = "ss-item";
        d.textContent = getLabel(it);
        d.addEventListener("mousedown", (ev) => {
          ev.preventDefault(); // evita perder foco antes de seleccionar
          const val = getValue(it);
          hidden.value = (val === null || val === undefined) ? "" : String(val);
          input.value = getLabel(it);
          closeSs(ssEl);
          onSelect?.(it);
        });
        menu.appendChild(d);
      }
    }

    function filterNow() {
      const q = norm(input.value);
      const list = items.filter(it => {
        const label = norm(getLabel(it));
        const val = norm(getValue(it));
        return !q || label.includes(q) || val.includes(q);
      });
      renderList(list.slice(0, 200));
    }

    input.addEventListener("focus", () => { openSs(ssEl); filterNow(); });
    input.addEventListener("input", () => { openSs(ssEl); filterNow(); });

    input.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeSs(ssEl);
      if (allowFreeText && e.key === "Enter") closeSs(ssEl);
    });

    document.addEventListener("click", (e) => {
      if (!ssEl.contains(e.target)) closeSs(ssEl);
    });

    // inicial
    renderList(items.slice(0, 50));
    return {
      setItems(newItems) {
        items = newItems;
        filterNow();
      },
      getSelectedValue() {
        return hidden.value || null;
      }
    };
  }

  function renderCultivoForm(container, { recintoId, cultivo, usos, productos, mode="actual", cultivoId=null, currentCultivoId=null, onDone=null, onCancel=null }) {
    const usosMap = byCodigo(usos);
    const productosAll = productos || [];

    const estadoOpts = [
      { v: "planificado", l: "Planificado" },
      { v: "implantado",  l: "Plantado" },
      { v: "en_curso",    l: "En cultivo" },
      { v: "cosechado",   l: "Cosechado" },
      { v: "abandonado",  l: "Abandonado" }
    ];

    const tipoRegOpts = [
      { v: "CAMPANA", l: "Campaña (año a año)" },
      { v: "IMPLANTACION", l: "Plantación (permanente)" },
    ];

    container.innerHTML = `
      <div class="card" style="border-radius:16px">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="fw-bold">${cultivo ? "Editar cultivo" : "Añadir cultivo"}</div>
            <button id="btn-cancel-cultivo" type="button" class="btn btn-sm btn-outline-secondary">Cancelar</button>
          </div>

          <div class="mb-3 ss" id="ss-uso">
            <label class="form-label fw-bold">Uso SIGPAC *</label>
            <input class="form-control" type="text" placeholder="Busca: CI-Cítricos, OV-Olivar, TA-Tierras arables..." autocomplete="off">
            <input type="hidden" id="uso_sigpac_val">
            <div class="ss-menu"></div>
          </div>

          <div class="d-flex justify-content-between align-items-center mb-1">
            <label class="form-label fw-bold mb-0">Tipo de cultivo *</label>
            <button id="btn-ver-todos" type="button" class="btn btn-sm btn-outline-success" disabled>Ver todos</button>
          </div>

          <div class="mb-3 ss" id="ss-prod">
            <input class="form-control" type="text" placeholder="Busca por código o nombre: 99-PATATA, N/A-ALTRAMUZ..." autocomplete="off" disabled>
            <input type="hidden" id="cod_producto_val">
            <div class="ss-menu"></div>
            <div class="form-text" id="prod-help">Selecciona primero el uso SIGPAC.</div>
          </div>

          <div class="mb-3" id="custom-wrap" style="display:none">
            <label class="form-label fw-bold">Cultivo personalizado</label>
            <input id="cultivo_custom" class="form-control" type="text" placeholder="Escribe el cultivo (p.ej. ALTRAMUZ)">
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">Sistema de cultivo *</label>
            <select id="cultivo-sistema" class="form-select" required></select>
            <div class="form-text">Catálogo SIEX: SISTEMA_CULTIVO</div>
          </div>

          <div class="mb-3 position-relative">
          <label class="form-label fw-bold">Variedad (opcional)</label>
          <input id="variedad" class="form-control" type="text" 
                placeholder="Empieza a escribir: Picual, Arbequina..." 
                autocomplete="off">
          <div id="variedad-suggestions" class="list-group position-absolute w-100" style="z-index:1000; max-height:200px; overflow-y:auto; display:none;"></div>
          <div class="form-text">Selecciona una variedad de la lista o escribe una nueva.</div>
        </div>

          <div class="mb-3">
            <label class="form-label fw-bold">Estado</label>
            <select id="estado" class="form-select">
              ${estadoOpts.map(o => `<option value="${o.v}">${o.l}</option>`).join("")}
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">Explotación</label>
            <div class="d-flex gap-3">
              <div class="form-check">
                <input class="form-check-input" type="radio" name="sistema_explotacion" id="exp-sec" value="S" checked>
                <label class="form-check-label" for="exp-sec">Secano</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="sistema_explotacion" id="exp-reg" value="R">
                <label class="form-check-label" for="exp-reg">Regadío</label>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">Tipo de registro</label>
            <select id="tipo_registro" class="form-select">
              ${tipoRegOpts.map(o => `<option value="${o.v}">${o.l}</option>`).join("")}
            </select>
          </div>

          <div class="mb-3" id="campana-wrap" style="display:none">
            <label class="form-label fw-bold">Campaña</label>
            <input id="campana" class="form-control" type="number" min="1900" max="2200" placeholder="2026">
          </div>

          <div class="mb-3" id="fecha-inicio-wrap">
            <label class="form-label fw-bold" id="lbl-fecha-inicio">Fecha siembra</label>
            <input id="fecha_inicio" class="form-control" type="date">
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">Fecha fin (opcional)</label>
            <input id="fecha_fin" class="form-control" type="date">
            <div class="form-text">Si no indicas fecha fin, se estimará automáticamente.</div>
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">Observaciones (opcional)</label>
            <textarea id="observaciones" class="form-control" rows="3" placeholder="Escribe notas..."></textarea>
          </div>

          <div class="accordion mt-2" id="cultivo-adv-acc">
            <div class="accordion-item">
              <h2 class="accordion-header" id="cultivo-adv-h">
                <button class="accordion-button collapsed" type="button"
                        data-bs-toggle="collapse" data-bs-target="#cultivo-adv-c">
                  Avanzado (opcional)
                </button>
              </h2>

              <div id="cultivo-adv-c" class="accordion-collapse collapse" data-bs-parent="#cultivo-adv-acc">
                <div class="accordion-body">
                  <div class="row g-2">

                    <div class="col-12 col-md-4">
                      <label class="form-label fw-bold">Aprovechamiento</label>
                      <select id="adv-aprovechamiento" class="form-select"></select>
                      <div class="form-text">Catálogo SIEX: APROVECHAMIENTO</div>
                    </div>

                    <div class="col-12 col-md-4">
                      <label class="form-label fw-bold">Tipo cobertura del suelo</label>
                      <select id="adv-tipo-cobertura" class="form-select"></select>
                      <div class="form-text">Catálogo SIEX: TIPO_COBERTURA_SUELO</div>
                    </div>

                    <div class="col-12 col-md-4">
                      <label class="form-label fw-bold">Destino del cultivo</label>
                      <select id="adv-destino" class="form-select"></select>
                      <div class="form-text">Catálogo SIEX: DESTINO_CULTIVO</div>
                    </div>

                    <div class="col-12 col-md-4">
                      <label class="form-label fw-bold">Material vegetal (tipo)</label>
                      <select id="adv-mvr-tipo" class="form-select"></select>
                      <div class="form-text">Catálogo SIEX: MVR_TIPO</div>
                    </div>

                    <div class="col-12 col-md-4">
                      <label class="form-label fw-bold">Material vegetal (detalle)</label>
                      <select id="adv-mvr-detalle" class="form-select" disabled></select>
                      <div class="form-text">Catálogo SIEX: MVR_DETALLE (depende de tipo)</div>
                    </div>

                    <div class="col-12 col-md-4">
                      <label class="form-label fw-bold">Tipo de labor</label>
                      <select id="adv-tipo-labor" class="form-select"></select>
                      <div class="form-text">Catálogo SIEX: TIPO_LABOR</div>
                    </div>

                    <div class="col-12 col-md-4">
                      <label class="form-label fw-bold">Procedencia material vegetal</label>
                      <select id="adv-proc-mv" class="form-select"></select>
                      <div class="form-text">Catálogo SIEX: PROCEDENCIA_MATERIAL_VEGETAL</div>
                    </div>

                    <div class="col-12 col-md-4">
                      <label class="form-label fw-bold">SENP</label>
                      <select id="adv-senp" class="form-select"></select>
                      <div class="form-text">Catálogo SIEX: SENP</div>
                    </div>

                  </div>
                </div>
              </div>
            </div>
          </div>

          <button id="btn-save-cultivo" type="button" class="btn btn-success w-100">Guardar</button>
          <div id="cultivo-form-msg" class="text-muted" style="font-size:12px; margin-top:8px"></div>
        </div>
      </div>
    `;

    // Autocompletado de variedad
    const variedadInput = container.querySelector("#variedad");
    const suggestionsList = container.querySelector("#variedad-suggestions");
    let timeoutVariedad = null;

    variedadInput.addEventListener("input", async (e) => {
      const query = e.target.value.trim();
      
      // Limpiar timeout anterior
      if (timeoutVariedad) {
        clearTimeout(timeoutVariedad);
      }
      
      // Si está vacío, ocultar sugerencias
      if (query.length < 1) {
        suggestionsList.style.display = "none";
        suggestionsList.innerHTML = "";
        return;
      }
      
      // Esperar 200ms después de que el usuario deje de escribir
      timeoutVariedad = setTimeout(async () => {
        try {
          // Obtener el producto seleccionado (opcional, para filtrar)
          const productoId = container.querySelector("#cod_producto_val")?.value || "";
          
          // Construir URL con parámetros - CON /api
          let url = `/api/variedades/buscar?q=${encodeURIComponent(query)}`;
          if (productoId && productoId !== "") {
            url += `&producto_id=${productoId}`;
          }
          
          const response = await fetch(url);
          const variedades = await response.json();
          
          // Mostrar sugerencias SOLO si hay resultados
          if (variedades.length > 0) {
            suggestionsList.innerHTML = variedades.map(v => `
              <button type="button" class="list-group-item list-group-item-action" data-nombre="${v.nombre}">
                ${v.nombre}
              </button>
            `).join("");
            suggestionsList.style.display = "block";
          } else {
            // Si no hay resultados, simplemente ocultar las sugerencias
            // El usuario puede seguir escribiendo lo que quiera
            suggestionsList.style.display = "none";
            suggestionsList.innerHTML = "";
          }
        } catch (error) {
          console.error("Error buscando variedades:", error);
          suggestionsList.style.display = "none";
          suggestionsList.innerHTML = "";
        }
      }, 200); // Debounce de 200ms
    });

    // Click en una sugerencia
    suggestionsList.addEventListener("click", (e) => {
      const btn = e.target.closest("button");
      if (btn) {
        const nombre = btn.getAttribute("data-nombre");
        variedadInput.value = nombre;
        suggestionsList.style.display = "none";
        suggestionsList.innerHTML = "";
      }
    });

    // Cerrar sugerencias al hacer click fuera
    document.addEventListener("click", (e) => {
      if (!variedadInput.contains(e.target) && !suggestionsList.contains(e.target)) {
        suggestionsList.style.display = "none";
      }
    });

    // Cerrar sugerencias con Escape
    variedadInput.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        suggestionsList.style.display = "none";
      }
    });

    // Permitir enviar con Enter incluso sin seleccionar de la lista
    variedadInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        suggestionsList.style.display = "none";
      }
    });

    const ssUsoEl = container.querySelector("#ss-uso");
    const ssProdEl = container.querySelector("#ss-prod");
    const btnVerTodos = container.querySelector("#btn-ver-todos");

    // --- SISTEMA_CULTIVO (obligatorio) ---
    const sisCultSel = container.querySelector("#cultivo-sistema");

    const sisCultSelected =
      (cultivo?.sistema_cultivo && typeof cultivo.sistema_cultivo === "object")
        ? (cultivo.sistema_cultivo.codigo || "")
        : (cultivo?.sistema_cultivo || "");

    fillSelectFromCatalog(
      container.querySelector("#cultivo-sistema"),
      "SISTEMA_CULTIVO",
      {
        selected: (cultivo?.sistema_cultivo?.codigo || cultivo?.sistema_cultivo || ""),
        placeholder: "Selecciona..."
      }
    );

    const usoItems = usos.map(u => ({
      codigo: u.codigo,
      descripcion: u.descripcion,
      grupo: u.grupo,
      label: formatCodigoDesc(u.codigo, u.descripcion),
    }));

    let modoVerTodos = false;
    let selectedUso = null;
    let selectedProd = null;
    let productosUso = [];

    const ssUso = attachSearchSelect(ssUsoEl, usoItems, {
      getLabel: (it) => it.label,
      getValue: (it) => it.codigo,
      onSelect: async (it) => {
        selectedUso = it;

        ssProdEl.querySelector("input").disabled = false;
        ssProdEl.querySelector("#prod-help").style.display = "none";
        btnVerTodos.disabled = false;

        modoVerTodos = false;
        btnVerTodos.textContent = "Ver todos";

        try {
          productosUso = await loadProductosFegaPorUso(it.codigo);
        } catch (_) {
          productosUso = [];
        }

        actualizarListaProductos();
      }
    });

    function buildProductosList() {
      const base = productosAll.map(p => ({
        codigo: p.codigo,
        descripcion: p.descripcion,
        origen: "F",
        label: formatCodigoDesc(p.codigo, p.descripcion),
      }));
      const custom = _cultivosCustom.map(p => ({
        codigo: null,
        descripcion: p.descripcion,
        origen: "C",
        label: formatCodigoDesc(null, p.descripcion),
      }));
      // Añadimos "OTRO" para permitir escribir
      const otro = [{ codigo: "__OTRO__", descripcion: "OTRO (escribir...)", origen: "C", label: "N/A-OTRO (escribir...)" }];
      return [...base, ...custom, ...otro];
    }

    let productosItems = buildProductosList();
    let ssProd = attachSearchSelect(ssProdEl, [], {
      getLabel: (it) => it.label,
      getValue: (it) => (it.codigo === null ? "" : it.codigo),
      onSelect: (it) => {
        selectedProd = it;
        const customWrap = container.querySelector("#custom-wrap");
        const customInput = container.querySelector("#cultivo_custom");
        const codHidden = container.querySelector("#cod_producto_val");

        if (it.codigo === "__OTRO__") {
          customWrap.style.display = "";
          codHidden.value = ""; // null
          customInput.focus();
        } else if (it.origen === "C") {
          customWrap.style.display = "";
          codHidden.value = ""; // null
          customInput.value = it.descripcion;
        } else {
          customWrap.style.display = "none";
          codHidden.value = String(it.codigo);
          customInput.value = "";
        }
      }
    });

    function actualizarListaProductos() {
      const baseList = (modoVerTodos || !productosUso.length) ? productosAll : productosUso;

      const fega = (baseList || []).map(p => ({
        codigo: p.codigo,
        descripcion: p.descripcion,
        origen: "F",
        label: formatCodigoDesc(p.codigo, p.descripcion),
      }));

      const custom = _cultivosCustom.map(p => ({
        codigo: null,
        descripcion: p.descripcion,
        origen: "C",
        label: formatCodigoDesc(null, p.descripcion),
      }));

      const otro = [{
        codigo: "__OTRO__",
        descripcion: "OTRO (escribir...)",
        origen: "C",
        label: "N/A-OTRO (escribir...)"
      }];

      productosItems = [...fega, ...custom, ...otro];
      ssProd.setItems(productosItems);

      const help = container.querySelector("#prod-help");
      if (!modoVerTodos && !productosUso.length) {
        help.style.display = "";
        help.textContent = "No hay productos asociados a este uso (según histórico). Pulsa “Ver todos”.";
      } else {
        help.style.display = "none";
      }
    }

    btnVerTodos.addEventListener("click", () => {
      modoVerTodos = !modoVerTodos;
      btnVerTodos.textContent = modoVerTodos ? "Filtrar" : "Ver todos";
      actualizarListaProductos();
    });

    // Tipo registro: muestra campaña o cambia etiqueta de fecha
    const tipoRegSel = container.querySelector("#tipo_registro");
    const campWrap = container.querySelector("#campana-wrap");
    const lblInicio = container.querySelector("#lbl-fecha-inicio");

    function syncTipoRegistroUi() {
      const v = tipoRegSel.value;
      const isCamp = v === "CAMPANA";
      campWrap.style.display = isCamp ? "" : "none";
      lblInicio.textContent = isCamp ? "Fecha siembra" : "Fecha plantación";
    }
    tipoRegSel.addEventListener("change", syncTipoRegistroUi);
    syncTipoRegistroUi();

    // -------- Avanzado (opcional) --------
    function pickObjFromSelect(sel) {
      if (!sel) return null;

      // 1) valor normal del select
      let code = (sel.value || "").trim();

      // 2) si el select está vacío pero el catálogo usa hidden input, lo buscamos
      if (!code) {
        const hiddenId = sel.getAttribute("data-hidden-code-id") || sel.dataset.hiddenCodeId;
        if (hiddenId) {
          const hiddenEl = document.getElementById(hiddenId);
          if (hiddenEl?.value) code = hiddenEl.value.trim();
        }
      }

      if (!code) return null;
      const label = (sel.selectedOptions?.[0]?.textContent || "").trim() || code;
      return { codigo: code, label, fuente: "SIEX" };
    }


    // Lee avanzado existente
    let adv = cultivo?.avanzado ?? null;
    if (typeof adv === "string") { try { adv = JSON.parse(adv); } catch(_) { adv = null; } }
    adv = (adv && typeof adv === "object") ? adv : null;

    const advAprove = container.querySelector("#adv-aprovechamiento");
    const advCob = container.querySelector("#adv-tipo-cobertura");
    const advDest = container.querySelector("#adv-destino");
    const advMvrTipo = container.querySelector("#adv-mvr-tipo");
    const advMvrDet = container.querySelector("#adv-mvr-detalle");
    const advTipoLabor = container.querySelector("#adv-tipo-labor");
    const advProcMv = container.querySelector("#adv-proc-mv");
    const advSenp = container.querySelector("#adv-senp");

    // selected codes
    const advAproveSel = adv?.aprovechamiento?.codigo || "";
    const advCobSel = adv?.tipo_cobertura_suelo?.codigo || "";
    const advDestSel = adv?.destino_cultivo?.codigo || "";

    const advMvrTipoSel = adv?.material_vegetal?.tipo?.codigo || "";
    const advMvrDetSel = adv?.material_vegetal?.detalle?.codigo || "";

    const advTipoLaborSel = adv?.tipo_labor?.codigo || "";
    const advProcMvSel = adv?.procedencia_material_vegetal?.codigo || "";
    const advSenpSel = adv?.senp?.codigo || "";

    // cargar selects simples
    fillSelectFromCatalog(advAprove, "APROVECHAMIENTO", { selected: advAproveSel, placeholder: "(Opcional)" });
    fillSelectFromCatalog(advCob, "TIPO_COBERTURA_SUELO", { selected: advCobSel, placeholder: "(Opcional)" });
    fillSelectFromCatalog(advDest, "DESTINO_CULTIVO", { selected: advDestSel, placeholder: "(Opcional)" });

    fillSelectFromCatalog(advMvrTipo, "MVR_TIPO", { selected: advMvrTipoSel, placeholder: "(Opcional)" });
    fillSelectFromCatalog(advTipoLabor, "TIPO_LABOR", { selected: advTipoLaborSel, placeholder: "(Opcional)" });
    fillSelectFromCatalog(advProcMv, "PROCEDENCIA_MATERIAL_VEGETAL", { selected: advProcMvSel, placeholder: "(Opcional)" });
    fillSelectFromCatalog(advSenp, "SENP", { selected: advSenpSel, placeholder: "(Opcional)" });

    function reloadMvrDetalle({ selected = "" } = {}) {
      const tipo = (advMvrTipo?.value || "").trim();
      if (!tipo) {
        advMvrDet.disabled = true;
        advMvrDet.innerHTML = `<option value="">(Selecciona tipo primero)</option>`;
        return;
      }
      advMvrDet.disabled = false;
      fillSelectFromCatalog(advMvrDet, "MVR_DETALLE", {
        selected,
        placeholder: "(Opcional)",
        parent: tipo
      });
    }

    // inicial detalle (si ya venía algo)
    setTimeout(() => reloadMvrDetalle({ selected: advMvrDetSel }), 0);

    advMvrTipo.addEventListener("change", () => {
      // al cambiar tipo, resetea detalle y recarga por parent
      reloadMvrDetalle({ selected: "" });
    });

    // Si venimos de editar
    if (cultivo) {
      // Uso sigpac
      const u = usosMap.get(String(cultivo.uso_sigpac));
      if (cultivo.uso_sigpac) {
        ssUsoEl.querySelector("input").value = formatCodigoDesc(cultivo.uso_sigpac, u?.descripcion || cultivo.uso_sigpac);
        ssUsoEl.querySelector("#uso_sigpac_val").value = cultivo.uso_sigpac;
        selectedUso = { codigo: cultivo.uso_sigpac, grupo: u?.grupo };
        ssProdEl.querySelector("input").disabled = false;
        btnVerTodos.disabled = false;
        actualizarListaProductos();
      }

      // Tipo cultivo
      const customWrap = container.querySelector("#custom-wrap");
      const customInput = container.querySelector("#cultivo_custom");
      const codHidden = container.querySelector("#cod_producto_val");
      const isFega = (cultivo.origen_cultivo || "").toUpperCase() === "F";

      if (isFega && cultivo.cod_producto != null) {
        const p = productosAll.find(x => String(x.codigo) === String(cultivo.cod_producto));
        ssProdEl.querySelector("input").value = formatCodigoDesc(cultivo.cod_producto, p?.descripcion || cultivo.tipo_cultivo);
        codHidden.value = String(cultivo.cod_producto);
        customWrap.style.display = "none";
      } else {
        ssProdEl.querySelector("input").value = formatCodigoDesc(null, cultivo.cultivo_custom || cultivo.tipo_cultivo);
        codHidden.value = "";
        customWrap.style.display = "";
        customInput.value = cultivo.cultivo_custom || cultivo.tipo_cultivo || "";
      }

      // resto campos
      container.querySelector("#variedad").value = cultivo.variedad || "";
      container.querySelector("#estado").value = cultivo.estado || "en_curso";

      const exp = (cultivo.sistema_explotacion || "S").toUpperCase();
      container.querySelector("#exp-sec").checked = (exp === "S");
      container.querySelector("#exp-reg").checked = (exp === "R");

      const tr = String(cultivo.tipo_registro || "CAMPANA").toUpperCase().includes("IMPL") ? "IMPLANTACION" : "CAMPANA";
      tipoRegSel.value = tr;
      syncTipoRegistroUi();

      container.querySelector("#campana").value = cultivo.campana || "";
      const inicio = (tr === "CAMPANA") ? cultivo.fecha_siembra : cultivo.fecha_implantacion;
      container.querySelector("#fecha_inicio").value = inicio ? String(inicio).slice(0,10) : "";
      const fin = cultivo.fecha_cosecha_real || cultivo.fecha_cosecha_estimada;
      container.querySelector("#fecha_fin").value = fin ? String(fin).slice(0,10) : "";

      container.querySelector("#observaciones").value = cultivo.observaciones || "";
    } else {
      // defaults
      container.querySelector("#estado").value = "planificado";
    }

    container.querySelector("#btn-cancel-cultivo").addEventListener("click", () => {
      if (mode === "historico_add" || mode === "historico_edit") {
        if (mode === "historico_edit" && currentCultivoId && String(cultivoId) === String(currentCultivoId)) {
          // Si acabo de editar el actual desde el histórico, repintar la vista principal YA
          renderCultivosForRecinto(recintoId);
        }
        if (typeof onDone === "function") onDone();
      } else {
        renderCultivosForRecinto(recintoId);
      }
    });

    container.querySelector("#btn-save-cultivo").addEventListener("click", async () => {
      const msg = container.querySelector("#cultivo-form-msg");
      msg.textContent = "";

      const uso = container.querySelector("#uso_sigpac_val").value;
      if (!uso) {
        msg.textContent = "Selecciona un uso SIGPAC.";
        msg.className = "text-danger";
        return;
      }

      const cod = container.querySelector("#cod_producto_val").value;
      const custom = (container.querySelector("#cultivo_custom")?.value || "").trim();

      let origen = "F";
      let cod_producto = null;
      let cultivo_custom = null;

      if (cod) {
        origen = "F";
        cod_producto = Number(cod);
      } else {
        origen = "C";
        cultivo_custom = custom || (selectedProd?.descripcion || "");
      }

      if (origen === "C" && !cultivo_custom) {
        msg.textContent = "Indica el cultivo personalizado (o elige uno de la lista).";
        msg.className = "text-danger";
        return;
      }

      // --- Validación SISTEMA_CULTIVO ---
      const sisCultSel = container.querySelector("#cultivo-sistema");
      const sisCultCode = (sisCultSel?.value || "").trim();

      if (!sisCultCode) {
        msg.textContent = "Selecciona el sistema de cultivo.";
        msg.className = "text-danger";
        return;
      }

      const sistema_cultivo = {
        codigo: sisCultCode,
        label: (sisCultSel?.selectedOptions?.[0]?.textContent || "").trim() || sisCultCode,
        fuente: "SIEX"
      };


      const variedad = (container.querySelector("#variedad")?.value || "").trim() || null;
      const estado = container.querySelector("#estado")?.value || "en_curso";
      const sistema = container.querySelector("input[name='sistema_explotacion']:checked")?.value || "S";

      const tipo_registro = container.querySelector("#tipo_registro")?.value || "CAMPANA";
      const campana = (tipo_registro === "CAMPANA")
        ? (Number(container.querySelector("#campana")?.value) || null)
        : null;

      const fechaInicioRaw = container.querySelector("#fecha_inicio")?.value || null;
      const fechaFinRaw = container.querySelector("#fecha_fin")?.value || null;

      const fechaInicio = parseDateToISO(fechaInicioRaw);
      const fechaFin = parseDateToISO(fechaFinRaw);

      if (fechaFin && fechaInicio && fechaFin < fechaInicio) {
        msg.textContent = "La fecha fin no puede ser anterior a la de inicio.";
        msg.className = "text-danger";
        return;
      }

      if (!fechaInicio) {
        msg.textContent = "Selecciona la fecha de inicio.";
        msg.className = "text-danger";
        return;
      }

      // --- Validación campaña vs fecha (error custom) ---
      if (tipo_registro === "CAMPANA") {
        if (!campana) {
          msg.textContent = "Selecciona un año de campaña.";
          msg.className = "text-danger";
          return;
        }

        // fechaInicio viene ISO: YYYY-MM-DD
        const yFecha = Number(String(fechaInicio).slice(0, 4));
        if (Number.isFinite(yFecha) && Math.abs(yFecha - campana) >= 2) {
          msg.textContent =
            `Año inválido: la fecha de siembra (${yFecha}) no cuadra con la campaña (${campana}). ` +
            `Debe ser el mismo año o como mucho ±1 año.`;
          msg.className = "text-danger";
          return;
        }
      }

      // Si no hay fecha fin: estimación simple
      let fechaCosechaEst = fechaFin;
      let cosechaAuto = false;

      if (!fechaFin) {
        cosechaAuto = true;
        const d = new Date(fechaInicio);
        const deltaDays = (tipo_registro === "CAMPANA") ? 120 : 365;
        d.setDate(d.getDate() + deltaDays);
        fechaCosechaEst = d.toISOString().slice(0, 10);
      }

      const observaciones = container.querySelector("#observaciones")?.value || null;

      const payload = {
        id_recinto: recintoId,
        uso_sigpac: uso,
        sistema_cultivo: sistema_cultivo,
        sistema_explotacion: sistema,
        tipo_registro: tipo_registro,
        campana: campana,
        estado: estado,
        variedad: variedad,
        origen_cultivo: origen,
        cod_producto: cod_producto,
        cultivo_custom: cultivo_custom,
        observaciones: observaciones,
        cosecha_estimada_auto: cosechaAuto,
      };

      // Fechas según tipo_registro
      if (tipo_registro === "CAMPANA") {
        payload.fecha_siembra = fechaInicio;
      } else {
        payload.fecha_implantacion = fechaInicio;
      }
      payload.fecha_cosecha_estimada = fechaCosechaEst;

      // Construir Avanzado (opcional)
      const aAprove = pickObjFromSelect(advAprove);
      const aCob = pickObjFromSelect(advCob);
      const aDest = pickObjFromSelect(advDest);

      const mvTipoObj = pickObjFromSelect(advMvrTipo);
      const mvDetObjBase = pickObjFromSelect(advMvrDet);
      const mvDetObj = mvDetObjBase
        ? { ...mvDetObjBase, parent: (advMvrTipo?.value || "").trim() || null }
        : null;

      const materialVegetal =
        (mvTipoObj || mvDetObj)
          ? { tipo: mvTipoObj, detalle: mvDetObj }
          : null;

      const aTipoLabor = pickObjFromSelect(advTipoLabor);
      const aProcMv = pickObjFromSelect(advProcMv);
      const aSenp = pickObjFromSelect(advSenp);

      const avanzadoRaw = {
        aprovechamiento: aAprove,
        tipo_cobertura_suelo: aCob,
        destino_cultivo: aDest,
        material_vegetal: materialVegetal,
        tipo_labor: aTipoLabor,
        procedencia_material_vegetal: aProcMv,
        senp: aSenp
      };

      // normaliza a null si está vacío
      function normalizeAvanzado(av) {
        if (!av || typeof av !== "object") return null;

        // aplanado simple
        const vals = [
          av.aprovechamiento, av.tipo_cobertura_suelo, av.destino_cultivo,
          av.tipo_labor, av.procedencia_material_vegetal, av.senp
        ];

        const mv = av.material_vegetal;
        if (mv && (mv.tipo || mv.detalle)) vals.push(mv.tipo, mv.detalle);

        const hasAny = vals.some(v => v && (v.codigo || v.label));
        return hasAny ? av : null;
      }

      payload.avanzado = normalizeAvanzado(avanzadoRaw);

      // -------------------------
      // ENDPOINT SEGÚN MODO
      // -------------------------
      let url, method;

      if (mode === "historico_add") {
        url = `/api/mis-recinto/${recintoId}/cultivo-historico`;
        method = "POST";
      } else if (mode === "historico_edit") {
        if (!cultivoId) {
          msg.textContent = "Error: falta id_cultivo para editar el histórico.";
          msg.className = "text-danger";
          return;
        }
        url = `/api/cultivos/${cultivoId}`;
        method = "PATCH";
      } else {
        // modo actual
        url = `/api/mis-recinto/${recintoId}/cultivo`;
        method = cultivo ? "PATCH" : "POST";
      }

      try {
        await fetchJson(url, {
          method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        NotificationSystem.show({
          type: "success",
          title: "Cultivo guardado",
          message: "El cultivo ha sido guardado correctamente",
        });
        
        if (mode === "historico_edit" && currentCultivoId && String(cultivoId) === String(currentCultivoId)) {
          needsRefreshActualCultivo = true;
          // Repinta ya el actual en background aunque esté oculto
          renderCultivosForRecinto(recintoId);
        }

        // -------------------------
        // POST-ACCIÓN SEGÚN MODO
        // -------------------------
        if (mode === "historico_add" || mode === "historico_edit") {
          // volver al overlay y refrescar histórico
          if (typeof onDone === "function") onDone();
        } else {
          renderCultivosForRecinto(recintoId);
        }
      } catch (e) {
          console.warn(e);

          const backendMsg = e?.data?.error || e?.data?.message || "";

          if (backendMsg.includes("fecha de inicio debe ser anterior")) {
            msg.textContent = "El cultivo no puede ser más reciente que el actual.";
          } else if (backendMsg.includes("La fecha fin no puede ser anterior")) {
            msg.textContent = "La fecha fin no puede ser anterior a la de inicio.";
          } else if (backendMsg) {
            msg.textContent = backendMsg;
          } else {
            msg.textContent = "No se pudo guardar el cultivo.";
          }

          msg.className = "text-danger";
      }
    });
  }

  async function guardarNombreRecinto(nombre) {
    if (!currentSideRecintoId) return;

    try {
      const r = await fetch(
        `/api/mis-recinto/${currentSideRecintoId}/nombre`,
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ nombre })
        }
      );

      if (!r.ok) throw new Error();
    } catch (e) {
      mostrarErrorInline("No se pudo guardar el nombre");
    }
  }

    // CHECKBOX activo
    const sideActive = document.getElementById("side-active");
    if (sideActive) {
      sideActive.addEventListener("change", async () => {
        if (!currentSideRecintoId) return;

        const prev = !sideActive.checked; // estado anterior
        const next = sideActive.checked;

        sideActive.disabled = true;

        try {
          const r = await fetch(`/api/mis-recinto/${currentSideRecintoId}/activa`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ activa: next }),
          });

          const resp = await r.json().catch(() => ({}));
          if (!r.ok || !resp.ok) {
            throw new Error(resp.error || "No se pudo actualizar 'activa'");
          }

          // asegurar checkbox según backend
          sideActive.checked = !!resp.activa;

        } catch (err) {
          console.error(err);
          // revertir si falla
          sideActive.checked = prev;

          NotificationSystem.show({
            type: "error",
            title: "No se pudo guardar",
            message: "No se ha podido actualizar el estado del recinto. Intenta de nuevo."
          });
        } finally {
          sideActive.disabled = false;
        }
      });
    }

  // ==========================================================
  // OPERACIONES (UI + API)
  // Endpoints esperados (a implementar backend):
  //   GET    /api/mis-recinto/<id_recinto>/operaciones?limit=5
  //   GET    /api/mis-recinto/<id_recinto>/operaciones?all=1
  //   POST   /api/mis-recinto/<id_recinto>/operaciones
  //   PATCH  /api/operaciones/<id_operacion>
  //   DELETE /api/operaciones/<id_operacion>
  // ==========================================================

  function openOperacionesPanel(){
    const sp = document.getElementById("side-panel");
    const panel = document.getElementById("operaciones-historico-panel");
    if (!sp || !panel) return;

    // Cierra otros overlays por si acaso
    closeHistoricoPanel?.();
    closeGaleriaPanel?.();

    sp.classList.add("operaciones-open");
    panel.classList.remove("d-none");
    panel.setAttribute("aria-hidden", "false");
  }

  function closeOperacionesPanel(){
    const sp = document.getElementById("side-panel");
    const panel = document.getElementById("operaciones-historico-panel");
    if (!sp || !panel) return;

    sp.classList.remove("operaciones-open");
    panel.classList.add("d-none");
    panel.setAttribute("aria-hidden", "true");
  }

  document.getElementById("btn-volver-operaciones-historico")?.addEventListener("click", (e) => {
    e.preventDefault(); e.stopPropagation();
    closeOperacionesPanel();
  });

  document.getElementById("btn-cerrar-operaciones-historico")?.addEventListener("click", (e) => {
    e.preventDefault(); e.stopPropagation();
    document.getElementById("side-close")?.click();
  });

  document.getElementById("btn-historico-operaciones")?.addEventListener("click", async (e) => {
    e.preventDefault(); e.stopPropagation();
    if (!currentSideRecintoId) return;

    openOperacionesPanel();
    await renderOperacionesHistorico(currentSideRecintoId);
  });

  // ---------- Render INLINE (panel principal) ----------
  async function renderOperacionesForRecinto(recintoId){
    const container = document.getElementById("operaciones-container");
    if (!container) return;

    container.innerHTML = `<div class="text-muted">Cargando operaciones...</div>`;

    try {
      const ops = await fetchJson(`/api/mis-recinto/${recintoId}/operaciones?limit=5`);
      renderOperacionesInline(container, recintoId, Array.isArray(ops) ? ops : []);
    } catch (e) {
      console.warn(e);
      container.innerHTML = `
        <div class="text-danger">No se pudieron cargar las operaciones.</div>
        <div class="text-muted" style="font-size:12px">Revisa /api/mis-recinto/${recintoId}/operaciones</div>
      `;
    }
  }

  function opTipoLabel(tipo){
    const t = String(tipo || "").toUpperCase();
    if (t === "RIEGO") return "Riego";
    if (t === "FERTILIZACION") return "Fertilización";
    if (t === "FITOSANITARIO") return "Fitosanitario";
    if (t === "OTRAS") return "Otras";
    return safeText(tipo, "Operación");
  }

  function opBadgeClass(tipo){
    const t = String(tipo || "").toUpperCase();
    if (t === "RIEGO") return "bg-info";
    if (t === "FERTILIZACION") return "bg-success";
    if (t === "FITOSANITARIO") return "bg-warning text-dark";
    if (t === "OTRAS") return "bg-secondary";
    return "bg-secondary";
  }

  
  function normalizeProcedenciaAgua(v){
    if (Array.isArray(v)) return v.filter(Boolean);
    if (v && typeof v === "object") return [v];
    return [];
  }

  function procedenciaAguaToText(v){
    const arr = normalizeProcedenciaAgua(v);
    if (!arr.length) return "";
    return arr
      .map(x => (x?.label || x?.codigo || "").trim())
      .filter(Boolean)
      .join(", ");
  }

  function opResumen(op){
    let d = op?.detalle;
    if (typeof d === "string") { try { d = JSON.parse(d); } catch(_){} }
    d = d || {};
    const tipo = String(op?.tipo || "").toUpperCase();

    if (tipo === "RIEGO") {
      const v = d?.volumen_m3 ?? d?.volumen ?? null;
      const sis = d?.sistema_riego?.label || d?.sistema_riego?.codigo || "";
      const proc = procedenciaAguaToText(d?.procedencia_agua);
      const obs = d?.observaciones || "";
      const txtV = (v != null && v !== "") ? `${Number(v).toFixed(0)} m³` : "—";
      return `${txtV}${sis ? " · " + sis : ""}${proc ? " · " + proc : ""}${obs ? " — " + obs : ""}`;
    }

    if (tipo === "FERTILIZACION") {
      const prod = d?.producto?.label || d?.producto?.codigo || "";
      const cant = d?.cantidad;
      const uni = d?.unidad || "";
      const tipoF = d?.tipo_fertilizacion?.label || d?.tipo_fertilizacion?.codigo || "";
      const obs = d?.observaciones || "";
      const txtC = (cant != null && cant !== "") ? `${cant} ${uni}` : "—";
      return `${txtC}${prod ? " · " + prod : ""}${tipoF ? " · " + tipoF : ""}${obs ? " — " + obs : ""}`;
    }

    if (tipo === "OTRAS") {
      const cat = d?.catalogo || "";
      const lab = d?.label || d?.codigo || "";
      const obs = d?.observaciones || "";
      return `${cat}${lab ? " · " + lab : ""}${obs ? " — " + obs : ""}`.trim() || "—";
    }

    return safeText(op?.descripcion, "—");
  }

  function renderOperacionesInline(container, recintoId, ops){
    const hasOps = ops.length > 0;

    container.innerHTML = `
      <div class="d-flex gap-2 flex-wrap mb-2">
        <button id="btn-add-op-inline" class="btn btn-success btn-sm">
          <i class="bi bi-plus-lg me-1"></i> Añadir operación
        </button>

      </div>

      <div id="op-inline-body"></div>
    `;

    const body = container.querySelector("#op-inline-body");

    if (!hasOps) {
      body.innerHTML = `
        <div class="text-muted" style="font-size:12px">
          No hay operaciones registradas en este recinto.
        </div>
      `;
    } else {
      body.innerHTML = `
        <div class="op-mini-list">
          ${ops.map(op => `
            <div class="op-mini-item d-flex justify-content-between align-items-start">
              <div>
                <div class="d-flex align-items-center gap-2">
                  <span class="badge ${opBadgeClass(op.tipo)} op-badge">${escapeHtml(opTipoLabel(op.tipo))}</span>
                  <span class="text-muted op-date">${escapeHtml(formatDateOnly(op.fecha))}</span>
                </div>
                <div class="op-resumen">${escapeHtml(opResumen(op))}</div>
              </div>

              <div class="d-flex gap-2">
                <button class="btn btn-outline-success btn-sm btn-edit-op-inline" data-id="${op.id_operacion}">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-outline-danger btn-sm btn-del-op-inline" data-id="${op.id_operacion}">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </div>
          `).join("")}
        </div>

        <div id="op-inline-form-slot" class="mt-2"></div>
      `;
    }

    // EDITAR (INLINE)
    body.querySelectorAll(".btn-edit-op-inline").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.dataset.id;
        const op = ops.find(x => String(x.id_operacion) === String(id));
        if (!op) return;

        const slotForm = body.querySelector("#op-inline-form-slot");
        renderOperacionForm(slotForm, {
          recintoId,
          op,
          mode: "actual_edit",
          onDone: async () => { await renderOperacionesForRecinto(recintoId); },
          onCancel: async () => { await renderOperacionesForRecinto(recintoId); },
        });
      });
    });

    // ELIMINAR (INLINE)
    body.querySelectorAll(".btn-del-op-inline").forEach(btn => {
      btn.addEventListener("click", async () => {
        const id = btn.dataset.id;

        const ok = await AppConfirm.open({
          title: "Eliminar operación",
          message: "¿Seguro que deseas eliminar la operación? También se eliminará del histórico. Este proceso no es reversible.",
          okText: "Eliminar",
          cancelText: "Cancelar",
          okClass: "btn-danger"
        });
        if (!ok) return;

        await fetchJson(`/api/operaciones/${id}`, { method: "DELETE" });
        NotificationSystem.show({ type:"success", title:"Operación eliminada", message:"" });
        await renderOperacionesForRecinto(recintoId);
      });
    });
        // AÑADIR (INLINE)
        const btnAdd = container.querySelector("#btn-add-op-inline");
        btnAdd.addEventListener("click", () => {
          const slotForm = body.querySelector("#op-inline-form-slot");
          renderOperacionForm(slotForm, {
            recintoId,
            mode: "actual_add",
            onDone: async () => { await renderOperacionesForRecinto(recintoId); },
            onCancel: async () => { await renderOperacionesForRecinto(recintoId); },
          });
        });
  }

  // ---------- Render HISTÓRICO (overlay) ----------
  async function renderOperacionesHistorico(recintoId){
    const listEl = document.getElementById("operaciones-historico-list");
    if (!listEl) return;

    listEl.innerHTML = `<div class="text-muted">Cargando histórico...</div>`;

    let ops = [];
    try {
      const data = await fetchJson(`/api/mis-recinto/${recintoId}/operaciones?all=1`);
      ops = Array.isArray(data) ? data : [];
    } catch (e) {
      console.warn(e);
      listEl.innerHTML = `<div class="text-danger">No se pudo cargar el histórico de operaciones.</div>`;
      return;
    }

    listEl.innerHTML = `
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
        <div class="d-flex align-items-center gap-2">
          <i class="bi bi-journal-check text-success"></i>
          <span>Registro completo</span>
          <span class="badge bg-success">${ops.length}</span>
        </div>

        <div class="d-flex gap-2 ms-auto">
          <button id="btn-download-ops-csv"
            class="btn btn-outline-success btn-sm"
            ${ops.length ? "" : "disabled"}
            title="${ops.length ? "" : "No hay datos para exportar"}" type="button">
            <i class="bi bi-download me-1"></i> CSV
          </button>
          <button id="btn-add-op-historico" class="btn btn-success btn-sm">
            + Añadir al Histórico
          </button>
        </div>
      </div>

      <div class="side-divider"></div>

      <div class="table-responsive historico-table-wrap">
        <table class="table table-sm table-hover align-middle historico-table mb-0">
          <thead>
            <tr>
              <th style="min-width:110px;">Día</th>
              <th style="min-width:120px;">Tipo</th>
              <th style="min-width:220px;">Descripción</th>

              <th style="min-width:120px;">Riego m³</th>
              <th style="min-width:180px;">Sistema</th>
              <th style="min-width:180px;">Procedencia</th>

              <th style="min-width:140px;">Cantidad</th>
              <th style="min-width:220px;">Producto</th>
              <th style="min-width:160px;">Fert. tipo</th>
              <th style="min-width:160px;">Método</th>
              <th style="min-width:160px;">Material</th>

              <th style="min-width:220px;">Otras (Catálogo / Opción)</th>
              <th style="min-width:220px;">Observaciones</th>

              <th style="min-width:220px;" class="text-end">Acciones</th>
            </tr>
          </thead>
          <tbody>
            ${ops.map(op => {
              let d = op?.detalle;
              if (typeof d === "string") { try { d = JSON.parse(d); } catch(_){} }
              d = d || {};
              const t = String(op?.tipo||"").toUpperCase();

              const riego_m3 = t==="RIEGO" ? (d.volumen_m3 ?? "") : "";
              const riego_sis = t==="RIEGO" ? (d?.sistema_riego?.label || d?.sistema_riego?.codigo || "") : "";
              const riego_proc = t==="RIEGO" ? procedenciaAguaToText(d?.procedencia_agua) : "";

              const fert_cant = t==="FERTILIZACION" ? `${d?.cantidad ?? ""} ${d?.unidad ?? ""}`.trim() : "";
              const fert_prod = t==="FERTILIZACION" ? (d?.producto?.label || d?.producto?.codigo || "") : "";
              const fert_tipo = t==="FERTILIZACION" ? (d?.tipo_fertilizacion?.label || d?.tipo_fertilizacion?.codigo || "") : "";
              const fert_met = t==="FERTILIZACION" ? (d?.metodo_aplicacion?.label || d?.metodo_aplicacion?.codigo || "") : "";
              const fert_mat = t==="FERTILIZACION" ? (d?.material?.label || d?.material?.codigo || "") : "";

              const otras = t==="OTRAS" ? `${d?.catalogo || ""}${d?.label ? " / " + d.label : ""}`.trim() : "";
              const obs = d?.observaciones || d?.obs || op?.descripcion || "";

              return `
                <tr>
                  <td>${escapeHtml(formatDateOnly(op.fecha))}</td>
                  <td><span class="badge ${opBadgeClass(op.tipo)}">${escapeHtml(opTipoLabel(op.tipo))}</span></td>
                  <td>${escapeHtml(op?.descripcion || "—")}</td>

                  <td>${escapeHtml(riego_m3 === "" ? "—" : String(riego_m3))}</td>
                  <td>${escapeHtml(riego_sis || "—")}</td>
                  <td>${escapeHtml(riego_proc || "—")}</td>

                  <td>${escapeHtml(fert_cant || "—")}</td>
                  <td>${escapeHtml(fert_prod || "—")}</td>
                  <td>${escapeHtml(fert_tipo || "—")}</td>
                  <td>${escapeHtml(fert_met || "—")}</td>
                  <td>${escapeHtml(fert_mat || "—")}</td>

                  <td>${escapeHtml(otras || "—")}</td>
                  <td>${escapeHtml(obs || "—")}</td>

                  <td class="="text-end">
                    <div class="d-flex gap-2 justify-content-end flex-wrap">
                      <button class="btn btn-success btn-sm btn-edit-op" data-id="${op.id_operacion}">
                        <i class="bi bi-pencil-fill me-1"></i> Editar
                      </button>
                      <button class="btn btn-danger btn-sm btn-del-op" data-id="${op.id_operacion}">
                        <i class="bi bi-trash-fill me-1"></i> Eliminar
                      </button>
                    </div>
                  </td>
                </tr>
              `;
            }).join("")}
          </tbody>
        </table>
      </div>

      <div id="op-hist-form-slot" class="mt-3"></div>
    `;

    // Deshabilitar botón CSV si no hay datos
    const csvBtn = listEl.querySelector("#btn-download-ops-csv");
    if (csvBtn && csvBtn.disabled){
      csvBtn.classList.remove("btn-outline-success");
      csvBtn.classList.add("btn-outline-secondary");

      const wrap = document.createElement("span");const csvBtn = listEl.querySelector("#btn-download-operaciones-csv");
if (csvBtn && csvBtn.disabled){
  csvBtn.classList.remove("btn-outline-success");
  csvBtn.classList.add("btn-outline-secondary");

  const wrap = document.createElement("span");
  wrap.className = "d-inline-block";
  wrap.title = "Ahora mismo no se puede descargar CSV";

  csvBtn.parentNode.insertBefore(wrap, csvBtn);
  wrap.appendChild(csvBtn);
}

      wrap.className = "d-inline-block";
      wrap.title = "Ahora mismo no se puede descargar CSV";

      csvBtn.parentNode.insertBefore(wrap, csvBtn);
      wrap.appendChild(csvBtn);
    }

    // Añadir histórico
    listEl.querySelector("#btn-add-op-historico")?.addEventListener("click", () => {
      const slot = listEl.querySelector("#op-hist-form-slot");
      renderOperacionForm(slot, {
        recintoId,
        op: null,
        mode: "historico_add",
        onDone: async () => { await renderOperacionesHistorico(recintoId); },
        onCancel: async () => { await renderOperacionesHistorico(recintoId); },
      });
    });

    // Editar
    listEl.querySelectorAll(".btn-edit-op").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.dataset.id;
        const op = ops.find(x => String(x.id_operacion) === String(id));
        if (!op) return;

        const slot = listEl.querySelector("#op-hist-form-slot");
        renderOperacionForm(slot, {
          recintoId,
          op,
          mode: "historico_edit",
          onDone: async () => { await renderOperacionesHistorico(recintoId); },
          onCancel: async () => { await renderOperacionesHistorico(recintoId); },
        });
      });
    });

    // Eliminar
    listEl.querySelectorAll(".btn-del-op").forEach(btn => {
      btn.addEventListener("click", async () => {
        const id = btn.dataset.id;

        const ok = await AppConfirm.open({
          title: "Eliminar operación",
          message: "¿Seguro que deseas eliminar la operación? Este proceso no es reversible.",
          okText: "Eliminar",
          cancelText: "Cancelar",
          okClass: "btn-danger"
        });
        if (!ok) return;

        await fetchJson(`/api/operaciones/${id}`, { method: "DELETE" });
        NotificationSystem.show({ type: "success", title: "Operación eliminada", message: "" });
        await renderOperacionesHistorico(recintoId);
      });
    });

    listEl.querySelector("#btn-download-ops-csv")?.addEventListener("click", () => {
      if (!Array.isArray(arr) || arr.length === 0) return;
      const headers = [
        "id_operacion",
        "fecha",
        "tipo",
        "descripcion",

        "riego_volumen_m3",
        "riego_sistema",
        "riego_procedencia",
        "riego_inicio",
        "riego_fin",
        "riego_metodo_medicion",
        "riego_lectura_inicial_m3",
        "riego_lectura_final_m3",

        "fert_tipo",
        "fert_metodo",
        "fert_material",
        "fert_producto_codigo",
        "fert_producto_label",
        "fert_cantidad",
        "fert_unidad",

        "otras_catalogo",
        "otras_codigo",
        "otras_label",

        "observaciones"
      ];

      const rows = (ops || []).map(op => {
        let d = op?.detalle;
        if (typeof d === "string") { try { d = JSON.parse(d); } catch(_){} }
        d = d || {};
        const t = String(op?.tipo || "").toUpperCase();

        // RIEGO
        const r_vol = t === "RIEGO" ? (d.volumen_m3 ?? d.volumen ?? "") : "";
        const r_sis = t === "RIEGO" ? (d?.sistema_riego?.label || d?.sistema_riego?.codigo || "") : "";
        const r_proc = t === "RIEGO" ? procedenciaAguaToText(d?.procedencia_agua) : "";
        const r_fi = t === "RIEGO" ? (d?.fecha_inicio || "") : "";
        const r_ff = t === "RIEGO" ? (d?.fecha_fin || "") : "";
        const r_met = t === "RIEGO" ? (d?.medicion?.metodo || "") : "";
        const r_li = t === "RIEGO" ? (d?.medicion?.lectura_inicial_m3 ?? "") : "";
        const r_lf = t === "RIEGO" ? (d?.medicion?.lectura_final_m3 ?? "") : "";

        // FERTILIZACION
        const f_tipo = t === "FERTILIZACION" ? (d?.tipo_fertilizacion?.label || d?.tipo_fertilizacion?.codigo || "") : "";
        const f_met = t === "FERTILIZACION" ? (d?.metodo_aplicacion?.label || d?.metodo_aplicacion?.codigo || "") : "";
        const f_mat = t === "FERTILIZACION" ? (d?.material?.label || d?.material?.codigo || "") : "";
        const f_prod_c = t === "FERTILIZACION" ? (d?.producto?.codigo || "") : "";
        const f_prod_l = t === "FERTILIZACION" ? (d?.producto?.label || "") : "";
        const f_cant = t === "FERTILIZACION" ? (d?.cantidad ?? "") : "";
        const f_uni = t === "FERTILIZACION" ? (d?.unidad || "") : "";

        // OTRAS
        const o_cat = t === "OTRAS" ? (d?.catalogo || "") : "";
        const o_cod = t === "OTRAS" ? (d?.codigo || "") : "";
        const o_lab = t === "OTRAS" ? (d?.label || "") : "";

        const obs = d?.observaciones || d?.obs || op?.descripcion || "";

        return [
          op?.id_operacion ?? "",
          formatDateOnly(op?.fecha),
          op?.tipo ?? "",
          op?.descripcion ?? "",

          r_vol,
          r_sis,
          r_proc,
          r_fi,
          r_ff,
          r_met,
          r_li,
          r_lf,

          f_tipo,
          f_met,
          f_mat,
          f_prod_c,
          f_prod_l,
          f_cant,
          f_uni,

          o_cat,
          o_cod,
          o_lab,

          obs ?? ""
        ];
      });

      const csv = rowsToCsv(headers, rows, ";");
      const file = `operaciones_historico_recinto_${recintoId || currentSideRecintoId || "NA"}.csv`;
      downloadCsv(file, csv);
    });

  }

  // --------------------------
  // Catálogos SIEX (helpers)
  // --------------------------
  const _catCache = new Map();

  async function fetchCatalogoOps(catalogo, { parent=null, q=null, limit=200 } = {}) {
    const key = JSON.stringify({ catalogo, parent, q, limit });
    if (_catCache.has(key)) return _catCache.get(key);

    const params = new URLSearchParams();
    if (parent) params.set("parent", parent);
    if (q) params.set("q", q);
    if (limit) params.set("limit", String(limit));

    const url = `/api/catalogos/operaciones/${encodeURIComponent(String(catalogo).toUpperCase())}` +
                (params.toString() ? `?${params.toString()}` : "");

    const data = await fetchJson(url);
    const arr = Array.isArray(data) ? data : [];
    _catCache.set(key, arr);
    return arr;
  }

  function fillSelectFromCatalog(selectEl, catalogo, { selected = "", placeholder = "Selecciona..." , parent = null, q = null, limit = 500 } = {}) {
    if (!selectEl) return;

    const sel = String(selected ?? "").trim();

    // placeholder
    selectEl.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = placeholder;
    selectEl.appendChild(opt0);

    // construir query
    const params = new URLSearchParams();
    if (parent) params.set("parent", parent);
    if (q) params.set("q", q);
    if (limit) params.set("limit", String(limit));

    const url = `/api/catalogos/operaciones/${encodeURIComponent(String(catalogo).toUpperCase())}` + (params.toString() ? `?${params}` : "");

    fetchJson(url)
      .then(list => {
        const arr = Array.isArray(list) ? list : [];

        for (const r of arr) {
          const code = String(r.codigo ?? "").trim();
          const label = String(r.nombre ?? "").trim() || code;
          if (!code) continue;

          const opt = document.createElement("option");
          opt.value = code;
          opt.textContent = label;
          selectEl.appendChild(opt);
        }

        if (sel) selectEl.value = sel;

        if (sel && selectEl.value !== sel) {
          const opt = document.createElement("option");
          opt.value = sel;
          opt.textContent = sel;
          opt.selected = true;
          selectEl.appendChild(opt);
          selectEl.value = sel;
        }
      })
      .catch(err => {
        console.warn("No se pudo cargar catálogo", catalogo, err);
        if (sel) {
          const opt = document.createElement("option");
          opt.value = sel;
          opt.textContent = sel;
          opt.selected = true;
          selectEl.appendChild(opt);
          selectEl.value = sel;
        }
      });
  }


  // typeahead muy ligero
  function attachTypeaheadCatalog(inputEl, listEl, hiddenCodeEl, catalogo, { minChars=2, limit=20 } = {}) {
    if (!inputEl || !listEl) return;

    let lastQ = "";
    let timer = null;

    inputEl.addEventListener("input", () => {
      const q = (inputEl.value || "").trim();
      if (q.length < minChars) {
        listEl.innerHTML = "";
        listEl.classList.add("d-none");
        if (hiddenCodeEl) hiddenCodeEl.value = "";
        return;
      }

      lastQ = q;
      clearTimeout(timer);
      timer = setTimeout(async () => {
        try {
          const rows = await fetchCatalogoOps(catalogo, { q, limit });
          // si el usuario ya cambió el texto, no renderiza resultados viejos
          if (lastQ !== q) return;

          if (!rows.length) {
            listEl.innerHTML = "";
            listEl.classList.add("d-none");
            if (hiddenCodeEl) hiddenCodeEl.value = "";
            return;
          }

          listEl.innerHTML = rows.map(r => `
            <button type="button" class="list-group-item list-group-item-action"
                    data-code="${escapeHtml(r.codigo)}"
                    data-label="${escapeHtml(r.nombre || r.codigo)}">
              <div class="fw-semibold">${escapeHtml(r.nombre || r.codigo)}</div>
              ${r.descripcion ? `<div class="small text-muted">${escapeHtml(r.descripcion)}</div>` : ``}
            </button>
          `).join("");

          listEl.classList.remove("d-none");

          listEl.querySelectorAll("button").forEach(btn => {
            btn.addEventListener("click", () => {
              inputEl.value = btn.dataset.label || "";
              if (hiddenCodeEl) hiddenCodeEl.value = btn.dataset.code || "";
              listEl.innerHTML = "";
              listEl.classList.add("d-none");
            });
          });

        } catch (e) {
          console.warn("typeahead error", e);
        }
      }, 200);
    });

    // cerrar al perder foco (con delay para permitir click)
    inputEl.addEventListener("blur", () => setTimeout(() => {
      listEl.classList.add("d-none");
    }, 150));
  }

  // ---------- FORM (inline y overlay) ----------
  function renderOperacionForm(container, {recintoId, op=null, mode="actual", onDone=null, onCancel=null}){
    if (!container) return;

    // normaliza detalle
    let det = op?.detalle;
    if (typeof det === "string") {
      try { det = JSON.parse(det); } catch (_) {}
    }
    det = det || {};

    const tipoDefault = (op?.tipo || "RIEGO").toUpperCase();

    container.innerHTML = `
      <div class="card op-card" style="border-radius:16px">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="fw-bold">${op ? "Editar operación" : "Añadir operación"}</div>
            <button id="btn-cancel-op" type="button" class="btn btn-sm btn-outline-secondary">Cancelar</button>
          </div>

          <div class="row g-2">
            <div class="col-12 col-md-4">
              <label class="form-label fw-bold">Tipo *</label>
              <select id="op-tipo" class="form-select">
                <option value="RIEGO">Riego</option>
                <option value="FERTILIZACION">Fertilización</option>
                <option value="OTRAS">Otras Operaciones</option>
              </select>
            </div>

            <div class="col-12 col-md-4">
              <label id="op-fecha-label" class="form-label fw-bold">Fecha *</label>
              <input id="op-fecha" class="form-control" type="date">
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label fw-bold">Descripción</label>
              <input id="op-desc" class="form-control" type="text" placeholder="(Opcional)">
            </div>
          </div>

          <div class="side-soft-divider" style="margin:14px 0;"></div>

          <div id="op-detalle-slot"></div>

          <div class="mt-3">
            <button id="btn-save-op" type="button" class="btn btn-success w-100">Guardar</button>
            <div id="op-form-msg" class="text-muted" style="font-size:12px; margin-top:8px"></div>
          </div>
        </div>
      </div>
    `;

    const tipoSel = container.querySelector("#op-tipo");
    const fechaInp = container.querySelector("#op-fecha");
    const descInp = container.querySelector("#op-desc");
    const slot = container.querySelector("#op-detalle-slot");
    const msg = container.querySelector("#op-form-msg");

    // defaults
    tipoSel.value = tipoDefault;
    fechaInp.value = op?.fecha ? String(op.fecha).slice(0,10) : (new Date().toISOString().slice(0,10));
    descInp.value = op?.descripcion || "";

    function renderDetalle(tipo){
      const t = String(tipo || "").toUpperCase();

      if (t === "RIEGO") {
        container.querySelector("#op-fecha-label").textContent = (t === "RIEGO") ? "Día *" : "Fecha *";
        const fi = det?.fecha_inicio ? String(det.fecha_inicio).slice(0,16) : "";
        const ff = det?.fecha_fin ? String(det.fecha_fin).slice(0,16) : "";
        const vol = det?.volumen_m3 ?? "";
        const sis = det?.sistema_riego?.codigo || "";
        const procArr = normalizeProcedenciaAgua(det?.procedencia_agua);
        const procCodes = procArr.map(x => x.codigo).filter(Boolean);
        const metodo = det?.medicion?.metodo || "MANUAL";
        const li = det?.medicion?.lectura_inicial_m3 ?? "";
        const lf = det?.medicion?.lectura_final_m3 ?? "";
        const obs = det?.observaciones || "";

        slot.innerHTML = `
          <div class="row g-2">
            <div class="col-12 col-md-6">
              <label class="form-label fw-bold">Inicio</label>
              <input id="riego-fi" class="form-control" type="datetime-local" value="${escapeHtml(fi)}">
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label fw-bold">Fin</label>
              <input id="riego-ff" class="form-control" type="datetime-local" value="${escapeHtml(ff)}">
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label fw-bold">Volumen (m³) *</label>
              <input id="riego-vol" class="form-control" type="number" step="0.01" min="0" value="${escapeHtml(vol)}">
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label fw-bold">Sistema riego *</label>
              <select id="riego-sis" class="form-select"></select>
              <div class="form-text">Catálogo SIEX: RIEGO_SISTEMA</div>
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label fw-bold">Procedencia *</label>
              <div id="riego-proc-box" class="border rounded-3 p-2" style="max-height:180px; overflow:auto;"></div>
              <div class="form-text">Catálogo SIEX: RIEGO_PROCEDENCIA</div>
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label fw-bold">Medición</label>
              <select id="riego-metodo" class="form-select">
                <option value="MANUAL">Manual</option>
                <option value="CONTADOR">Contador</option>
                <option value="TELEMETRIA">Telemetría</option>
              </select>
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label fw-bold">Lectura inicial (m³)</label>
              <input id="riego-li" class="form-control" type="number" step="0.01" min="0" value="${escapeHtml(li)}">
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label fw-bold">Lectura final (m³)</label>
              <input id="riego-lf" class="form-control" type="number" step="0.01" min="0" value="${escapeHtml(lf)}">
            </div>

            <div class="col-12">
              <label class="form-label fw-bold">Observaciones</label>
              <textarea id="riego-obs" class="form-control" rows="2" placeholder="(Opcional)">${escapeHtml(obs)}</textarea>
            </div>
          </div>
        `;

        fillSelectFromCatalog(slot.querySelector("#riego-sis"), "RIEGO_SISTEMA", { selected: sis, placeholder: "Sistema..." });
        (async () => {
          const box = slot.querySelector("#riego-proc-box");
          const list = await fetchCatalogoOps("RIEGO_PROCEDENCIA", { limit: 500 });

          const selectedCodes = new Set(procCodes);

          box.innerHTML = list.map(r => {
            const code = String(r.codigo ?? "").trim();
            const label = String(r.nombre ?? "").trim() || code;
            const checked = selectedCodes.has(code) ? "checked" : "";
            return `
              <label class="d-flex align-items-center gap-2 mb-1" style="font-size:13px">
                <input class="form-check-input riego-proc-chk" type="checkbox" value="${escapeHtml(code)}" ${checked}>
                <span>${escapeHtml(label)}</span>
              </label>
            `;
          }).join("");
        })();

        slot.querySelector("#riego-metodo").value = metodo;

        const fechaMain = container.querySelector("#op-fecha");
        const fiEl = slot.querySelector("#riego-fi");

        fiEl?.addEventListener("change", () => {
          if (fiEl.value) fechaMain.value = fiEl.value.slice(0, 10);
        });

        fechaMain?.addEventListener("change", () => {
          if (!fiEl.value && fechaMain.value) {
            fiEl.value = `${fechaMain.value}T00:00`;
          }
        });

        return;
      }

      // FERTILIZACION
      const tipoF = det?.tipo_fertilizacion?.codigo || "";
      const prodCode = det?.producto?.codigo || "";
      const prodLabel = det?.producto?.label || "";
      const cant = det?.cantidad ?? "";
      const uni = det?.unidad || "kg";
      const met = det?.metodo_aplicacion?.codigo || "";
      const mat = det?.material?.codigo || "";
      const obs = det?.observaciones || "";

      slot.innerHTML = `
        <div class="row g-2">

          <div class="col-12 col-md-4">
            <label class="form-label fw-bold">Tipo fertilización *</label>
            <select id="fer-tipo" class="form-select"></select>
            <div class="form-text">Catálogo SIEX: FERT_TIPO</div>
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label fw-bold">Método aplicación</label>
            <select id="fer-metodo" class="form-select"></select>
            <div class="form-text">Catálogo SIEX: FERT_METODO</div>
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label fw-bold">Material</label>
            <select id="fer-material" class="form-select"></select>
            <div class="form-text">Catálogo SIEX: FERT_MATERIAL</div>
          </div>

          <div class="col-12 col-md-6 position-relative">
            <label class="form-label fw-bold">Producto *</label>
            <input id="fer-prod" class="form-control" type="text" placeholder="Escribe para buscar..." value="${escapeHtml(prodLabel)}">
            <input id="fer-prod-code" type="hidden" value="${escapeHtml(prodCode)}">
            <div id="fer-prod-list" class="list-group position-absolute w-100 d-none" style="z-index:1050; max-height:220px; overflow:auto;"></div>
            <div class="form-text">Catálogo SIEX: FERT_PRODUCTO (búsqueda)</div>
          </div>

          <div class="col-6 col-md-3">
            <label class="form-label fw-bold">Cantidad *</label>
            <input id="fer-cant" class="form-control" type="number" step="0.01" min="0" value="${escapeHtml(cant)}">
          </div>

          <div class="col-6 col-md-3">
            <label class="form-label fw-bold">Unidad</label>
            <select id="fer-uni" class="form-select">
              <option value="kg">kg</option>
              <option value="t">t</option>
              <option value="l">l</option>
            </select>
          </div>

          <div class="col-12">
            <label class="form-label fw-bold">Observaciones</label>
            <textarea id="fer-obs" class="form-control" rows="2" placeholder="(Opcional)">${escapeHtml(obs)}</textarea>
          </div>

          <div class="accordion mt-2" id="fert-adv-acc">
            <div class="accordion-item">
              <h2 class="accordion-header" id="fert-adv-h">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#fert-adv-c">
                  Avanzado (opcional)
                </button>
              </h2>
              <div id="fert-adv-c" class="accordion-collapse collapse" data-bs-parent="#fert-adv-acc">
                <div class="accordion-body">
                  <div class="row g-2">
                    <div class="col-12 col-md-4">
                      <label class="form-label fw-bold">Macronutriente</label>
                      <select id="fer-macro" class="form-select"></select>
                    </div>
                    <div class="col-12 col-md-4">
                      <label class="form-label fw-bold">Micronutriente</label>
                      <select id="fer-micro" class="form-select"></select>
                    </div>
                    <div class="col-12 col-md-4">
                      <label class="form-label fw-bold">Metales pesados</label>
                      <select id="fer-metales" class="form-select"></select>
                    </div>
                    <div class="col-12 col-md-6">
                      <label class="form-label fw-bold">Tratamiento estiércoles</label>
                      <select id="fer-estiercol" class="form-select"></select>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>
      `;

      // cargar selects
      fillSelectFromCatalog(slot.querySelector("#fer-tipo"), "FERT_TIPO", { selected: tipoF, placeholder: "Tipo..." });
      fillSelectFromCatalog(slot.querySelector("#fer-metodo"), "FERT_METODO", { selected: met, placeholder: "Método..." });
      fillSelectFromCatalog(slot.querySelector("#fer-material"), "FERT_MATERIAL", { selected: mat, placeholder: "Material..." });
      fillSelectFromCatalog(slot.querySelector("#fer-macro"), "FERT_MACRO", { selected: det?.composicion_opcional?.macro?.codigo || "", placeholder: "(Opcional)" });
      fillSelectFromCatalog(slot.querySelector("#fer-micro"), "FERT_MICRO", { selected: det?.composicion_opcional?.micro?.codigo || "", placeholder: "(Opcional)" });
      fillSelectFromCatalog(slot.querySelector("#fer-metales"), "FERT_METALES", { selected: det?.composicion_opcional?.metales?.codigo || "", placeholder: "(Opcional)" });
      fillSelectFromCatalog(slot.querySelector("#fer-estiercol"), "FERT_TRAT_ESTIERCOL", { selected: det?.tratamiento_estiercol?.codigo || "", placeholder: "(Opcional)" });


      // typeahead producto
      attachTypeaheadCatalog(
        slot.querySelector("#fer-prod"),
        slot.querySelector("#fer-prod-list"),
        slot.querySelector("#fer-prod-code"),
        "FERT_PRODUCTO",
        { minChars: 2, limit: 20 }
      );

      // defaults
      slot.querySelector("#fer-uni").value = uni;

      // OTRAS
      if (t === "OTRAS") {
        // defaults
        const cat = det?.catalogo || "";
        const codigo = det?.codigo || "";
        const parent = det?.parent || "";

        slot.innerHTML = `
          <div class="row g-2">
            <div class="col-12 col-md-4">
              <label class="form-label fw-bold">Catálogo *</label>
              <select id="otras-cat" class="form-select">
                <option value="">Selecciona...</option>
                <option value="ACTIVIDAD_AGRARIA">Actividad agraria</option>
                <option value="ACTIVIDAD_CUBIERTA">Actividad sobre la cubierta</option>
              </select>
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label fw-bold">Opción *</label>
              <select id="otras-item" class="form-select" disabled>
                <option value="">Selecciona catálogo primero...</option>
              </select>
              <div class="form-text">Catálogo SIEX: el que elijas arriba</div>
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label fw-bold">Observaciones</label>
              <input id="otras-obs" class="form-control" type="text" placeholder="(Opcional)" value="${escapeHtml(det?.observaciones || "")}">
            </div>
          </div>
        `;

        const catSel = slot.querySelector("#otras-cat");
        const itemSel = slot.querySelector("#otras-item");

        // set catálogo
        catSel.value = cat;

        function loadItems() {
          const c = (catSel.value || "").trim();
          if (!c) {
            itemSel.disabled = true;
            itemSel.innerHTML = `<option value="">Selecciona catálogo primero...</option>`;
            return;
          }
          itemSel.disabled = false;
          fillSelectFromCatalog(itemSel, c, { selected: codigo, placeholder: "Selecciona..." });
        }

        catSel.addEventListener("change", () => {
          itemSel.value = "";
          loadItems();
        });

        loadItems();
        return;
      }

    }

    renderDetalle(tipoSel.value);

    tipoSel.addEventListener("change", () => {
      det = {}; // cambia tipo => limpia detalle
      renderDetalle(tipoSel.value);
    });

    container.querySelector("#btn-cancel-op")?.addEventListener("click", () => {
      onCancel?.();
    });

    container.querySelector("#btn-save-op")?.addEventListener("click", async () => {
      msg.textContent = "";
      msg.className = "text-muted";

      const tipo = String(tipoSel.value || "").toUpperCase();
      const fecha = parseDateToISO(fechaInp.value);
      const descripcion = (descInp.value || "").trim() || null;

      if (!tipo) { msg.textContent = "Selecciona el tipo."; msg.className="text-danger"; return; }
      if (!fecha) { msg.textContent = "Selecciona la fecha."; msg.className="text-danger"; return; }

      // Construir payload
      const payload = {
        schema_version: 1,
        tipo,
        fecha,
        descripcion,
        detalle: {}
      };

      if (tipo === "RIEGO") {
        const vol = Number(slot.querySelector("#riego-vol")?.value);
        if (!Number.isFinite(vol) || vol < 0) {
          msg.textContent = "Volumen (m³) inválido.";
          msg.className = "text-danger";
          return;
        }

        const sisSel = slot.querySelector("#riego-sis");

        const sisCode = (sisSel?.value || "").trim();

        const box = slot.querySelector("#riego-proc-box");
        const checked = Array.from(box?.querySelectorAll(".riego-proc-chk:checked") || []);

        const procedencias = checked.map(chk => ({
          codigo: chk.value,
          label: (chk.parentElement?.querySelector("span")?.textContent || "").trim() || chk.value,
          fuente: "SIEX"
        }));

        if (!sisCode) { msg.textContent = "Selecciona el sistema de riego."; msg.className="text-danger"; return; }
        if (!procedencias.length) { msg.textContent = "Selecciona la procedencia del agua."; msg.className="text-danger"; return; }

        const metodo = slot.querySelector("#riego-metodo")?.value || "MANUAL";

        const fi = slot.querySelector("#riego-fi")?.value || null;
        const ff = slot.querySelector("#riego-ff")?.value || null;

        const li = slot.querySelector("#riego-li")?.value;
        const lf = slot.querySelector("#riego-lf")?.value;

        payload.detalle = {
          fecha_inicio: fi ? fi : null,
          fecha_fin: ff ? ff : null,
          volumen_m3: vol,

          sistema_riego: {
            codigo: sisCode,
            label: (sisSel?.selectedOptions?.[0]?.textContent || "").trim() || sisCode,
            fuente: "SIEX"
          },
          procedencia_agua: procedencias,
          medicion: {
            metodo,
            lectura_inicial_m3: (li !== "" && li != null) ? Number(li) : null,
            lectura_final_m3: (lf !== "" && lf != null) ? Number(lf) : null
          },
          observaciones: (slot.querySelector("#riego-obs")?.value || "").trim() || null
        };
      }

      if (tipo === "FERTILIZACION") {
        const tipoSel = slot.querySelector("#fer-tipo");
        const metSel = slot.querySelector("#fer-metodo");
        const matSel = slot.querySelector("#fer-material");
        const macroSel = slot.querySelector("#fer-macro");
        const microSel = slot.querySelector("#fer-micro");
        const metalSel = slot.querySelector("#fer-metales");
        const estSel = slot.querySelector("#fer-estiercol");

        const tipoCode = tipoSel?.value || "";
        const tipoLabel = (tipoSel?.selectedOptions?.[0]?.textContent || "").trim() || tipoCode;

        const metCode = metSel?.value || "";
        const metLabel = (metSel?.selectedOptions?.[0]?.textContent || "").trim() || metCode;

        const matCode = matSel?.value || "";
        const matLabel = (matSel?.selectedOptions?.[0]?.textContent || "").trim() || matCode;

        const prodLabel = (slot.querySelector("#fer-prod")?.value || "").trim();
        const prodCode = (slot.querySelector("#fer-prod-code")?.value || "").trim() || null;

        const cant = Number(slot.querySelector("#fer-cant")?.value);
        const uni = slot.querySelector("#fer-uni")?.value || "kg";

        if (!tipoCode) { msg.textContent="Selecciona el tipo de fertilización."; msg.className="text-danger"; return; }
        if (!prodLabel) { msg.textContent="Indica el producto."; msg.className="text-danger"; return; }
        if (!Number.isFinite(cant) || cant <= 0) { msg.textContent="Cantidad inválida."; msg.className="text-danger"; return; }

        function pickOpt(sel){
          const code = (sel?.value || "").trim();
          if (!code) return null;
          const label = (sel?.selectedOptions?.[0]?.textContent || "").trim() || code;
          return { codigo: code, label, fuente: "SIEX" };
        }

        payload.detalle = {
          tipo_fertilizacion: { codigo: tipoCode, label: tipoLabel, fuente: "SIEX" },
          metodo_aplicacion: metCode ? { codigo: metCode, label: metLabel, fuente: "SIEX" } : null,
          material: matCode ? { codigo: matCode, label: matLabel, fuente: "SIEX" } : null,
          producto: { codigo: prodCode, label: prodLabel, fuente: "SIEX" },
          cantidad: cant,
          unidad: uni,
          observaciones: (slot.querySelector("#fer-obs")?.value || "").trim() || null
        };

        payload.detalle.composicion_opcional = {
          macro: pickOpt(macroSel),
          micro: pickOpt(microSel),
          metales: pickOpt(metalSel),
        };

        payload.detalle.tratamiento_estiercol = pickOpt(estSel);
      }

      if (tipo === "OTRAS") {
        const cat = slot.querySelector("#otras-cat")?.value || "";
        const cod = slot.querySelector("#otras-item")?.value || "";
        const label = (slot.querySelector("#otras-item")?.selectedOptions?.[0]?.textContent || "").trim();
        const obs = (slot.querySelector("#otras-obs")?.value || "").trim() || null;

        if (!cat) { msg.textContent="Selecciona catálogo."; msg.className="text-danger"; return; }
        if (!cod) { msg.textContent="Selecciona una opción."; msg.className="text-danger"; return; }

        payload.detalle = {
          catalogo: cat,
          codigo: cod,
          label: label || cod,
          observaciones: obs
        };
      }

      // ENDPOINTS
      try {
        if (op && op.id_operacion) {
          await fetchJson(`/api/operaciones/${op.id_operacion}`, {
            method: "PATCH",
            headers: { "Content-Type":"application/json" },
            body: JSON.stringify(payload)
          });
        } else {
          await fetchJson(`/api/mis-recinto/${recintoId}/operaciones`, {
            method: "POST",
            headers: { "Content-Type":"application/json" },
            body: JSON.stringify(payload)
          });
        }

        NotificationSystem.show({ type:"success", title:"Operación guardada", message:"" });
        onDone?.();

      } catch (e) {
        console.warn(e);
        const backendMsg = e?.data?.error || e?.data?.message || "";
        msg.textContent = backendMsg || "No se pudo guardar la operación.";
        msg.className = "text-danger";
      }
    });
  }


  // -----------------------------------------
  // 3) Capas base
  // -----------------------------------------
  const baseOSM = L.tileLayer(
    "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
    {
      attribution: "&copy; OpenStreetMap contributors",
      minZoom: 8,
      maxZoom: 19,
    }
  ).addTo(map);

  const baseSat = L.tileLayer(
    "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
    {
      attribution: "Tiles &copy; Esri",
      minZoom: 8,
      maxZoom: 19,
    }
  );

  const baseSentinelRecent = L.imageOverlay(
    `/static/sentinel2/s2_rgb_latest_3857.png?v={{ s2_version }}`,
    S2_BOUNDS,
    { opacity: 1.0, className: "s2-overlay", interactive: false }
  );

  const baseNdvi = L.imageOverlay(
    `/static/ndvi/ndvi_latest_3857.png?v={{ ndvi_version }}`,
    NDVI_BOUNDS,
    { opacity: 1.0, className: "ndvi-overlay", interactive: false }
  );

  const highZoomLayers = {
    satellite: baseSat,
    sentinel_recent: baseSentinelRecent,
    ndvi: baseNdvi
  };

  const urlParams = new URLSearchParams(window.location.search);
  const capaInicial = urlParams.get('capa') || 'satellite';


  function actualizarBasemapUI(layerKey) {
  document.querySelectorAll('.basemap-option.basemap-main')
    .forEach(opt => opt.classList.remove('active'));

  const activeOption = document.querySelector(
    `.basemap-option.basemap-main[data-layer="${layerKey}"]`
  );

  if (activeOption && !activeOption.classList.contains('disabled')) {
    activeOption.classList.add('active');
  }
}

  let activeHighLayerKey = capaInicial;
  actualizarBasemapUI(activeHighLayerKey);
  function getActiveHighLayer() {
    return highZoomLayers[activeHighLayerKey];
  }


  

  // -----------------------------------------
  // 4) Capa de recintos
  // -----------------------------------------

  const RECINTO_STYLE_DEFAULT = {
    color: "#ff8800",
    weight: 1,
  };

  const RECINTO_STYLE_SELECTED = {
    color: "#0077ff",
    weight: 2,
    fillOpacity: 0.25,
  };

  let selectedRecintoLayer = null;
  

  const recintosLayer = L.geoJSON(null, {
    pane: 'sigpacPane',
    style: function () {
      return RECINTO_STYLE_DEFAULT;
    },
    onEachFeature: function (feature, layer) {
      const p = feature.properties || {};

      // Propietario: username o "N/A"
      const propietarioTexto =
        p.propietario && String(p.propietario).trim() !== ""
          ? p.propietario
          : "N/A";

      const tienePropietario = propietarioTexto !== "N/A";
      const disabledAttr = tienePropietario ? "disabled" : "";
      const disabledStyle = tienePropietario
        ? "opacity: 0.5; cursor: not-allowed;"
        : "";

      const html = `
        <div class="popup-recinto">
          <div class="popup-recinto-info">
            <strong>Provincia:</strong> ${p.provincia ?? " "} - ${p.nombre_provincia ?? " "}<br>
            <strong>Municipio:</strong> ${p.municipio ?? " "} - ${p.nombre_municipio ?? " "}<br>
            <strong>Polígono:</strong> ${p.poligono ?? "-"}<br>
            <strong>Parcela:</strong> ${p.parcela ?? "-"}<br>
            <strong>Recinto:</strong> ${p.recinto ?? "-"}<br>
            <strong>Propietario:</strong> ${propietarioTexto}
          </div>
          <div style="margin-top: 10px; text-align: right;">
            <button
              type="button"
              class="btn-add-recinto"
              data-id-recinto="${p.id_recinto ?? ""}"
              data-provincia="${p.provincia ?? ""}"
              data-municipio="${p.municipio ?? ""}"
              data-agregado="${p.agregado ?? ""}"
              data-zona="${p.zona ?? ""}"
              data-poligono="${p.poligono ?? ""}"
              data-parcela="${p.parcela ?? ""}"
              data-recinto="${p.recinto ?? ""}"
              ${disabledAttr}
              style="
                padding: 6px 10px;
                font-size: 0.85rem;
                border-radius: 999px;
                border: none;
                background-color: #198754;
                color: white;
                cursor: pointer;
                ${disabledStyle}
              "
              onclick="window._solicitarRecintoDesdePopup(this)"
            >
              Añadir a mis recintos
            </button>
          </div>
        </div>
      `;

      layer.bindPopup(html);

      // Marcar visualmente la selección
      layer.on("click", function () {
        if (selectedRecintoLayer && selectedRecintoLayer !== layer) {
          selectedRecintoLayer.setStyle(RECINTO_STYLE_DEFAULT);
        }
        selectedRecintoLayer = layer;
        layer.setStyle(RECINTO_STYLE_SELECTED);
        layer.openPopup();
      });
    },
  }).addTo(map);

  function openSigpacPopupForKey(key) {
    let targetLayer = null;

    recintosLayer.eachLayer((lyr) => {
      const p = (lyr.feature && lyr.feature.properties) || {};
      if (String(p.id_recinto) === String(key)) targetLayer = lyr;
    });

    if (!targetLayer) return false;

    if (selectedRecintoLayer && selectedRecintoLayer !== targetLayer) {
      selectedRecintoLayer.setStyle(RECINTO_STYLE_DEFAULT);
    }
    selectedRecintoLayer = targetLayer;
    targetLayer.setStyle(RECINTO_STYLE_SELECTED);
    targetLayer.openPopup();
    return true;
  }

  function openSigpacPopupForKeyWithRetry(key, tries = 12) {
    if (openSigpacPopupForKey(key)) return;
    if (tries <= 0) return;
    setTimeout(() => openSigpacPopupForKeyWithRetry(key, tries - 1), 250);
  }

  const MIS_RECINTO_STYLE = {
    color: "#00a86b",
    weight: 5,
    opacity: 1,
    fillColor: "#00a86b",
    fillOpacity: 0.22,
  };

function actualizarHistoricoCultivos() {
  const sp = document.getElementById("side-panel");
  const panel = document.getElementById("cultivos-historico-panel");
  
  if (sp && panel && sp.classList.contains("cultivos-historico-open")) {
    // El panel está abierto, recargar los datos
    if (currentSideRecintoId) {
      const btnHistorico = document.getElementById("btn-historico-cultivos");
      if (btnHistorico) {
        btnHistorico.click(); // Simular click para recargar
      }
    }
    return true;
  }
  return false;
}

// Función para actualizar el histórico de operaciones
function actualizarHistoricoOperaciones() {
  const sp = document.getElementById("side-panel");
  const panel = document.getElementById("operaciones-historico-panel");
  
  if (sp && panel && sp.classList.contains("operaciones-open")) {
    // El panel está abierto, recargar los datos
    if (currentSideRecintoId) {
      renderOperacionesHistorico(currentSideRecintoId);
    }
    return true;
  }
  return false;
}

function actualizarNdviPanel() {
  if (window.ndviManager && window.ndviManager.panelDetalleAbierto) {
    // El panel está abierto, se actualizará automáticamente cuando
    // se llame a setRecintoId en renderSidePanelFromProps
    return true; // Indica que el panel estaba abierto
  }
  return false;
}


async function abrirRecintoEnPanel(data) {
  if (!data || !data.id) return;

  // Detectar qué paneles están abiertos ANTES de cambiar los datos
  const ndviAbierto = actualizarNdviPanel();
  const cultivosAbierto = document.getElementById("side-panel")?.classList.contains("cultivos-historico-open");
  const operacionesAbierto = document.getElementById("side-panel")?.classList.contains("operaciones-open");
  const galeriaAbierta = document.getElementById("side-panel")?.classList.contains("galeria-open");

  // abrir split
  setSplitMode(true);

  // setear id global
  currentSideRecintoId = data.id;

  // pintar panel (esto actualizará automáticamente el contenido base y NDVI)
  renderSidePanelFromProps(data);

  // Actualizar los paneles que estaban abiertos
  setTimeout(() => {
    if (cultivosAbierto) {
      actualizarHistoricoCultivos();
    }
    if (operacionesAbierto) {
      actualizarHistoricoOperaciones();
    }
    if (galeriaAbierta) {
      actualizarGaleria();
    }
    // El NDVI se actualiza automáticamente en renderSidePanelFromProps
  }, 100);

  // centrar y resaltar
  centrarEnRecinto(data);
  
  // Guardar estado después de abrir
  setTimeout(() => guardarEstadoMapa(), 300);
}

  async function abrirRecintoDesdeVer(dataFlask) {
    if (!dataFlask || !dataFlask.id) return;

    // Siempre centramos y resaltamos en rojo
    centrarEnRecinto(dataFlask);

    // Comprobar si es mío intentando pedir detalle "mis-recinto"
    try {
      const r = await fetch(`/api/mis-recinto/${dataFlask.id}`);
      if (!r.ok) throw new Error("No es mío");

      const dataDb = await r.json();

      // Es mío -> abrir panel con datos reales de BBDD
      setSplitMode(true);
      currentSideRecintoId = dataDb.id;
      renderSidePanelFromProps(dataDb);

    } catch (_) {
      // No es mío (admin u otro) -> NO abrir panel
      setSplitMode(false);
    }
  }

  async function abrirSidePanelSiEsMio(recintoId) {
    if (!recintoId) return false;

    try {
      const r = await fetch(`/api/mis-recinto/${recintoId}`);
      if (!r.ok) return false;

      const dataDb = await r.json();

      setSplitMode(true);
      currentSideRecintoId = dataDb.id;
      renderSidePanelFromProps(dataDb);

      return true;
    } catch (e) {
      return false;
    }
  }

  async function centrarYAbrirPanelSiEsMio(dataFlask) {
    if (!dataFlask || !dataFlask.id) return;
    centrarEnRecinto(dataFlask);
    await abrirSidePanelSiEsMio(dataFlask.id);
  }

  const misRecintosLayer = L.geoJSON(null, {
    pane: 'misPane',
    style: () => MIS_RECINTO_STYLE,
    onEachFeature: function (feature, layer) {
      layer.on("click", async function (e) {
        try { L.DomEvent.stop(e); } catch (_) {}

        const id = feature?.properties?.id_recinto;
        if (!id) return;

        try {
          const r = await fetch(`/api/mis-recinto/${id}`);
          if (!r.ok) throw new Error("No se pudo cargar detalle del recinto");
          const data = await r.json();

          abrirRecintoEnPanel(data);

        } catch (err) {
          console.error(err);
        }
      });
    }
  }).addTo(map);
    
  // Mis IDs para evitar duplicados
  const MIS_IDS = new Set();

  // Por defecto activos
  let misRecintosActivos = true;

 function cargarMisRecintosSiProcede() {
  const z = map.getZoom();

  // Siempre limpiar primero
  if (z < ZOOM_RECINTOS || !misRecintosActivos) {
    misRecintosLayer.clearLayers();
    return;
  }

  const b = map.getBounds();
  const bbox = [
    b.getWest().toFixed(6),
    b.getSouth().toFixed(6),
    b.getEast().toFixed(6),
    b.getNorth().toFixed(6),
  ].join(",");

  fetch(`/api/mis-recintos?bbox=${bbox}`)
    .then((r) => {
      if (!r.ok) throw new Error("Respuesta no OK de /api/mis-recintos");
      return r.json();
    })
    .then((fc) => {
      // Verificar de nuevo el zoom antes de añadir
      if (map.getZoom() < ZOOM_RECINTOS) {
        misRecintosLayer.clearLayers();
        return;
      }
      
      misRecintosLayer.clearLayers();

      MIS_IDS.clear();
      if (fc && fc.features && fc.features.length) {
        fc.features.forEach(f => {
          const p = f.properties || {};
          if (p.id_recinto != null) MIS_IDS.add(String(p.id_recinto));
        });
        misRecintosLayer.addData(fc);
      }
    })
    .catch((err) => console.error("Error al cargar mis recintos:", err));
}

  // *** Recintos activos por defecto ***
  let recintosActivos = true;

  // Función auxiliar para llamar a la API de solicitudes
  function solicitarRecinto(payload) {
    fetch("/api/solicitudes-recinto", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(payload),
    })
      .then((response) => response.json().catch(() => ({})))
      .then((data) => {
        if (data && data.ok) {
         NotificationSystem.show({
            type: 'success',
            title: '¡Solicitud enviada!',
            message: 'Tu solicitud ha sido enviada al administrador correctamente.'
          }); 
        } else {
          const msg = (data && data.error) || "No se ha podido crear la solicitud. ¿Estás identificado?";
          console.error("Error en la respuesta de la API:", data);

          NotificationSystem.show({
            type: 'error',
            title: 'Error en la solicitud',
            message: msg
          });
        }
      })
      .catch((err) => {
        console.error("Error al crear la solicitud de recinto:", err);

        NotificationSystem.show({
          type: 'warning',
          title: 'Error de comunicación',
          message: 'No se pudo conectar con el servidor. Por favor, intenta de nuevo.'
        });
      });
  }

  // Función auxiliar para mensajes tipo bootstrap
  function mostrarErrorInline(msg) {
    const c = document.getElementById("side-alerts");
    if (!c) return;

    c.innerHTML = `
      <div class="alert alert-danger alert-dismissible fade show" role="alert">
        ${msg}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    `;
  }

  // Handler global llamado desde el botón del popup
  window._solicitarRecintoDesdePopup = function (btn) {
    if (!btn || btn.disabled) return;

    const ds = btn.dataset;

    const payload = {
      id_recinto: ds.idrecinto || null,
      provincia: ds.provincia ? Number(ds.provincia) : null,
      municipio: ds.municipio ? Number(ds.municipio) : null,
      nombre_municipio: ds.nombre_municipio ? ds.nombre_municipio : null,
      nombre_provincia: ds.nombre_provincia ? ds.nombre_provincia : null,
      agregado: ds.agregado ? Number(ds.agregado) : null,
      zona: ds.zona ? Number(ds.zona) : null,
      poligono: ds.poligono ? Number(ds.poligono) : null,
      parcela: ds.parcela ? Number(ds.parcela) : null,
      recinto: ds.recinto ? Number(ds.recinto) : null,
    };

    solicitarRecinto(payload);
  };

  // -----------------------------------------
  // 5) Cargar recintos
  // -----------------------------------------
 function cargarRecintosSiProcede() {
  const z = map.getZoom();

  // Siempre limpiar primero
  if (z < ZOOM_RECINTOS || !recintosActivos) {
    recintosLayer.clearLayers();
    return;
  }

  const b = map.getBounds();
  const bbox = [
    b.getWest().toFixed(6),
    b.getSouth().toFixed(6),
    b.getEast().toFixed(6),
    b.getNorth().toFixed(6),
  ].join(",");

  console.log("Solicitando recintos para bbox:", bbox);

  fetch(`/api/recintos?bbox=${bbox}`)
    .then((response) => {
      if (!response.ok) {
        throw new Error("Respuesta no OK de /api/recintos");
      }
      return response.json();
    })
    .then((fc) => {
      console.log("Recintos recibidos:", fc && fc.features ? fc.features.length : 0);
      
      // Verificar de nuevo el zoom antes de añadir (por si cambió mientras esperábamos)
      if (map.getZoom() < ZOOM_RECINTOS) {
        recintosLayer.clearLayers();
        return;
      }
      
      // NUEVO: Guardar información del popup abierto antes de limpiar
      let popupAbiertoId = null;
      let popupEstiloSeleccionado = false;
      
      recintosLayer.eachLayer((layer) => {
        if (layer.isPopupOpen && layer.isPopupOpen()) {
          const props = layer.feature?.properties || {};
          popupAbiertoId = props.id_recinto;
          // Verificar si tiene el estilo de seleccionado
          popupEstiloSeleccionado = (selectedRecintoLayer === layer);
          console.log("Popup abierto detectado para recinto:", popupAbiertoId);
        }
      });
      
      recintosLayer.clearLayers();
      if (!fc || !fc.features || fc.features.length === 0) {
        return;
      }
      recintosLayer.addData(fc);
      
      // NUEVO: Reabrir el popup si estaba abierto
      if (popupAbiertoId) {
        recintosLayer.eachLayer((layer) => {
          const props = layer.feature?.properties || {};
          if (String(props.id_recinto) === String(popupAbiertoId)) {
            console.log("Reabriendo popup para recinto:", popupAbiertoId);
            
            // Restaurar el estilo de selección si lo tenía
            if (popupEstiloSeleccionado) {
              selectedRecintoLayer = layer;
              layer.setStyle(RECINTO_STYLE_SELECTED);
            }
            
            // Reabrir el popup con un pequeño delay
            setTimeout(() => {
              layer.openPopup();
            }, 50);
          }
        });
      }
    })
    .catch((err) => {
      console.error("Error al cargar recintos:", err);
    });
}

  // -----------------------------------------
  // 6) Actualizar mapa según zoom
  // -----------------------------------------
  function actualizarMapaSegunZoom() {
    const z = map.getZoom();
    const activeHighLayer = getActiveHighLayer();

    if (z >= ZOOM_RECINTOS) {
      if (map.hasLayer(baseOSM)) {
        map.removeLayer(baseOSM);
      }

      Object.values(highZoomLayers).forEach((layer) => {
        if (layer && layer !== activeHighLayer && map.hasLayer(layer)) {
          map.removeLayer(layer);
        }
      });

      if (activeHighLayer && !map.hasLayer(activeHighLayer)) {
        activeHighLayer.addTo(map);
      }
    } else {
      Object.values(highZoomLayers).forEach((layer) => {
        if (layer && map.hasLayer(layer)) {
          map.removeLayer(layer);
        }
      });

      if (!map.hasLayer(baseOSM)) {
        baseOSM.addTo(map);
      }

      recintosLayer.clearLayers();
    }
  }

  // -----------------------------------------
  // 7) Eventos del mapa
  // -----------------------------------------

  map.on("zoomend", () => {
    actualizarMapaSegunZoom();
    cargarRecintosSiProcede();
    cargarMisRecintosSiProcede();
    if (splitOpen && currentSideRecintoId) {
    guardarEstadoMapa();
  }
  });

  map.on("moveend", () => {
    cargarRecintosSiProcede();
    cargarMisRecintosSiProcede();
  });

  actualizarMapaSegunZoom();
  cargarRecintosSiProcede();
  cargarMisRecintosSiProcede();

  // -----------------------------------------
  // 8) Lógica del panel y botones sincronizados
  // -----------------------------------------
  const toggleBtn = document.getElementById("basemap-toggle");
  const panel = document.getElementById("basemap-panel");
  const basemapContainer = document.getElementById("basemap-panel-container");
  const filtroContainer = document.getElementById("filtro-container");

  toggleBtn.addEventListener("click", () => {
    const isOpening = !panel.classList.contains("visible");

    panel.classList.toggle("visible");
    toggleBtn.classList.toggle("active");

    // Desplazar ambos contenedores
    if (isOpening) {
      basemapContainer.classList.add("panel-open");
      filtroContainer.classList.add("panel-open");
    } else {
      basemapContainer.classList.remove("panel-open");
      filtroContainer.classList.remove("panel-open");
    }
  });

  // --- Selección de mapa principal ---
  document
    .querySelectorAll(".basemap-option.basemap-main[data-layer]")
    .forEach((option) => {
      if (option.classList.contains("disabled")) return;
      option.addEventListener("click", () => {
        const layerKey = option.dataset.layer;
        if (!highZoomLayers[layerKey]) {
          return;
        }

        document
          .querySelectorAll(".basemap-option.basemap-main")
          .forEach((el) => el.classList.remove("active"));
        option.classList.add("active");

        activeHighLayerKey = layerKey;
        actualizarMapaSegunZoom();
      });
    });

  // --- Toggle Recintos SigPac ---
  const recintosOption = document.querySelector(
    '.basemap-option.basemap-detail[data-detail="sigpac"]'
  );

  if (recintosOption) {
    recintosOption.addEventListener("click", () => {
      recintosActivos = !recintosActivos;

      if (recintosActivos) {
        recintosOption.classList.add("active");
        cargarRecintosSiProcede();
      } else {
        recintosOption.classList.remove("active");
        recintosLayer.clearLayers();
      }
    });
  }

  // --- Toggle MisRecintos ---
  const misRecintosOption = document.querySelector(
    '.basemap-option.basemap-detail[data-detail="mis"]'
  );

  if (misRecintosOption) {
    misRecintosOption.addEventListener("click", () => {
      misRecintosActivos = !misRecintosActivos;

      if (misRecintosActivos) {
        misRecintosOption.classList.add("active");
        cargarMisRecintosSiProcede();
      } else {
        misRecintosOption.classList.remove("active");
        misRecintosLayer.clearLayers();
      }
    });
  }


  // ============================================
  // CENTRAR EN RECINTO ESPECÍFICO
  // ============================================

  // Recibir datos del recinto específico desde Flask
  const recintoData = {{ recinto_data| tojson | safe if recinto_data else 'null' }};

  // Variable para guardar la capa del recinto resaltado
  let recintoResaltado = null;

  // Función para limpieza de capa roja
  function clearHighlight() {
    if (recintoResaltado) {
      try {
        map.removeLayer(recintoResaltado); // Quita la capa roja
      } catch (e) { }
      recintoResaltado = null;
    }
  }

  // Función para centrar en un recinto específico
  function centrarEnRecinto(data) {
    if (!data) return;

    // Limpiar cualquier resaltado previo
    clearHighlight();

    console.log('Centrando en recinto:', data);

    try {
      // Parsear el GeoJSON del recinto
      const geojson = JSON.parse(data.geojson);

      // Crear el FeatureCollection completo
      const featureCollection = {
        type: 'FeatureCollection',
        features: [{
          type: 'Feature',
          geometry: geojson,
          properties: {
            id_recinto: data.id,
            provincia: data.provincia,
            municipio: data.municipio,
            nombre_municipio: data.nombre_municipio,
            nombre_provincia: data.nombre_provincia,
            poligono: data.poligono,
            parcela: data.parcela,
            recinto: data.recinto,
            nombre: data.nombre,
            superficie_ha: data.superficie_ha,
            propietario: data.propietario
          }
        }]
      };

      // Función para abrir popup del recinto en la capa de recintos
      function openSigpacPopupForKey(key) {
        let targetLayer = null;

        recintosLayer.eachLayer((lyr) => {
          const p = (lyr.feature && lyr.feature.properties) || {};
          if (String(p.id_recinto) === String(key)) {
            targetLayer = lyr;
          }
        });

        if (targetLayer) {
          const p = (targetLayer.feature && targetLayer.feature.properties) || {};
          const esMio = MIS_IDS.has(String(key));

          // Si es mío: NO abrir popup ni aplicar estilo azul
          if (esMio) {
            if (selectedRecintoLayer) {
              selectedRecintoLayer.setStyle(RECINTO_STYLE_DEFAULT);
              selectedRecintoLayer = null;
            }
            return; // no abrir popup si es mío
          }

          // Si NO es mío: comportamiento normal (abrir popup "Añadir a mis recintos")
          if (selectedRecintoLayer && selectedRecintoLayer !== targetLayer) {
            selectedRecintoLayer.setStyle(RECINTO_STYLE_DEFAULT);
          }
          selectedRecintoLayer = targetLayer;
          targetLayer.setStyle(RECINTO_STYLE_SELECTED);
          targetLayer.openPopup();
        }
      }

      // Guardar la clave del recinto rojo
      const highlightKey = String(data.id);

      // Crear la geometría con Leaflet con estilo destacado
      recintoResaltado = L.geoJSON(featureCollection, {
        pane: 'highlightPane',
        style: {
          color: '#FF0000',
          weight: 4,
          fillColor: '#FF6B6B',
          fillOpacity: 0.3,
          dashArray: '10, 5'
        }
      }).addTo(map);
      // asegurar arriba del todo
      recintoResaltado.bringToFront();


      // Crear contenido del popup
      const popupContent = `
      <div class="popup-recinto" style="min-width: 250px;">
        <div class="popup-recinto-info" style="font-size: 0.9rem;">
          <strong>Provincia:</strong> ${data.provincia} - ${data.nombre_provincia}<br>
          <strong>Municipio:</strong> ${data.municipio} - ${data.nombre_municipio}<br>
          <strong>Polígono:</strong> ${data.poligono}<br>
          <strong>Parcela:</strong> ${data.parcela}<br>
          <strong>Recinto:</strong> ${data.recinto}<br>
          <strong>Superficie:</strong> ${data.superficie_ha.toFixed(2)} ha<br>
          <strong>Propietario:</strong> ${data.propietario}
        </div>
      </div>
    `;

      // Añadir popup
      recintoResaltado.bindPopup(popupContent, {
        maxWidth: 300,
        className: 'recinto-destacado-popup'
      });

      // Cerrar popup al hacer clic en el recinto rojo
      recintoResaltado.eachLayer((lyr) => {
        lyr.on('click', () => {
          try { lyr.closePopup(); } catch (e) { }
        });
      });


      // Obtener bounds del recinto
      const bounds = recintoResaltado.getBounds();

      // Calcular el zoom apropiado
      const zoom = map.getBoundsZoom(bounds, false);
      const targetZoom = Math.min(zoom, 18); // Máximo zoom 18

      // Primero hacer zoom para que se cargue la capa correcta
      map.setView(bounds.getCenter(), Math.max(targetZoom, ZOOM_RECINTOS));

      // Después de un momento, ajustar el bounds con padding
      setTimeout(() => {
        map.fitBounds(bounds, {
          padding: [80, 80],
          maxZoom: 18,
          animate: true,
          duration: 0.5
        });

        // Abrir el popup después del zoom
        setTimeout(() => {
          recintoResaltado.openPopup();
        }, 600);
      }, 300);

    } catch (error) {
      console.error('Error al centrar en el recinto:', error);

      // Fallback: usar el bbox si falla el GeoJSON
      if (data.bbox && data.bbox.length === 4) {
        const [minx, miny, maxx, maxy] = data.bbox;
        const bounds = [[miny, minx], [maxy, maxx]];

        map.setView(
          [(miny + maxy) / 2, (minx + maxx) / 2],
          Math.max(ZOOM_RECINTOS, 16)
        );

        setTimeout(() => {
          map.fitBounds(bounds, {
            padding: [80, 80],
            maxZoom: 18
          });
        }, 300);
      }
    }
  }

  // Si hay datos de recinto, centrar en él cuando el mapa esté listo
  if (recintoData) {
    console.log('Recinto específico detectado, preparando centrado...');

    // Esperar a que el mapa esté completamente cargado
    map.whenReady(function () {
      console.log('Mapa listo, centrando en recinto...');

      // Activar recintos si están desactivados
      if (!recintosActivos) {
        recintosActivos = true;
        const recintosOption = document.querySelector(
          '.basemap-option.basemap-detail[data-detail="sigpac"]'
        );
        if (recintosOption) {
          recintosOption.classList.add('active');
        }
      }

      // Pequeño delay para asegurar que todo esté inicializado
      setTimeout(() => {
        abrirRecintoDesdeVer(recintoData);
      }, 300);
    });
  }


if (recintoData) {
  const RecentrarControl = L.Control.extend({
    options: {
      position: 'bottomleft'
    },

    onAdd: function (map) {
      const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');

      // 👉 márgenes aquí
      container.style.marginBottom = '100px';
      container.style.marginLeft = '20px';

      const button = L.DomUtil.create('a', '', container);

      button.href = '#';
      button.title = 'Volver a centrar en el recinto';
      button.innerHTML = '<i class="bi bi-crosshair" style="font-size: 18px; line-height: 30px;"></i>';
      button.style.width = '30px';
      button.style.height = '30px';
      button.style.display = 'flex';
      button.style.alignItems = 'center';
      button.style.justifyContent = 'center';
      button.style.backgroundColor = 'white';
      button.style.textDecoration = 'none';
      button.style.color = '#333';

      L.DomEvent.on(button, 'click', function (e) {
        L.DomEvent.stopPropagation(e);
        L.DomEvent.preventDefault(e);
        centrarYAbrirPanelSiEsMio(recintoData);
      });

      return container;
    }
  });

  map.addControl(new RecentrarControl());
}


  const editarBtn = document.getElementById('editar-btn');
  const dibujarBtn = document.getElementById('dibujar-btn');
  const poligonoBtn = document.getElementById('poligono-btn');
  const aceptarBtn = document.getElementById('aceptar-btn');
  const cancelarBtn = document.getElementById('cancelar-btn');
  const limpiarBtn = document.getElementById('limpiar-btn');

  // FeatureGroup para guardar los elementos dibujados
  const drawnItems = new L.FeatureGroup();
  map.addLayer(drawnItems);

 let rectangleDrawer = null;
  let polygonDrawer = null;
  let dibujosTemporales = [];
  let modoEdicion = false;

  // Función para deshabilitar/habilitar interacción con recintos
  function toggleInteraccionRecintos(enabled) {
    if (enabled) {
      // Reactivar popups
      recintosLayer.eachLayer(layer => {
        if (layer._popup) layer.bindPopup(layer._popup);
      });
    } else {
      // Desactivar popups
      recintosLayer.eachLayer(layer => layer.unbindPopup());
    }
  }

  // Al hacer clic en editar
  editarBtn.addEventListener('click', () => {
    editarBtn.classList.add('hidden');
    dibujarBtn.classList.remove('hidden');
    poligonoBtn.classList.remove('hidden');
    aceptarBtn.classList.remove('hidden');
    cancelarBtn.classList.remove('hidden');
    limpiarBtn.classList.remove('hidden');

    // Activar modo edición y deshabilitar interacción con recintos
    modoEdicion = true;
    toggleInteraccionRecintos(false);

    // Guardar estado actual
    dibujosTemporales = [];
    drawnItems.eachLayer(layer => {
      dibujosTemporales.push(layer);
    });

    console.log('Modo edición activado');
  });

  // Al hacer clic en dibujar rectángulo
  dibujarBtn.addEventListener('click', () => {
    // Desactivar polígono si está activo
    if (polygonDrawer) {
      polygonDrawer.disable();
      polygonDrawer = null;
    }

    // Crear y activar el dibujador de rectángulos
    rectangleDrawer = new L.Draw.Rectangle(map);
    rectangleDrawer.enable();

    console.log('Modo dibujo de rectángulo activado');
  });

  // Al hacer clic en dibujar polígono
  poligonoBtn.addEventListener('click', () => {
    // Desactivar rectángulo si está activo
    if (rectangleDrawer) {
      rectangleDrawer.disable();
      rectangleDrawer = null;
    }

    // Crear y activar el dibujador de polígonos
    polygonDrawer = new L.Draw.Polygon(map);
    polygonDrawer.enable();

    console.log('Modo dibujo de polígono activado - Haz clic para añadir puntos, doble clic para terminar');
  });

  // Evento cuando se completa el dibujo
  map.on(L.Draw.Event.CREATED, (e) => {
    const layer = e.layer;
    drawnItems.addLayer(layer);
    console.log('Forma dibujada:', layer);
  });

  // Al hacer clic en aceptar
 // Al hacer clic en aceptar
  aceptarBtn.addEventListener('click', async () => {
    // Obtener todos los dibujos actuales
    const dibujos = [];
    
    drawnItems.eachLayer((layer) => {
      const geoJSON = layer.toGeoJSON();
      const tipo = layer instanceof L.Rectangle ? 'rectangulo' : 'poligono';
      
      dibujos.push({
        geojson: geoJSON,
        tipo: tipo
      });
    });

    // Si hay dibujos, enviarlos al backend
    if (dibujos.length > 0) {
      try {
        const response = await fetch('/api/guardar-dibujos', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ dibujos: dibujos })
        });

        const data = await response.json();
        NotificationSystem.show({
          type: "success",
          title: "Solicitud enviada",
          message: data.mensaje || "Dibujo/s creado/s correctamente"
        });
        
       
      } catch (error) {
        console.error('Error en la petición:', error);
      }
    }



    // Continúa con el código original
    dibujarBtn.classList.add('hidden');
    poligonoBtn.classList.add('hidden');
    aceptarBtn.classList.add('hidden');
    cancelarBtn.classList.add('hidden');
    limpiarBtn.classList.add('hidden');
    editarBtn.classList.remove('hidden');

    modoEdicion = false;
    toggleInteraccionRecintos(true);

    if (rectangleDrawer) {
      rectangleDrawer.disable();
      rectangleDrawer = null;
    }
    if (polygonDrawer) {
      polygonDrawer.disable();
      polygonDrawer = null;
    }

    console.log('Cambios guardados');
  });


  // Al hacer clic en cancelar
  cancelarBtn.addEventListener('click', () => {
    dibujarBtn.classList.add('hidden');
    poligonoBtn.classList.add('hidden');
    aceptarBtn.classList.add('hidden');
    cancelarBtn.classList.add('hidden');
    limpiarBtn.classList.add('hidden');
    editarBtn.classList.remove('hidden');

    // Desactivar modo edición y reactivar interacción
    modoEdicion = false;
    toggleInteraccionRecintos(true);

    // Desactiva ambos modos de dibujo
    if (rectangleDrawer) {
      rectangleDrawer.disable();
      rectangleDrawer = null;
    }
    if (polygonDrawer) {
      polygonDrawer.disable();
      polygonDrawer = null;
    }

    // Restaurar estado anterior (eliminar dibujos nuevos)
    drawnItems.clearLayers();
    dibujosTemporales.forEach(layer => {
      drawnItems.addLayer(layer);
    });

    console.log('Edición cancelada');
  });

  // Al hacer clic en limpiar
  limpiarBtn.addEventListener('click', () => {
    // Eliminar todos los dibujos
    drawnItems.clearLayers();
  });
 


  actualizarMapaSegunZoom();
    cargarRecintosSiProcede();
    cargarMisRecintosSiProcede();

    // Intentar restaurar el estado guardado
    map.whenReady(async function () {
      if (!recintoData) {
        await restaurarEstadoMapa();
      }
    });









const dibujosToggle = document.getElementById('dibujos-toggle');
const dibujosPanel = document.getElementById('dibujos-panel');
const dibujosList = document.getElementById('dibujos-list');
const dibujosCount = document.getElementById('dibujos-count');
const refrescarDibujosBtn = document.getElementById('refrescar-dibujos');

// FeatureGroup para los dibujos guardados
const dibujosGuardadosLayer = new L.FeatureGroup();
map.addLayer(dibujosGuardadosLayer);

// Toggle panel
dibujosToggle.addEventListener('click', () => {
  dibujosPanel.classList.toggle('hidden');
});



// Función para formatear fecha
function formatearFechaDibujo(fechaISO) {
  const fecha = new Date(fechaISO);
  const ahora = new Date();
  const diff = ahora - fecha;
  const dias = Math.floor(diff / (1000 * 60 * 60 * 24));
  
  if (dias === 0) return 'Hoy';
  if (dias === 1) return 'Ayer';
  if (dias < 7) return `Hace ${dias} días`;
  
  return fecha.toLocaleDateString('es-ES', { 
    day: '2-digit', 
    month: '2-digit', 
    year: 'numeric' 
  });
}

let dibujoVisibleId = null;

// Función para cargar dibujos guardados
async function cargarDibujosGuardados() {
  try {
    const response = await fetch('/api/obtener-dibujos');
    const data = await response.json();
    
    if (!response.ok) {
      console.error('Error al obtener dibujos:', data.error);
      return;
    }
    
    const dibujos = data.dibujos || [];
    
    // Actualizar contador
    dibujosCount.textContent = dibujos.length;
    dibujosCount.style.display = dibujos.length > 0 ? 'block' : 'none';
    
    // Limpiar lista y capa
    dibujosList.innerHTML = '';
    dibujosGuardadosLayer.clearLayers();
    dibujoVisibleId = null;
    
    if (dibujos.length === 0) {
      dibujosList.innerHTML = `
        <div class="dibujos-empty">
          <i class="bi bi-bookmark" style="font-size:48px;opacity:0.3;"></i>
          <p style="margin:16px 0 0 0;font-size:14px;">No hay dibujos guardados</p>
        </div>
      `;
      return;
    }
    
    // Header con botón mostrar/ocultar todos
    const headerActions = document.createElement('div');
    headerActions.className = 'dibujos-list-header';
    headerActions.innerHTML = `
      <button class="dibujo-btn-toggle-all" id="toggle-all-dibujos">
        <i class="bi bi-eye-fill"></i> Mostrar todos
      </button>
    `;
    dibujosList.appendChild(headerActions);
    
    let todosVisibles = false;
    
    // Renderizar cada dibujo
    dibujos.forEach((dibujo, index) => {
      const geojson = typeof dibujo.geojson === 'string' 
        ? JSON.parse(dibujo.geojson) 
        : dibujo.geojson;
      
      const item = document.createElement('div');
      item.className = 'dibujo-item';
      item.dataset.dibujoId = dibujo.id;
      
      const colors = [
        '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A',
        '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E2',
        '#F8B739', '#52B788', '#EF476F', '#06D6A0', 
        '#118AB2', '#FFD166', '#8338EC', '#3A86FF', 
        '#FFBE0B', '#FB5607', '#2EC4B6', '#90DBF4'
      ];

      const color = colors[index % colors.length];
      
      item.innerHTML = `
        <div class="dibujo-content">
          <div class="dibujo-color" style="background-color: ${color};"></div>
          
          <div class="dibujo-info">
            <div class="dibujo-ndvi-compact">
              <div class="ndvi-compact-item">
                <span class="ndvi-label">Máx</span>
                <span class="ndvi-value">${dibujo.ndvi_max?.toFixed(2) || '-'}</span>
              </div>
              <div class="ndvi-compact-item">
                <span class="ndvi-label">Min</span>
                <span class="ndvi-value">${dibujo.ndvi_min?.toFixed(2) || '-'}</span>
              </div>
              <div class="ndvi-compact-item">
                <span class="ndvi-label">Med</span>
                <span class="ndvi-value">${dibujo.ndvi_medio?.toFixed(2) || '-'}</span>
              </div>
            </div>
            
            ${dibujo.area_m2 ? `
              <div class="dibujo-area">
                ${(dibujo.area_m2 / 10000).toFixed(2)} ha
              </div>
            ` : ''}
          </div>
          
          <div class="dibujo-actions-compact">
            <button class="dibujo-btn-icon delete-btn" data-id="${dibujo.id}" title="Eliminar">
              <i class="bi bi-trash-fill"></i>
            </button>
          </div>
        </div>
      `;
      
      dibujosList.appendChild(item);
      
      // Añadir geometría al mapa con el color correspondiente
      const layer = L.geoJSON(geojson, {
        style: {
          color: color,
          weight: 5,
          opacity: 0,
          fillColor: color,
          fillOpacity: 0
        },
        // CRÍTICO: Evitar que los eventos se propaguen a capas inferiores
        bubblingMouseEvents: false,
        pane: 'highlightPane', // Usar el pane de mayor z-index
        interactive: false // Inicialmente no interactivo porque está oculto
      });
      
      layer.dibujoId = dibujo.id;
      layer.dibujoColor = color;
      layer.colorOriginal = color;
      
      // Crear contenido del popup COMPACTO
      const popupContent = `
        <div style="font-family: inherit; min-width: 180px;">
          <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 8px; padding-bottom: 6px; border-bottom: 2px solid ${color};">
            <div style="width: 4px; height: 20px; background: ${color}; border-radius: 2px;"></div>
            <h6 style="margin: 0; font-size: 13px; font-weight: 700; color: #333;">Dibujo</h6>
          </div>
          
          <div style="display: flex; gap: 8px; margin-bottom: 6px;">
            <div style="flex: 1; background: #f8f9fa; padding: 6px; border-radius: 6px; text-align: center;">
              <div style="font-size: 9px; color: #666; font-weight: 600;">MAX</div>
              <div style="font-size: 14px; font-weight: 700; color: #198754;">${dibujo.ndvi_max?.toFixed(2) || '-'}</div>
            </div>
            <div style="flex: 1; background: #f8f9fa; padding: 6px; border-radius: 6px; text-align: center;">
              <div style="font-size: 9px; color: #666; font-weight: 600;">MIN</div>
              <div style="font-size: 14px; font-weight: 700; color: #198754;">${dibujo.ndvi_min?.toFixed(2) || '-'}</div>
            </div>
            <div style="flex: 1; background: #f8f9fa; padding: 6px; border-radius: 6px; text-align: center;">
              <div style="font-size: 9px; color: #666; font-weight: 600;">MED</div>
              <div style="font-size: 14px; font-weight: 700; color: #198754;">${dibujo.ndvi_medio?.toFixed(2) || '-'}</div>
            </div>
          </div>
          
          ${dibujo.area_m2 ? `
            <div style="background: #e7f5ff; padding: 6px; border-radius: 6px; text-align: center;">
              <span style="font-size: 14px; font-weight: 700; color: #1976d2;">${(dibujo.area_m2 / 10000).toFixed(2)} ha</span>
              <span style="font-size: 10px; color: #666; margin-left: 4px;">(${dibujo.area_m2.toFixed(0)} m²)</span>
            </div>
          ` : ''}
        </div>
      `;
      
      // Hacer la capa interactiva con popup
      layer.eachLayer(function(l) {
        l.dibujoId = dibujo.id;
        l.isDibujoGuardado = true;
        
        // NUEVO: Configurar para que no burbujeen los eventos
        l.options.bubblingMouseEvents = false;
        l.options.interactive = false; // Inicialmente no interactivo
        
        if (l.setStyle) {
          l.setStyle({ className: 'dibujo-clickeable' });
        }
        
        // Añadir popup
        l.bindPopup(popupContent, {
          maxWidth: 250,
          className: 'dibujo-popup',
          autoPan: true
        });
        
        // Click handler - solo abrir popup, sin cambiar visibilidad
        l.on('click', function(e) {
          // Prevenir propagación
          if (e && e.originalEvent) {
            e.originalEvent._stopped = true;
          }
          
          // Solo abrir popup si el dibujo está visible
          const currentStyle = this.options;
          if (currentStyle.opacity > 0 && currentStyle.interactive) {
            this.openPopup();
          }
          
          return false;
        }, null, true);
        
        // Efectos hover - SOLO si el dibujo está visible
        l.on('mouseover', function(e) {
          const currentOpacity = this.options.opacity || 0;
          
          // Solo aplicar hover si está visible E interactivo
          if (currentOpacity > 0 && this.options.interactive && this.setStyle) {
            const currentWeight = this.options.weight || 3;
            const currentFill = this.options.fillOpacity || 0.3;
            
            this.setStyle({ 
              weight: currentWeight + 2, 
              fillOpacity: Math.min(currentFill + 0.1, 0.5)
            });
          }
          return false;
        });
        
        l.on('mouseout', function(e) {
          const currentOpacity = this.options.opacity || 0;
          
          // Solo resetear hover si está visible E interactivo
          if (currentOpacity > 0 && this.options.interactive && this.setStyle) {
            const isActive = dibujoVisibleId === dibujo.id;
            this.setStyle({ 
              weight: isActive ? 4 : 3,
              fillOpacity: isActive ? 0.35 : 0.3
            });
          }
          return false;
        });
      });
      
      dibujosGuardadosLayer.addLayer(layer);
      
      // Evento eliminar
      item.querySelector('.delete-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        eliminarDibujo(dibujo.id);
      });
      
      // Click en el item para toggle visibilidad (solo uno a la vez)
      item.addEventListener('click', () => {
  // Verificar si "mostrar todos" está activo
  const btnToggleAll = document.getElementById('toggle-all-dibujos');
  const mostrandoTodos = btnToggleAll && btnToggleAll.textContent.includes('Ocultar todos');
  
  if (mostrandoTodos) {
    // Si están todos visibles, solo resaltar sin ocultar los demás
    resaltarDibujoSinOcultar(dibujo.id, item);
  } else {
    // Si no están todos visibles, comportamiento normal (mostrar solo uno)
    resaltarDibujo(dibujo.id, item);
  }
});
    });
    

    // Añade esta función ANTES de la función "resaltarDibujo":
// Busca la función resaltarDibujoSinOcultar y reemplázala completamente por esta:
function resaltarDibujoSinOcultar(id, itemElement) {
  // Quitar clase active de todos los items
  document.querySelectorAll('.dibujo-item').forEach(item => {
    item.classList.remove('active');
  });
  
  // Añadir clase active al item seleccionado
  itemElement.classList.add('active');
  dibujoVisibleId = id;
  
  // Mantener todos visibles pero resaltar el seleccionado
  dibujosGuardadosLayer.eachLayer(layer => {
    if (layer.dibujoId === id) {
      // Resaltar este con máxima visibilidad
      layer.setStyle({ 
        opacity: 1,
        fillOpacity: 0.45,
        weight: 5
      });
      
      // Activar interactividad
      layer.eachLayer(l => {
        l.options.interactive = true;
        if (l._path) {
          l._path.style.pointerEvents = 'auto';
        }
      });
      
      // Hacer zoom
      map.fitBounds(layer.getBounds(), {
        padding: [50, 50],
        maxZoom: 16
      });
      
      // Abrir popup automáticamente
      setTimeout(() => {
        layer.eachLayer(l => {
          if (l.getPopup) {
            l.openPopup();
          }
        });
      }, 300);
      
    } else {
      // Mantener visibles los demás pero con opacidad original (0.9)
      layer.setStyle({ 
        opacity: 0.9,
        fillOpacity: 0.3,
        weight: 3
      });
      
      // Mantener interactividad de todos
      layer.eachLayer(l => {
        l.options.interactive = true;
        if (l._path) {
          l._path.style.pointerEvents = 'auto';
        }
      });
    }
  });
}
    // Toggle todos
    const toggleAllBtn = document.getElementById('toggle-all-dibujos');
    if (toggleAllBtn) {
      toggleAllBtn.addEventListener('click', function() {
        todosVisibles = !todosVisibles;
        
        // Quitar el activo individual
        dibujoVisibleId = null;
        document.querySelectorAll('.dibujo-item').forEach(item => {
          item.classList.remove('active');
        });
        
        dibujosGuardadosLayer.eachLayer(layer => {
          if (todosVisibles) {
            // Mostrar todos
            layer.setStyle({ 
              opacity: 0.9,
              fillOpacity: 0.3
            });
            
            // CRÍTICO: Activar interactividad para todos
            layer.eachLayer(l => {
              l.options.interactive = true;
              if (l._path) {
                l._path.style.pointerEvents = 'auto';
              }
            });
          } else {

  map.closePopup();

  // Ocultar todos
  layer.setStyle({ 
    opacity: 0, 
    fillOpacity: 0 
  });

  // Desactivar interactividad
  layer.eachLayer(l => {
    l.options.interactive = false;
    if (l._path) {
      l._path.style.pointerEvents = 'none';
    }
  });
}
        });
        
        this.innerHTML = todosVisibles 
          ? '<i class="bi bi-eye-slash-fill"></i> Ocultar todos'
          : '<i class="bi bi-eye-fill"></i> Mostrar todos';
      });
    }
    
  } catch (error) {
    console.error('Error al cargar dibujos:', error);
  }
}

// Resaltar dibujo al hacer click en la lista (sin ocultarlo)
function resaltarDibujo(id, itemElement) {
  // Quitar clase active de todos los items
  document.querySelectorAll('.dibujo-item').forEach(item => {
    item.classList.remove('active');
  });
  
  // Añadir clase active al item seleccionado
  itemElement.classList.add('active');
  dibujoVisibleId = id;
  
  // OCULTAR TODOS primero, luego mostrar solo el seleccionado
  dibujosGuardadosLayer.eachLayer(layer => {
    if (layer.dibujoId === id) {
      // Mostrar solo este con máxima visibilidad Y hacerlo interactivo
      layer.setStyle({ 
        opacity: 1,
        fillOpacity: 0.45,
        weight: 5
      });
      
      // CRÍTICO: Activar interactividad
      layer.eachLayer(l => {
        l.options.interactive = true;
        if (l._path) {
          l._path.style.pointerEvents = 'auto';
        }
      });
      
      // Hacer zoom
      map.fitBounds(layer.getBounds(), {
        padding: [50, 50],
        maxZoom: 16
      });
      
      // Abrir popup automáticamente
      setTimeout(() => {
        layer.eachLayer(l => {
          if (l.getPopup) {
            l.openPopup();
          }
        });
      }, 300);
      
    } else {
  // Mantener visibles los demás, pero atenuados
  layer.setStyle({ 
    opacity: 0.4,
    fillOpacity: 0.15,
    weight: 3
  });

  // Siguen siendo interactivos si quieres
  layer.eachLayer(l => {
    l.options.interactive = true;
    if (l._path) {
      l._path.style.pointerEvents = 'auto';
    }
  });
}
  });
}

// Toggle al hacer click (mantener por compatibilidad pero ya no se usa mucho)
function toggleDibujoClick(id, itemElement) {
  const wasVisible = (dibujoVisibleId === id);
  
  // Quitar clase active de todos los items
  document.querySelectorAll('.dibujo-item').forEach(item => {
    item.classList.remove('active');
  });
  
  // Ocultar todos los dibujos
  dibujosGuardadosLayer.eachLayer(layer => {
    layer.setStyle({ opacity: 0, fillOpacity: 0 });
  });
  
  if (wasVisible) {
    // Si ya estaba visible, ocultarlo
    dibujoVisibleId = null;
  } else {
    // Mostrar solo este con mayor visibilidad
    dibujoVisibleId = id;
    itemElement.classList.add('active');
    
    dibujosGuardadosLayer.eachLayer(layer => {
      if (layer.dibujoId === id) {
        layer.setStyle({ 
          opacity: 1,           // Aumentado de 0.8 a 1
          fillOpacity: 0.35,    // Aumentado de 0.25 a 0.35
          weight: 4             // Aumentado de 3 a 4
        });
        
        // Hacer zoom
        map.fitBounds(layer.getBounds(), {
          padding: [50, 50],
          maxZoom: 16
        });
      }
    });
  }
}

// Eliminar dibujo
window.eliminarDibujo = async function(id) {

  const ok = await AppConfirm.open({
    title: "Eliminar dibujo",
    message: "¿Estás seguro de que deseas eliminar este dibujo?",
    okText: "Eliminar",
    cancelText: "Cancelar",
    okClass: "btn-danger"
  });

  if (!ok) return;

  try {
    const response = await fetch(`/api/eliminar-dibujo/${id}`, {
      method: 'DELETE'
    });

    if (response.ok) {

      // Limpiar estado si estaba visible
      if (dibujoVisibleId === id) {
        dibujoVisibleId = null;
        map.closePopup();
      }

      cargarDibujosGuardados();

      // ✅ NOTIFICACIÓN
      NotificationSystem.show({
        type: "success",
        title: "Dibujo eliminado",
        message: "El dibujo se eliminó correctamente"
      });

    } else {
      alert('Error al eliminar');
    }

  } catch (error) {
    console.error('Error:', error);
  }
};

// Cargar al inicio
cargarDibujosGuardados();

// CORRECCIÓN PRINCIPAL: Recargar después de guardar con limpieza de estado
if (typeof aceptarBtn !== 'undefined') {
  const originalClickHandler = aceptarBtn.onclick;
  
  aceptarBtn.addEventListener('click', function(e) {
    // Ejecutar el handler original si existe
    if (originalClickHandler) {
      originalClickHandler.call(this, e);
    }
    
    // Recargar dibujos después de un delay
    setTimeout(() => {
      cargarDibujosGuardados();
      
      // CRÍTICO: Limpiar el estado del modo de dibujo
      if (typeof drawnItems !== 'undefined') {
        drawnItems.clearLayers();
      }
      
      // Resetear variables globales si existen
      if (typeof currentLayer !== 'undefined') {
        currentLayer = null;
      }
      
      // Deshabilitar herramientas de dibujo activas
      if (typeof drawControl !== 'undefined' && map.hasLayer(drawControl)) {
        map.removeControl(drawControl);
        // Volver a añadir el control limpio
        if (typeof L.Control.Draw !== 'undefined') {
          map.addControl(drawControl);
        }
      }
      
      // NUEVO: Activar automáticamente "mostrar todos" después de guardar
      setTimeout(() => {
        const btnToggleAll = document.getElementById('toggle-all-dibujos');
        if (btnToggleAll && btnToggleAll.textContent.includes('Mostrar todos')) {
          btnToggleAll.click();
        }
      }, 100);
    }, 1000);
  });
}

// NUEVO: Hacer los dibujos guardados clickeables en el mapa
// Ahora con prevención de conflictos con recintos
dibujosGuardadosLayer.on('click', function(e) {
  // Solo procesar si realmente se hizo clic en un dibujo guardado
  if (!e.layer || !e.layer.isDibujoGuardado) return;
  
  const clickedLayer = e.layer;
  const dibujoId = clickedLayer.dibujoId;
  
  if (dibujoId) {
    // Encontrar el item correspondiente en la lista
    const item = document.querySelector(`.dibujo-item[data-dibujo-id="${dibujoId}"]`);
    if (item) {
      // Hacer scroll al item en la lista
      item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      
      // Resaltar el dibujo
      resaltarDibujo(dibujoId, item);
    }
  }
});



  });
</script>

{% endblock %}