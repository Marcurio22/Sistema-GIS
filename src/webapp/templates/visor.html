{% extends "base.html" %}

{% block content %}
<div class="container-fluid mt-3">
  <div class="row">
    <div class="col-12">
      <h2>Visor SIG</h2>
      <div id="map" style="height: 600px;"></div>
    </div>
  </div>
</div>

<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const map = L.map("map").setView([41.9, -4.2], 11);  // centro aproximado ROI

    // Fondo base
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap contributors",
      maxZoom: 19
    }).addTo(map);

    // Cuando el mapa termine de mover/zoom, pedimos recintos al backend
    function cargarRecintos() {
      const b = map.getBounds();
      const minx = b.getWest();
      const miny = b.getSouth();
      const maxx = b.getEast();
      const maxy = b.getNorth();

      const bbox = `${minx},${miny},${maxx},${maxy}`;

      const url = "{{ url_for('api.recintos') }}" + "?bbox=" + encodeURIComponent(bbox);

      fetch(url)
        .then(r => r.json())
        .then(geojson => {
          if (window.recintosLayer) {
            map.removeLayer(window.recintosLayer);
          }
          window.recintosLayer = L.geoJSON(geojson, {
            style: {
              color: "red",
              weight: 1
            }
          }).addTo(map);
        })
        .catch(err => console.error("Error al cargar recintos:", err));
    }

    map.on("moveend", cargarRecintos);
    cargarRecintos();  // primera carga
  });
</script>
{% endblock %}
