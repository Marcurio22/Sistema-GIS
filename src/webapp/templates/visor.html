{% extends "base.html" %}

{% block title %}Visor SIG{% endblock %}

{% block navbar_extra %}
<div class="d-flex align-items-center gap-3 bg-white rounded-3 px-3 py-2 shadow-sm">
  <!-- Temperatura principal -->
  <div class="d-flex align-items-center">
    <i class="bi bi-{{ weather.icono }} {{ weather.color_icono }}" style="font-size: 1.5rem;"></i>
    <span class="ms-2 fw-bold fs-5 text-dark">{{ weather.temperatura }}°</span>
  </div>

  <!-- Separador -->
  <div class="vr opacity-50"></div>

  <!-- Datos compactos -->
  <div class="d-none d-md-flex gap-3 small text-dark">
    {% if weather.humedad %}
    <div class="d-flex align-items-center">
      <i class="bi bi-droplet-fill text-info me-1"></i>
      <span>{{ weather.humedad }}%</span>
    </div>
    {% endif %}

    {% if weather.viento_velocidad %}
    <div class="d-flex align-items-center">
      <i class="bi bi-wind text-secondary me-1"></i>
      <span>{{ weather.viento_velocidad }} km/h</span>
    </div>
    {% endif %}

    {% if weather.prob_precipitacion %}
    <div class="d-flex align-items-center">
      <i class="bi bi-cloud-rain text-primary me-1"></i>
      <span>{{ weather.prob_precipitacion }}%</span>
    </div>
    {% endif %}
  </div>

  <!-- Ubicación (solo en pantallas grandes) -->
  <div class="d-none d-lg-block text-muted small">
    <i class="bi bi-geo-alt-fill"></i> {{ weather.municipio }}
  </div>
</div>
{% endblock %}

{% block content %}

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

<style>
  /* El mapa ocupa toda la ventana menos la barra verde superior */
  html,
  body {
    height: 100%;
  }

  #map {
    position: fixed;
    top: 65px;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1;
  }

  /* ---------- Contenedores de botones ---------- */
  #basemap-panel-container,
  #filtro-container {
    position: fixed;
    z-index: 1000;
    font-family: inherit;
    transition: right 0.25s ease-out;
  }

  #basemap-panel-container {
    top: 80px;
    right: 20px;
  }

  #filtro-container {
    top: 150px;
    right: 20px;
  }

  /* Cuando el panel de capas está abierto, ambos contenedores se desplazan */
  #basemap-panel-container.panel-open,
  #filtro-container.panel-open {
    right: 530px;
    /* 20px + 420px (ancho panel) + 12px (margen) */
  }

  /* ---------- Botones flotantes ---------- */
  #basemap-toggle,
  #filtro-toggle {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    border: none;
    background-color: #198754;
    color: #ffffff;
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.35);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition:
      background-color 0.2s ease,
      transform 0.16s ease-out,
      box-shadow 0.2s ease;
  }

  #basemap-toggle i,
  #filtro-toggle i {
    font-size: 22px;
  }

  #basemap-toggle:not(.active),
  #filtro-toggle:not(.active) {
    background-color: #ffffff;
    color: #198754;
  }

  #basemap-toggle:hover,
  #filtro-toggle:hover {
    transform: translateY(-1px) scale(1.04);
    box-shadow: 0 10px 22px rgba(0, 0, 0, 0.35);
  }

  #basemap-toggle:active,
  #filtro-toggle:active {
    transform: scale(0.96);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.35);
  }

  #basemap-toggle.active,
  #filtro-toggle.active {
    background-color: #198754;
    color: #ffffff;
  }

  /* ---------- Panel ---------- */
  #basemap-panel {
    position: fixed;
    top: 80px;
    right: 20px;
    width: 420px;
    max-height: 75vh;
    background-color: #ffffff;
    box-shadow:
      0 10px 30px rgba(15, 23, 42, 0.35),
      0 1px 0 rgba(255, 255, 255, 0.5);
    border-radius: 18px;
    padding: 16px 20px 20px;
    overflow: hidden;
    opacity: 0;
    transform: translateX(100%) translateY(-8px);
    pointer-events: none;
    transition:
      transform 0.25s ease-out,
      opacity 0.22s ease-out;
    z-index: 999;
  }

  #basemap-panel.visible {
    opacity: 1;
    transform: translateX(-80px) translateY(0);
    pointer-events: auto;
  }

  #basemap-panel h6 {
    font-size: 1.15rem;
    font-weight: 700;
    margin-top: 10px;
    margin-bottom: 10px;
  }

  .basemap-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 14px;
    margin-bottom: 14px;
  }

  .basemap-option {
    width: 100%;
    cursor: pointer;
    text-align: center;
    font-size: 0.95rem;
    color: #333;
    transition:
      transform 0.18s ease-out,
      box-shadow 0.18s ease-out;
  }

  .basemap-thumb {
    width: 100%;
    height: 115px;
    border-radius: 12px;
    border: 3px solid transparent;
    overflow: hidden;
    background-size: cover;
    background-position: center;
    margin-bottom: 6px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.20);
    transition:
      border-color 0.18s ease-out,
      box-shadow 0.18s ease-out,
      transform 0.18s ease-out;
  }

  .basemap-thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .basemap-option-label {
    line-height: 1.25;
    font-size: 0.9rem;
    font-weight: 500;
  }

  .basemap-option:not(.disabled):hover .basemap-thumb {
    transform: translateY(-2px);
    box-shadow: 0 6px 14px rgba(0, 0, 0, 0.25);
  }

  .basemap-option:not(.disabled):hover {
    transform: translateY(-2px);
  }

  .basemap-option.active .basemap-thumb {
    border-color: #198754;
  }

  .basemap-option.disabled {
    opacity: 0.45;
    cursor: default;
    pointer-events: none;
  }

  /* --------- Responsive: móviles / pantallas pequeñas ---------- */
  @media (max-width: 576px) {

    #basemap-panel-container,
    #filtro-container {
      right: 10px;
    }

    #basemap-panel-container.panel-open,
    #filtro-container.panel-open {
      right: 10px;
    }

    #basemap-panel {
      width: calc(100vw - 20px);
      right: 10px;
    }

    #basemap-panel.visible {
      transform: translateX(0) translateY(0);
    }

    .basemap-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }
</style>

<div id="map"></div>

<!-- Botón de capas -->
<div id="basemap-panel-container">
  <button id="basemap-toggle" title="Capas">
    <i class="bi bi-layers-fill"></i>
  </button>
</div>

<!-- Panel de capas -->
<div id="basemap-panel">
  <h6>Mapa Principal</h6>
  <div class="basemap-grid">
    <div class="basemap-option basemap-main active" data-layer="satellite">
      <div class="basemap-thumb">
        <img src="{{ url_for('static', filename='img/thumb_satellite.png') }}" alt="Imagen satélite" />
      </div>
      <div class="basemap-option-label">Imagen<br>Satelital</div>
    </div>

    <div class="basemap-option basemap-main" data-layer="ndvi">
      <div class="basemap-thumb">
        <img src="{{ url_for('static', filename='img/thumb_ndvi.png') }}" alt="Vigor Vegetal (NDVI)" />
      </div>
      <div class="basemap-option-label">Vigor Vegetal<br>(NDVI)</div>
    </div>

    <div class="basemap-option disabled">
      <div class="basemap-thumb">
        <img src="{{ url_for('static', filename='img/thumb_etp.png') }}" alt="ETP" />
      </div>
      <div class="basemap-option-label">ETP</div>
    </div>
  </div>

  <h6>Nivel de Detalle</h6>
  <div class="basemap-grid">
    <div class="basemap-option disabled">
      <div class="basemap-thumb">
        <img src="{{ url_for('static', filename='img/thumb_recintos.png') }}" alt="Mis recintos" />
      </div>
      <div class="basemap-option-label">Mis recintos</div>
    </div>

    <div class="basemap-option basemap-detail active" data-detail="sigpac">
      <div class="basemap-thumb">
        <img src="{{ url_for('static', filename='img/thumb_recintos.png') }}" alt="Recintos SigPac" />
      </div>
      <div class="basemap-option-label">Recintos SigPac</div>
    </div>

    <div class="basemap-option disabled">
      <div class="basemap-thumb">
        <img src="{{ url_for('static', filename='img/thumb_calculadas.png') }}" alt="recintos Calculadas" />
      </div>
      <div class="basemap-option-label">recintos<br>Calculadas</div>
    </div>
  </div>
</div>

<!-- Botón de filtros -->
<div id="filtro-container">
  <button id="filtro-toggle" title="Filtros">
    <i class="bi bi-funnel-fill"></i>
  </button>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // -----------------------------------------
    // 1) ROI desde Flask
    // -----------------------------------------
    const roiBbox = [
      {{ roi_bbox[0] }},
    {{ roi_bbox[1] }},
    {{ roi_bbox[2] }},
    {{ roi_bbox[3] }}
    ];

  const ROI_BOUNDS = L.latLngBounds(
    [roiBbox[1], roiBbox[0]],
    [roiBbox[3], roiBbox[2]]
  );

  const ZOOM_RECINTOS = 15;

  // -----------------------------------------
  // 2) Crear mapa
  // -----------------------------------------
  const map = L.map("map", {
    maxBounds: ROI_BOUNDS,
    maxBoundsViscosity: 1.0,
    zoomControl: true,
  });

  map.fitBounds(ROI_BOUNDS);

  // -----------------------------------------
  // 3) Capas base
  // -----------------------------------------
  const baseOSM = L.tileLayer(
    "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
    {
      attribution: "&copy; OpenStreetMap contributors",
      minZoom: 8,
      maxZoom: 19,
    }
  ).addTo(map);

  const baseSat = L.tileLayer(
    "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
    {
      attribution: "Tiles &copy; Esri",
      minZoom: 8,
      maxZoom: 19,
    }
  );

  const baseNdvi = L.imageOverlay(
    "/static/ndvi/ndvi_latest.png",
    ROI_BOUNDS,
    { opacity: 1.0 }
  );

  const highZoomLayers = {
    satellite: baseSat,
    ndvi: baseNdvi
  };

  let activeHighLayerKey = "satellite";
  function getActiveHighLayer() {
    return highZoomLayers[activeHighLayerKey];
  }

  // -----------------------------------------
  // 4) Capa de recintos
  // -----------------------------------------

  const RECINTO_STYLE_DEFAULT = {
    color: "#ff8800",
    weight: 1,
  };

  const RECINTO_STYLE_SELECTED = {
    color: "#0077ff",
    weight: 2,
    fillOpacity: 0.25,
  };

  let selectedRecintoLayer = null;

  const recintosLayer = L.geoJSON(null, {
    style: function () {
      return RECINTO_STYLE_DEFAULT;
    },
    onEachFeature: function (feature, layer) {
      const p = feature.properties || {};

      // Propietario: username o "N/A"
      const propietarioTexto =
        p.propietario && String(p.propietario).trim() !== ""
          ? p.propietario
          : "N/A";

      const tienePropietario = propietarioTexto !== "N/A";
      const disabledAttr = tienePropietario ? "disabled" : "";
      const disabledStyle = tienePropietario
        ? "opacity: 0.5; cursor: not-allowed;"
        : "";

      const html = `
        <div class="popup-recinto">
          <div class="popup-recinto-info">
            <strong>Provincia:</strong> ${p.provincia ?? "-"}<br>
            <strong>Municipio:</strong> ${p.municipio ?? "-"}<br>
            <strong>Polígono:</strong> ${p.poligono ?? "-"}<br>
            <strong>Parcela:</strong> ${p.parcela ?? "-"}<br>
            <strong>Recinto:</strong> ${p.recinto ?? "-"}<br>
            <strong>Propietario:</strong> ${propietarioTexto}
          </div>
          <div style="margin-top: 10px; text-align: right;">
            <button
              type="button"
              class="btn-add-recinto"
              data-id-recinto="${p.id_recinto ?? ""}"
              data-provincia="${p.provincia ?? ""}"
              data-municipio="${p.municipio ?? ""}"
              data-agregado="${p.agregado ?? ""}"
              data-zona="${p.zona ?? ""}"
              data-poligono="${p.poligono ?? ""}"
              data-recinto="${p.recinto ?? ""}"
              ${disabledAttr}
              style="
                padding: 6px 10px;
                font-size: 0.85rem;
                border-radius: 999px;
                border: none;
                background-color: #198754;
                color: white;
                cursor: pointer;
                ${disabledStyle}
              "
              onclick="window._solicitarrecintoDesdePopup(this)"
            >
              Añadir a mis recintos
            </button>
          </div>
        </div>
      `;

      layer.bindPopup(html);

      // Marcar visualmente la selección
      layer.on("click", function () {
        if (selectedRecintoLayer && selectedRecintoLayer !== layer) {
          selectedRecintoLayer.setStyle(RECINTO_STYLE_DEFAULT);
        }
        selectedRecintoLayer = layer;
        layer.setStyle(RECINTO_STYLE_SELECTED);
        layer.openPopup();
      });
    },
  }).addTo(map);

  // *** Recintos activos por defecto ***
  let recintosActivos = true;

  // Función auxiliar para llamar a la API de solicitudes
  function solicitarrecinto(payload) {
    fetch("/api/solicitudes-recinto", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(payload),
    })
      .then((response) => response.json().catch(() => ({})))
      .then((data) => {
        if (data && data.ok) {
          alert("Solicitud enviada al administrador.");
        } else {
          const msg =
            (data && data.error) ||
            "No se ha podido crear la solicitud. ¿Estás identificado?";
          alert(msg);
        }
      })
      .catch((err) => {
        console.error("Error al crear la solicitud de recinto:", err);
        alert("Error de comunicación con el servidor.");
      });
    }

    // Handler global llamado desde el botón del popup
    window._solicitarrecintoDesdePopup = function (btn) {
      if (!btn || btn.disabled) return;

      const ds = btn.dataset;

      const payload = {
        id_recinto: ds.idrecinto || null,
        provincia: ds.provincia ? Number(ds.provincia) : null,
        municipio: ds.municipio ? Number(ds.municipio) : null,
        agregado: ds.agregado ? Number(ds.agregado) : null,
        zona: ds.zona ? Number(ds.zona) : null,
        poligono: ds.poligono ? Number(ds.poligono) : null,
        recinto: ds.recinto ? Number(ds.recinto) : null,
      };

      solicitarrecinto(payload);
    };

  // -----------------------------------------
  // 5) Cargar recintos
  // -----------------------------------------
  function cargarRecintosSiProcede() {
    const z = map.getZoom();

    if (z < ZOOM_RECINTOS || !recintosActivos) {
      recintosLayer.clearLayers();
      return;
    }

    const b = map.getBounds();
    const bbox = [
      b.getWest().toFixed(6),
      b.getSouth().toFixed(6),
      b.getEast().toFixed(6),
      b.getNorth().toFixed(6),
    ].join(",");

    console.log("Solicitando recintos para bbox:", bbox);

    fetch(`/api/recintos?bbox=${bbox}`)
      .then((response) => {
        if (!response.ok) {
          throw new Error("Respuesta no OK de /api/recintos");
        }
        return response.json();
      })
      .then((fc) => {
        console.log("Recintos recibidos:", fc && fc.features ? fc.features.length : 0);
        recintosLayer.clearLayers();
        if (!fc || !fc.features || fc.features.length === 0) {
          return;
        }
        recintosLayer.addData(fc);
      })
      .catch((err) => {
        console.error("Error al cargar recintos:", err);
      });
  }

  // -----------------------------------------
  // 6) Actualizar mapa según zoom
  // -----------------------------------------
  function actualizarMapaSegunZoom() {
    const z = map.getZoom();
    const activeHighLayer = getActiveHighLayer();

    if (z >= ZOOM_RECINTOS) {
      if (map.hasLayer(baseOSM)) {
        map.removeLayer(baseOSM);
      }

      Object.values(highZoomLayers).forEach((layer) => {
        if (layer && layer !== activeHighLayer && map.hasLayer(layer)) {
          map.removeLayer(layer);
        }
      });

      if (activeHighLayer && !map.hasLayer(activeHighLayer)) {
        activeHighLayer.addTo(map);
      }
    } else {
      Object.values(highZoomLayers).forEach((layer) => {
        if (layer && map.hasLayer(layer)) {
          map.removeLayer(layer);
        }
      });

      if (!map.hasLayer(baseOSM)) {
        baseOSM.addTo(map);
      }

      recintosLayer.clearLayers();
    }
  }

  // -----------------------------------------
  // 7) Eventos del mapa
  // -----------------------------------------
  map.on("zoomend", () => {
    actualizarMapaSegunZoom();
    cargarRecintosSiProcede();
  });

  map.on("moveend", () => {
    cargarRecintosSiProcede();
  });

  actualizarMapaSegunZoom();
  cargarRecintosSiProcede();

  // -----------------------------------------
  // 8) Lógica del panel y botones sincronizados
  // -----------------------------------------
  const toggleBtn = document.getElementById("basemap-toggle");
  const panel = document.getElementById("basemap-panel");
  const basemapContainer = document.getElementById("basemap-panel-container");
  const filtroContainer = document.getElementById("filtro-container");

  toggleBtn.addEventListener("click", () => {
    const isOpening = !panel.classList.contains("visible");

    panel.classList.toggle("visible");
    toggleBtn.classList.toggle("active");

    // Desplazar ambos contenedores
    if (isOpening) {
      basemapContainer.classList.add("panel-open");
      filtroContainer.classList.add("panel-open");
    } else {
      basemapContainer.classList.remove("panel-open");
      filtroContainer.classList.remove("panel-open");
    }
  });

  // --- Selección de mapa principal ---
  document
    .querySelectorAll(".basemap-option.basemap-main[data-layer]")
    .forEach((option) => {
      option.addEventListener("click", () => {
        const layerKey = option.dataset.layer;
        if (!highZoomLayers[layerKey]) {
          return;
        }

        document
          .querySelectorAll(".basemap-option.basemap-main")
          .forEach((el) => el.classList.remove("active"));
        option.classList.add("active");

        activeHighLayerKey = layerKey;
        actualizarMapaSegunZoom();
      });
    });

  // --- Toggle Recintos SigPac ---
  const recintosOption = document.querySelector(
    '.basemap-option.basemap-detail[data-detail="sigpac"]'
  );

  if (recintosOption) {
    recintosOption.addEventListener("click", () => {
      recintosActivos = !recintosActivos;

      if (recintosActivos) {
        recintosOption.classList.add("active");
        cargarRecintosSiProcede();
      } else {
        recintosOption.classList.remove("active");
        recintosLayer.clearLayers();
      }
    });
  }
  });
</script>

{% endblock %}