{% extends "base.html" %}

{% block title %}Visor SIG{% endblock %}

{% block content %}

<!-- Leaflet CSS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>

<style>
  /* El mapa ocupa toda la ventana menos la barra verde superior */
  html,
  body {
    height: 100%;
  }

  #map {
    position: fixed;
    top: 65px; /* altura aproximada de la navbar; ajusta si hace falta */
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1;
  }
</style>

<div id="map"></div>

<!-- Leaflet JS -->
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // -----------------------------------------
    // 1) ROI desde Flask: roi_bbox = (minx, miny, maxx, maxy)
    // -----------------------------------------
    const roiBbox = [
      {{ roi_bbox[0] }},
      {{ roi_bbox[1] }},
      {{ roi_bbox[2] }},
      {{ roi_bbox[3] }}
    ];

    // Leaflet usa [lat, lng] -> [S,W] y [N,E]
    const ROI_BOUNDS = L.latLngBounds(
      [roiBbox[1], roiBbox[0]], // (miny, minx) = sudoeste
      [roiBbox[3], roiBbox[2]]  // (maxy, maxx) = nordeste
    );

    // Zoom a partir del cual:
    //   - cambiamos a satélite
    //   - mostramos y cargamos recintos
    const ZOOM_RECINTOS = 15;

    // -----------------------------------------
    // 2) Crear mapa limitado al ROI
    // -----------------------------------------
    const map = L.map("map", {
      maxBounds: ROI_BOUNDS,
      maxBoundsViscosity: 1.0,
      zoomControl: true,
    });

    // Ajustamos la vista al ROI
    map.fitBounds(ROI_BOUNDS);

    // -----------------------------------------
    // 3) Capas base
    // -----------------------------------------

    // Mapa base 1 – OSM (fondo claro, se ve con zoom lejano)
    const baseOSM = L.tileLayer(
      "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
      {
        attribution: "&copy; OpenStreetMap contributors",
        minZoom: 8,
        maxZoom: 19,
      }
    ).addTo(map); // capa inicial

    // Mapa base 2 – Satélite (Esri World Imagery)
    const baseSat = L.tileLayer(
      "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
      {
        attribution: "Tiles &copy; Esri",
        minZoom: 8,
        maxZoom: 19,
      }
    );

    // -----------------------------------------
    // 4) Capa de recintos (vacía al principio)
    // -----------------------------------------

    // Usamos GeoJSON para poder aplicar estilo y popups
    const recintosLayer = L.geoJSON(null, {
      style: {
        color: "#ff8800",
        weight: 1,
      },
      onEachFeature: function (feature, layer) {
        const p = feature.properties || {};
        const html = `
          <strong>Provincia:</strong> ${p.provincia ?? "-"}<br>
          <strong>Municipio:</strong> ${p.municipio ?? "-"}<br>
          <strong>Polígono:</strong> ${p.poligono ?? "-"}<br>
          <strong>Parcela:</strong> ${p.parcela ?? "-"}<br>
          <strong>Recinto:</strong> ${p.recinto ?? "-"}
        `;
        layer.bindPopup(html);
      },
    }).addTo(map); // se añade ya, pero al principio está vacío

    // -----------------------------------------
    // 5) Función: pedir recintos SOLO si el zoom es suficiente
    // -----------------------------------------
    function cargarRecintosSiProcede() {
      const z = map.getZoom();

      // Si estamos lejos, no pedimos nada y limpiamos la capa
      if (z < ZOOM_RECINTOS) {
        recintosLayer.clearLayers();
        return;
      }

      const b = map.getBounds();

      const bbox = [
        b.getWest().toFixed(6),
        b.getSouth().toFixed(6),
        b.getEast().toFixed(6),
        b.getNorth().toFixed(6),
      ].join(",");

      console.log("Solicitando recintos para bbox:", bbox);

      fetch(`/api/recintos?bbox=${bbox}`)
        .then((response) => {
          if (!response.ok) {
            throw new Error("Respuesta no OK de /api/recintos");
          }
          return response.json();
        })
        .then((fc) => {
          console.log(
            "Recintos recibidos:",
            fc && fc.features ? fc.features.length : 0
          );

          recintosLayer.clearLayers();

          if (!fc || !fc.features || fc.features.length === 0) {
            return;
          }

          // Añadimos todas las features a la capa GeoJSON existente
          recintosLayer.addData(fc);
        })
        .catch((err) => {
          console.error("Error al cargar recintos:", err);
        });
    }

    // -----------------------------------------
    // 6) Función: cambiar fondo según zoom
    //    - Lejos  -> OSM sin recintos
    //    - Cerca  -> Satélite + recintos
    // -----------------------------------------
    function actualizarMapaSegunZoom() {
      const z = map.getZoom();

      if (z >= ZOOM_RECINTOS) {
        // Zoom “cerca”: satélite
        if (map.hasLayer(baseOSM)) {
          map.removeLayer(baseOSM);
        }
        if (!map.hasLayer(baseSat)) {
          baseSat.addTo(map);
        }
        // recintosLayer se mantiene (se llenará en cargarRecintosSiProcede)
      } else {
        // Zoom “lejos”: OSM, sin recintos
        if (map.hasLayer(baseSat)) {
          map.removeLayer(baseSat);
        }
        if (!map.hasLayer(baseOSM)) {
          baseOSM.addTo(map);
        }
        recintosLayer.clearLayers(); // vaciamos dibujos
      }
    }

    // -----------------------------------------
    // 7) Eventos del mapa
    // -----------------------------------------

    // Cada vez que cambie el zoom:
    //  - cambiamos el fondo
    //  - y si procede pedimos recintos
    map.on("zoomend", () => {
      actualizarMapaSegunZoom();
      cargarRecintosSiProcede();
    });

    // Cada vez que termine un desplazamiento (dentro del zoom alto):
    map.on("moveend", () => {
      cargarRecintosSiProcede();
    });

    // Llamada inicial: ajusta fondo + recintos según zoom inicial
    actualizarMapaSegunZoom();
    cargarRecintosSiProcede();
  });
</script>

{% endblock %}