{% extends "base.html" %}

{% block title %}Visor SIG{% endblock %}

{% block navbar_extra %}
<div class="d-none d-md-flex align-items-center gap-3 bg-white rounded-3 px-3 py-2 shadow-sm">
  <!-- Temperatura principal -->
  <div class="d-flex align-items-center">
    <i class="bi bi-{{ weather.icono }} {{ weather.color_icono }}" style="font-size: 1.5rem;"></i>
    <span class="ms-2 fw-bold fs-5 text-dark">{{ weather.temperatura }}°</span>
  </div>

  <!-- Separador -->
  <div class="vr opacity-50"></div>

  <!-- Datos compactos -->
  <div class="d-flex gap-3 small text-dark">
    {% if weather.humedad %}
    <div class="d-flex align-items-center">
      <i class="bi bi-droplet-fill text-info me-1"></i>
      <span>{{ weather.humedad }}%</span>
    </div>
    {% endif %}

    {% if weather.viento_velocidad %}
    <div class="d-flex align-items-center">
      <i class="bi bi-wind text-secondary me-1"></i>
      <span>{{ weather.viento_velocidad }} km/h</span>
    </div>
    {% endif %}

    {% if weather.prob_precipitacion %}
    <div class="d-flex align-items-center">
      <i class="bi bi-cloud-rain text-primary me-1"></i>
      <span>{{ weather.prob_precipitacion }}%</span>
    </div>
    {% endif %}
  </div>

  <div class="d-none d-lg-block text-muted small">
    <i class="bi bi-geo-alt-fill"></i> {{ weather.municipio }}
  </div>
</div>
<div id="notification-container"></div>
<div id="lightbox" class="lightbox" style="display: none;">
  <span class="lightbox-close">&times;</span>
  <img class="lightbox-content" id="lightbox-img">
  <div class="lightbox-caption" id="lightbox-caption"></div>
  <button class="lightbox-prev" id="lightbox-prev">&#10094;</button>
  <button class="lightbox-next" id="lightbox-next">&#10095;</button>
</div>
{% endblock %}

{% block content %}


<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<link rel="stylesheet" href="{{ url_for('static', filename='css/visor.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/galeria.css') }}">
<script src="{{ url_for('static', filename='js/galeria.js') }}"></script>


<div id="map"></div>

<!-- Botón de capas -->
<div id="basemap-panel-container">
  <button id="basemap-toggle" title="Capas">
    <i class="bi bi-layers-fill"></i>
  </button>
</div>

<!-- Panel de capas -->
<div id="basemap-panel">
  <h6>Mapa Principal</h6>
  <div class="basemap-grid">
    <div class="basemap-option basemap-main active" data-layer="satellite">
      <div class="basemap-thumb">
        <img src="{{ url_for('static', filename='img/thumb_satellite.png') }}" alt="Imagen satélite" />
      </div>
      <div class="basemap-option-label">Imagen<br>Satelital</div>
    </div>

    <div class="basemap-option basemap-main {% if sentinel2_version == 0 %}disabled{% endif %}" data-layer="sentinel_recent">
      <div class="basemap-thumb">
        <img src="{{ url_for('static', filename='img/thumb_sentinel2.png') }}" alt="Sentinel-2 reciente" />
      </div>
      <div class="basemap-option-label">Satélite<br>reciente</div>
    </div>

    <div class="basemap-option basemap-main" data-layer="ndvi">
      <div class="basemap-thumb">
        <img src="{{ url_for('static', filename='img/thumb_ndvi.png') }}" alt="Vigor Vegetal (NDVI)" />
      </div>
      <div class="basemap-option-label">Vigor Vegetal<br>(NDVI)</div>
    </div>

    <div class="basemap-option disabled">
      <div class="basemap-thumb">
        <img src="{{ url_for('static', filename='img/thumb_etp.png') }}" alt="ETP" />
      </div>
      <div class="basemap-option-label">ETP</div>
    </div>
  </div>

  <h6>Nivel de Detalle</h6>
  <div class="basemap-grid">
    <div class="basemap-option basemap-detail active" data-detail="mis">
      <div class="basemap-thumb">
        <img src="{{ url_for('static', filename='img/thumb_mis_recintos.png') }}" alt="Mis Recintos" />
      </div>
      <div class="basemap-option-label">Mis Recintos</div>
    </div>

    <div class="basemap-option basemap-detail active" data-detail="sigpac">
      <div class="basemap-thumb">
        <img src="{{ url_for('static', filename='img/thumb_recintos.png') }}" alt="Recintos SigPac" />
      </div>
      <div class="basemap-option-label">Recintos SigPac</div>
    </div>

    <div class="basemap-option disabled">
      <div class="basemap-thumb">
        <img src="{{ url_for('static', filename='img/thumb_cultivos.png') }}" alt="Cultivos SigPac" />
      </div>
      <div class="basemap-option-label">Cultivos SigPac</div>
    </div>
  </div>
</div>


<!-- Botón de filtros -->
<div id="filtro-container">
  <button id="filtro-toggle" title="Filtros">
    <i class="bi bi-funnel-fill"></i>
  </button>
</div>

<!-- Botón de dibujar -->
<div id="editar-container">
  <button id="dibujar-btn" class="hidden" title="Dibujar Rectángulo">
    <i class="bi bi-square"></i>
  </button>
  <button id="poligono-btn" class="hidden" title="Dibujar Polígono">
    <i class="bi bi-pentagon"></i>
  </button>
  <button id="editar-btn" title="Editar">
    <i class="bi bi-pencil-fill"></i>
  </button>
  <button id="aceptar-btn" class="hidden" title="Aceptar">
    <i class="bi bi-check-lg"></i>
  </button>
  <button id="limpiar-btn" class="hidden" title="Limpiar todo">
    <i class="bi bi-trash-fill"></i>
  </button>
  <button id="cancelar-btn" class="hidden" title="Cancelar">
    <i class="bi bi-x-lg"></i>
  </button>
</div>

<!-- Panel derecho (split) -->
<aside id="side-panel" aria-hidden="true">

  <div class="side-content">
    <div class="side-sticky-top">
      <div class="side-header">
        <h1 id="side-title">Nombre Parcela</h1>

        <div class="side-actions">
          <button id="btn-edit-name" type="button" class="icon-btn edit" title="Editar nombre">
            <i class="bi bi-pencil-fill"></i>
          </button>
          <button id="btn-delete-recinto" type="button" class="icon-btn delete" title="Eliminar recinto">
            <i class="bi bi-trash-fill"></i>
          </button>       
          <button id="side-close" type="button" class="btn-side-close" title="Cerrar">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
      </div>

      <div class="side-divider"></div>
    </div>

    <div class="side-row">
      <i class="bi bi-globe2 side-ico"></i>

      <div class="side-line" style="display:flex;align-items:center;width:100%;">
        <span class="side-row-title">Superficie:</span>
        <span id="side-area" class="side-row-value ms-2">-</span>

        <!-- Icono localización decorativo a la derecha -->
        <i class="bi bi-geo-alt-fill ms-auto text-success" style="font-size:1.6rem" aria-hidden="true">
        </i>

        <!-- Coordenadas -->
        <span id="side-coords" class="side-row-value ms-2"></span>
      </div>
    </div>

    <div class="side-row">
      <i class="bi bi-person-fill side-ico"></i>
      <div class="side-row-text">
        <div class="side-row-title">Propietario:</div>
        <div id="side-owner" class="side-row-value">-</div>
      </div>
    </div>

    <label class="side-toggle">
      <input id="side-active" type="checkbox" checked />
      <span>Recinto activo</span>
    </label>
    <div class="side-divider"></div>

    <div class="side-section">
      <div class="side-section-head">
        <div></div>
    
        <h2 class="side-section-title mb-4">
          <i class="fa-solid fa-wheat-awn me-2" style="color:#198754"></i>
          <span class="side-section-label">Cultivos</span>
        </h2>
    
        <button id="btn-historico-cultivos" type="button" class="btn btn-success btn-historico">
          Histórico de cultivos
        </button>
      </div>
    
      <div id="cultivos-container"></div>
    </div>

    <div class="side-divider"></div>
    <!-- GALERÍA-->
    <div id="galeria-imagenes" class="galeria-container mt-4">
      <h2 class="side-section-title mb-3">
        <i class="fa-solid fa-image me-2" style="color:#198754"></i>
        Galería
      </h2>

      <!-- Botón Añadir Imagen -->
      <div class="mb-3">
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalSubida">
          <i class="fa-solid fa-plus me-1"></i> Añadir Imagen
        </button>
      </div>

      <!-- Grid de imágenes -->
      <div class="galeria-grid" id="galeria-grid">
        <!-- Se llenará dinámicamente -->
      </div>

    </div>

    <!-- OVERLAY HISTÓRICO CULTIVOS -->
    <div id="cultivos-historico-panel" class="side-overlay d-none" aria-hidden="true">

      <div class="overlay-topbar">
        <button id="btn-volver-historico" class="btn btn-outline-secondary" type="button">
          <i class="bi bi-arrow-left me-1"></i> Volver
        </button>

        <div class="overlay-title">
          <i class="fa-solid fa-wheat-awn" style="color:#198754"></i>
          <span>Cultivos</span>
        </div>

        <button id="btn-cerrar-historico" class="btn-side-close" type="button" title="Cerrar">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>

      <div class="side-divider"></div>
      <div id="cultivos-historico-list" class="pb-3"></div>
    </div>

    <!-- OVERLAY GALERÍA COMPLETA -->
    <div id="galeria-panel" class="side-overlay d-none" aria-hidden="true">
      <div class="overlay-topbar">
        <button id="btn-volver-galeria" class="btn btn-outline-secondary" type="button">
          <i class="bi bi-arrow-left me-1"></i> Volver
        </button>

        <div class="overlay-title">
          <i class="fa-solid fa-image" style="color:#198754"></i>
          <span>Galería</span>
        </div>

        <button id="btn-cerrar-galeria" class="btn-side-close" type="button" title="Cerrar">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>

      <div class="side-divider"></div>
      <div class="overlay-subbar">
        <div class="overlay-subtitle">
          Galería completa
          <span id="galeria-count" class="badge bg-success ms-2">0</span>
        </div>
      </div>

      <div id="galeria-panel-body"></div>
    </div>

    <div id="side-alerts"></div>
  </div>



</aside>

<!-- Modal confirmación -->
<div id="app-confirm-backdrop" class="app-confirm-backdrop d-none" aria-hidden="true">
  <div class="app-confirm-modal" role="dialog" aria-modal="true" aria-labelledby="app-confirm-title">
    <div class="app-confirm-header">
      <i class="bi bi-exclamation-triangle-fill" style="font-size:28px; color:#ffc107;"></i>
      <div>
        <div id="app-confirm-title" class="app-confirm-title">Confirmación</div>
        <div id="app-confirm-text" class="app-confirm-text"></div>
      </div>
    </div>

    <div class="app-confirm-actions">
      <button id="app-confirm-cancel" type="button" class="btn btn-secondary">Cancelar</button>
      <button id="app-confirm-ok" type="button" class="btn btn-danger">Eliminar</button>
    </div>
  </div>
</div>

<!-- Modal para subir nueva imagen -->
<div class="modal fade" id="modalSubida" tabindex="-1" aria-labelledby="modalSubidaLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="form-subida" enctype="multipart/form-data">
        <div class="modal-header">
          <h5 class="modal-title" id="modalSubidaLabel">Subir Nueva Imagen</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="imagen-file" class="form-label">Selecciona Imagen</label>
            <input class="form-control" type="file" id="imagen-file" accept="image/*" required>
          </div>
          <div class="mb-3">
            <label for="imagen-titulo" class="form-label">Título</label>
            <input type="text" class="form-control" id="imagen-titulo" required>
          </div>
          <div class="mb-3">
            <label for="imagen-descripcion" class="form-label">Descripción</label>
            <textarea class="form-control" id="imagen-descripcion" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-success">Subir Imagen</button>
        </div>
      </form>
    </div>
  </div>
</div>
<!-- Modal para editar imagen -->
<div class="modal fade" id="modalEditar" tabindex="-1" aria-labelledby="modalEditarLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="form-editar">
        <div class="modal-header">
          <h5 class="modal-title" id="modalEditarLabel">Editar Imagen</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editar-id-imagen">
          
           <div class="mb-3 text-center">
            <img id="editar-preview" 
                 src="" 
                 alt="Preview" 
                 style="max-width: 200px; max-height: 200px; border-radius: 8px; object-fit: cover; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          </div>
          <div class="mb-3">
            <label for="editar-titulo" class="form-label">Título</label>
            <input type="text" class="form-control" id="editar-titulo" required>
          </div>
          
          <div class="mb-3">
            <label for="editar-descripcion" class="form-label">Descripción</label>
            <textarea class="form-control" id="editar-descripcion" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-success">Guardar cambios</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  const NotificationSystem = {
    container: null,
    initialized: false,

    init() {
      if (this.initialized) return;

      this.container = document.getElementById('notification-container');

      if (!this.container) {
        // Crear el contenedor si no existe
        this.container = document.createElement('div');
        this.container.id = 'notification-container';
        document.body.appendChild(this.container);
      
      } else {
      }
      this.initialized = true;
    },

    show({ type = 'info', title, message, duration = 5000 }) {
      // Inicializar si no está listo
      if (!this.initialized) {
        this.init();
      }

      if (!this.container) {
        console.error('❌ No se pudo crear el contenedor de notificaciones');
        // Fallback a alert
        alert(`${title}\n${message}`);
        return;
      }

      const notification = document.createElement('div');
      notification.className = `notification ${type}`;

      const icons = {
        success: '✓',
        error: '✕',
        warning: '⚠',
        info: 'i'
      };

      notification.innerHTML = `
        <div class="notification-icon">${icons[type]}</div>
        <div class="notification-content">
          <div class="notification-title">${this.escapeHtml(title)}</div>
          <div class="notification-message">${this.escapeHtml(message)}</div>
        </div>
        <button class="notification-close" aria-label="Cerrar">×</button>
        <div class="notification-progress"></div>
      `;

      // Evento de cierre
      const closeBtn = notification.querySelector('.notification-close');
      closeBtn.addEventListener('click', () => this.close(closeBtn));

      this.container.appendChild(notification);

      // Auto-cierre
      if (duration > 0) {
        setTimeout(() => {
          this.close(closeBtn);
        }, duration);
      }
    },

    close(button) {
      const notification = button.closest('.notification');
      if (!notification) return;

      notification.classList.add('removing');
      setTimeout(() => {
        if (notification.parentNode) {
          notification.remove();
        }
      }, 300);
    },

    // Escapar HTML para prevenir XSS
    escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  };

  // Función para establecer la variable CSS con la altura de la navbar
  function setNavbarHeightVar() {
    const candidates = [
      'nav.navbar.fixed-top',
      'nav.navbar.sticky-top',
      '.navbar.fixed-top',
      '.navbar.sticky-top',
      'header.fixed-top',
      'header.sticky-top',
      'nav'
    ];

    let el = null;
    for (const sel of candidates) {
      const found = document.querySelector(sel);
      if (!found) continue;

      const cs = window.getComputedStyle(found);
      const pos = cs.position;
      if (pos === 'fixed' || pos === 'sticky') {
        el = found;
        break;
      }
    }

    let h = 65;
    if (el) {
      const rect = el.getBoundingClientRect();
      h = Math.round(rect.bottom);
    }

    if (h < 40 || h > 120) h = 65;
    document.documentElement.style.setProperty('--navbar-h', `${h}px`);
  }

  // calcular al cargar
  setNavbarHeightVar();
  // recalcular por si cambia (responsive)
  window.addEventListener("resize", setNavbarHeightVar);

  const AppConfirm = (() => {
    let backdrop, titleEl, textEl, btnOk, btnCancel;
    let resolveFn = null;
    let escHandler = null;

    function ensure() {
      if (backdrop) return;
      backdrop = document.getElementById("app-confirm-backdrop");
      titleEl = document.getElementById("app-confirm-title");
      textEl = document.getElementById("app-confirm-text");
      btnOk = document.getElementById("app-confirm-ok");
      btnCancel = document.getElementById("app-confirm-cancel");

      // No cerrar al clicar fuera
      backdrop.addEventListener("click", (e) => {
        if (e.target === backdrop) {
          e.preventDefault();
          e.stopPropagation();
        }
      });

      btnCancel.addEventListener("click", () => close(false));
      btnOk.addEventListener("click", () => close(true));
    }

    function open({ title, message, okText = "Aceptar", cancelText = "Cancelar", okClass = "btn-danger" }) {
      ensure();

      titleEl.textContent = title || "Confirmación";
      textEl.textContent = message || "";
      btnOk.textContent = okText;
      btnCancel.textContent = cancelText;

      btnOk.className = `btn ${okClass}`;

      backdrop.classList.remove("d-none");
      backdrop.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";

      // No cerrar con ESC
      escHandler = (e) => {
        if (e.key === "Escape") {
          e.preventDefault();
          e.stopPropagation();
        }
      };
      document.addEventListener("keydown", escHandler, true);

      return new Promise((resolve) => {
        resolveFn = resolve;
        setTimeout(() => btnOk.focus(), 0);
      });
    }

    function close(result) {
      if (!backdrop) return;

      backdrop.classList.add("d-none");
      backdrop.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";

      if (escHandler) {
        document.removeEventListener("keydown", escHandler, true);
        escHandler = null;
      }

      const r = resolveFn;
      resolveFn = null;
      r?.(!!result);
    }

    return { open };
  })();


  // -----------------------------------------
  // DOM Content Loaded
  // -----------------------------------------
  document.addEventListener("DOMContentLoaded", function () {

  const CURRENT_USER_ID = {{ current_user.id_usuario if current_user.is_authenticated else 'null' }};
  NotificationSystem.init();

  // -----------------------------------------
  // 1) ROI desde Flask
  // -----------------------------------------
  const roiBbox = [
    {{ roi_bbox[0] }},
    {{ roi_bbox[1] }},
    {{ roi_bbox[2] }},
    {{ roi_bbox[3] }}
  ];

  const ROI_BOUNDS = L.latLngBounds(
    [roiBbox[1], roiBbox[0]],
    [roiBbox[3], roiBbox[2]]
  );

  const NDVI_BOUNDS = L.latLngBounds({{ ndvi_bounds | tojson | safe }});

  const ZOOM_RECINTOS = 15;

  // -----------------------------------------
  // 2) Crear mapa
  // -----------------------------------------
  const map = L.map("map", {
    maxBounds: ROI_BOUNDS,
    maxBoundsViscosity: 1.0,
    zoomControl: true,
  });

  map.fitBounds(ROI_BOUNDS);


  

  // --- Panes (orden de dibujo) ---
  map.createPane('sigpacPane');
  map.getPane('sigpacPane').style.zIndex = 400;

  map.createPane('misPane');
  map.getPane('misPane').style.zIndex = 450;

  map.createPane('highlightPane');
  map.getPane('highlightPane').style.zIndex = 650;

  // --- Modo split (panel derecho vacío) ---
  let splitOpen = false;

  function setSplitMode(on) {
    splitOpen = !!on;

    if (splitOpen) {
      setNavbarHeightVar(); // calcula SOLO al abrir split
    }

    document.body.classList.toggle("split-mode", splitOpen);

    // Aria-hidden en el panel lateral
    const sp = document.getElementById("side-panel");
    if (sp) sp.setAttribute("aria-hidden", splitOpen ? "false" : "true");

    setTimeout(() => {
      try { map.invalidateSize(); } catch (e) {}
    }, 280);
  }

  window.addEventListener('resize', () => {
    if (splitOpen) {
      setNavbarHeightVar();
      try { map.invalidateSize(); } catch (e) {}
    }
  });

  // Cerrar split
  const sideCloseBtn = document.getElementById("side-close");
  if (sideCloseBtn) {
    sideCloseBtn.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();

      // 1) cerrar cualquier popup abierto
      try { map.closePopup(); } catch (_) {}

      // 2) quitar resaltado rojo
      clearHighlight();

      // 3) cerrar panel
      closeHistoricoPanel();
      setSplitMode(false);

      // reset id actual
      window.currentSideRecintoId = null;
    });
  }

  // ============================
  // EDITAR NOMBRE (lápiz)
  // Enter o blur => guardar
  // Escape => cancelar
  // ============================

  let currentSideRecintoId = null;
  let originalTitleText = "";

  const btnEdit = document.getElementById("btn-edit-name");
  const titleEl = document.getElementById("side-title");


  if (btnEdit && titleEl) {

    btnEdit.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();

      if (!currentSideRecintoId) {
        console.warn("No hay currentSideRecintoId");
        return;
      }

      originalTitleText = titleEl.textContent.trim();
      titleEl.setAttribute("contenteditable", "true");
      titleEl.focus();

      // Seleccionar todo el texto
      const range = document.createRange();
      range.selectNodeContents(titleEl);
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(range);
    });

    titleEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        titleEl.blur();
      }

      if (e.key === "Escape") {
        e.preventDefault();
        titleEl.textContent = originalTitleText;
        titleEl.removeAttribute("contenteditable");
      }
    });

    titleEl.addEventListener("blur", async () => {
      titleEl.removeAttribute("contenteditable");

      const nuevoNombre = titleEl.textContent.trim();

      if (!nuevoNombre || nuevoNombre === originalTitleText) {
        titleEl.textContent = originalTitleText;
        return;
      }

      try {
        const r = await fetch(
          `/api/mis-recinto/${currentSideRecintoId}/nombre`,
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ nombre: nuevoNombre })
          }
        );

        if (!r.ok) throw new Error();

      } catch (err) {
        console.error(err);
        titleEl.textContent = originalTitleText;
        mostrarErrorInline("No se pudo guardar el nombre");
      }
    });

  }

  function safeText(v, fallback = "-") {
    if (v === null || v === undefined) return fallback;
    const s = String(v).trim();
    return s === "" ? fallback : s;
  }

  function parseBool(v, def = true) {
    if (v === undefined || v === null) return def;
    if (typeof v === "boolean") return v;
    if (typeof v === "number") return v !== 0;
    const s = String(v).toLowerCase().trim();
    if (["t","true","1","yes","y","si","sí"].includes(s)) return true;
    if (["f","false","0","no","n"].includes(s)) return false;
    return def;
  }

  function formatAreaHa(p) {
    const a = p.superficie_ha ?? p.superficie ?? p.area_ha ?? p.area ?? null;
    if (a === null || a === undefined || a === "") return "-";
    const n = Number(a);
    if (!Number.isFinite(n)) return safeText(a);
    return `${n.toFixed(2).replace(".", ",")} ha`;
  }

  function formatDateValue(v) {
    if (!v) return "-";
    const d = new Date(v);
    if (Number.isNaN(d.getTime())) return safeText(v);

    const dd = String(d.getDate()).padStart(2, "0");
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const yyyy = String(d.getFullYear());
    const hh = String(d.getHours()).padStart(2, "0");
    const min = String(d.getMinutes()).padStart(2, "0");
    return `${dd}/${mm}/${yyyy} ${hh}:${min}`;
  }

  function renderSidePanelFromProps(p) {
    window.currentSideRecintoId = p.id || p.id_recinto;
    document.getElementById("side-title").textContent = safeText(p.nombre, "Recinto");
    document.getElementById("side-area").textContent = (p.superficie_ha == null)
      ? "-"
      : `${Number(p.superficie_ha).toFixed(2).replace(".", ",")} ha`;
    document.getElementById("side-owner").textContent = safeText(p.propietario, "N/A");
    document.getElementById("side-active").checked = (p.activa == null) ? true : !!p.activa;

    // Mostrar coordenadas del centroide
    const coordsText = document.getElementById("side-coords");
    if (p.centroid_lat != null && p.centroid_lng != null) {
      coordsText.textContent = `${p.centroid_lat.toFixed(6)}, ${p.centroid_lng.toFixed(6)}`;
    } else {
      coordsText.textContent = "-";
    }

    console.log('✅ Llamando a setRecintoId...');
    window.galeria.setRecintoId(window.currentSideRecintoId);

    renderCultivosForRecinto(currentSideRecintoId);
  }



const btnDelete = document.getElementById("btn-delete-recinto");
if (btnDelete) {
  btnDelete.addEventListener("click", async (e) => {
    e.preventDefault();
    e.stopPropagation();
    
    if (!currentSideRecintoId) {
      console.warn("No hay recinto seleccionado");
      return;
    }

    // Abrir modal de confirmación
    const ok = await AppConfirm.open({
      title: "Solicitar eliminación de recinto",
      message: "¿Estás seguro de que deseas solicitar la eliminación de este recinto? Un administrador deberá aprobar la solicitud antes de que el recinto sea eliminado.",
      okText: "Solicitar eliminación",
      cancelText: "Cancelar",
      okClass: "btn-danger"
    });

    // Si el usuario cancela, salir
    if (!ok) return;

    // Si confirma, proceder con la eliminación
    try {
      const response = await fetch(`/api/solicitud-eliminar-recinto/${currentSideRecintoId}/borrar`, {
        method: "POST",
        headers: { "Content-Type": "application/json" }
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || "Error al crear la solicitud");
      }

      NotificationSystem.show({
        type: "success",
        title: "Solicitud enviada",
        message: data.mensaje || "La solicitud se creó correctamente"
      });

    } catch (err) {
      console.error("Error al solicitar eliminación:", err);
      NotificationSystem.show({
        type: "error",
        title: "Error",
        message: err.message || "Error al solicitar eliminación"
      });
    }
  });
}

// Función auxiliar para mostrar mensajes de éxito

  // ==========================================================
  // Cultivos (UI del panel derecho)
  // Requiere endpoints (a implementar en backend):
  //   GET    /api/catalogos/usos-sigpac
  //   GET    /api/catalogos/productos-fega
  //   GET    /api/mis-recinto/<id>/cultivo            -> 404 si no hay
  //   POST   /api/cultivos                           -> crea
  //   PATCH  /api/cultivos/<id_cultivo>              -> actualiza
  //   DELETE /api/cultivos/<id_cultivo>              -> elimina
  // ==========================================================

  let _usosSigpac = null;     // [{codigo, descripcion, grupo}]
  let _productosFega = null;  // [{codigo, descripcion}]

  // Para "N/A - ALTRAMUZ", etc...
  const _cultivosCustom = [
    { codigo: null, descripcion: "SIN CULTIVO" },
    { codigo: null, descripcion: "ALTRAMUZ" },
    { codigo: null, descripcion: "ALTRAMUZ DULCE" }
  ];

  async function fetchJson(url, opts) {
    const resp = await fetch(url, opts);
    const txt = await resp.text().catch(() => "");
    let data = null;
    try { data = txt ? JSON.parse(txt) : null; } catch (_) {}

    if (!resp.ok) {
      const err = new Error(`HTTP ${resp.status} en ${url}`);
      err.status = resp.status;
      err.body = txt;
      err.data = data;
      throw err;
    }

    // Si no hay JSON, devuelve null
    return data;
  }

  // Convierte fechas de inputs a ISO (YYYY-MM-DD).
  // Acepta: YYYY-MM-DD (input type="date"), DD/MM/YYYY y DD-MM-YYYY.
  function parseDateToISO(v) {
    if (!v) return null;
    const s = String(v).trim();
    if (!s) return null;

    // Ya viene en ISO
    if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;

    // DD/MM/YYYY
    let m = s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
    if (m) return `${m[3]}-${m[2]}-${m[1]}`;

    // DD-MM-YYYY
    m = s.match(/^(\d{2})-(\d{2})-(\d{4})$/);
    if (m) return `${m[3]}-${m[2]}-${m[1]}`;

    // Como último recurso: intenta Date()
    const d = new Date(s);
    if (!isNaN(d.getTime())) return d.toISOString().slice(0, 10);

    return null;
  }

  async function loadUsosSigpac() {
    if (_usosSigpac) return _usosSigpac;
    _usosSigpac = await fetchJson("/api/catalogos/usos-sigpac");
    return _usosSigpac;
  }

  async function loadProductosFega() {
    if (_productosFega) return _productosFega;
    _productosFega = await fetchJson("/api/catalogos/productos-fega");
    return _productosFega;
  }

  const _productosFegaByUso = new Map();

  async function loadProductosFegaPorUso(usoSigpac) {
    const key = String(usoSigpac || "").trim();
    if (!key) return [];
    if (_productosFegaByUso.has(key)) return _productosFegaByUso.get(key);
    const list = await fetchJson(`/api/catalogos/productos-fega/${encodeURIComponent(key)}`);
    _productosFegaByUso.set(key, list || []);
    return list || [];
  }

  function byCodigo(list) {
    const m = new Map();
    (list || []).forEach(it => m.set(String(it.codigo), it));
    return m;
  }

  function norm(s) {
    return String(s ?? "").normalize("NFD").replace(/\p{Diacritic}/gu, "").toLowerCase();
  }

  function formatCodigoDesc(codigo, descripcion) {
    const code = (codigo === null || codigo === undefined || codigo === "") ? "N/A" : String(codigo);
    const desc = safeText(descripcion, "N/A");
    return `${code}-${desc}`;
  }

  function guessGrupoUso(usoCode, usosMap) {
    const u = usosMap.get(String(usoCode));
    return u?.grupo || null;
  }

  async function getCultivoRecinto(recintoId) {
    return fetchJson(`/api/mis-recinto/${recintoId}/cultivo`);
  }

  async function renderCultivosForRecinto(recintoId) {
    const container = document.getElementById("cultivos-container");
    if (!container) return;

    container.innerHTML = `<div class="text-muted">Cargando cultivos...</div>`;

    let usos = [];
    let productos = [];
    try {
      [usos, productos] = await Promise.all([loadUsosSigpac(), loadProductosFega()]);
    } catch (e) {
      console.warn(e);
      container.innerHTML = `
        <div class="text-danger">No se pudieron cargar los catálogos (SIGPAC/FEGA).</div>
        <div class="text-muted" style="font-size:12px">Revisa /api/catalogos/usos-sigpac y /api/catalogos/productos-fega</div>
      `;
      return;
    }

    try {
      const cultivo = await getCultivoRecinto(recintoId);
      renderCultivoView(container, recintoId, cultivo, usos, productos);
    } catch (e) {
      if (e && e.status === 404) {
        renderCultivoEmpty(container, recintoId, usos, productos);
        return;
      }
      console.warn(e);
      container.innerHTML = `<div class="text-danger">Error cargando cultivo del recinto.</div>`;
    }
  }

  function renderCultivoEmpty(container, recintoId, usos, productos) {
    container.innerHTML = `
      <button id="btn-add-cultivo" type="button" class="btn btn-success w-100">
        Añadir cultivo
      </button>
      <div class="text-muted" style="font-size:12px; margin-top:8px">
        Añade un cultivo a este recinto (FEGA o personalizado).
      </div>
    `;
    container.querySelector("#btn-add-cultivo").addEventListener("click", () => {
      renderCultivoForm(container, { recintoId, cultivo: null, usos, productos });
    });
  }

  function estadoLabel(v){
    const s = String(v || "").toLowerCase().trim();
    const map = {
      planificado: "Planificado",
      en_curso: "En curso",
      implantado: "Plantado",
      cosechado: "Cosechado",
      abandonado: "Abandonado"
    };
    return map[s] || safeText(v, "N/A");
  }

  let needsRefreshActualCultivo = false;

  function openHistoricoPanel(){
    const sp = document.getElementById("side-panel");
    const panel = document.getElementById("cultivos-historico-panel");
    if (!sp || !panel) return;
    sp.classList.add("cultivos-historico-open");
    panel.classList.remove("d-none");
    panel.setAttribute("aria-hidden", "false");
  }

  function closeHistoricoPanel(){
    const sp = document.getElementById("side-panel");
    const panel = document.getElementById("cultivos-historico-panel");
    if (!sp || !panel) return;
    sp.classList.remove("cultivos-historico-open");
    panel.classList.add("d-none");
    panel.setAttribute("aria-hidden", "true");

    // si se tocó el cultivo actual desde el histórico, repinta el actual al volver
    if (needsRefreshActualCultivo && currentSideRecintoId) {
      needsRefreshActualCultivo = false;
      renderCultivosForRecinto(currentSideRecintoId);
    }
  }

  window.openGaleriaPanel = function openGaleriaPanel(){
    const sp = document.getElementById("side-panel");
    const overlay = document.getElementById("galeria-panel");
    const body = document.getElementById("galeria-panel-body");
    const gal = document.getElementById("galeria-imagenes");
    const historico = document.getElementById("cultivos-historico-panel");
    if (!sp || !overlay || !body || !gal || !historico) return;

    // Cierra histórico si estuviera abierto
    closeHistoricoPanel?.();

    // Mover galería dentro del overlay (evita duplicados / pisadas)
    body.appendChild(gal);

    // Activar estado
    sp.classList.add("galeria-open");
    overlay.classList.remove("d-none");
    overlay.setAttribute("aria-hidden", "false");
  };

  window.closeGaleriaPanel = function closeGaleriaPanel(){
    const sp = document.getElementById("side-panel");
    const overlay = document.getElementById("galeria-panel");
    const gal = document.getElementById("galeria-imagenes");
    const historico = document.getElementById("cultivos-historico-panel");
    if (!sp || !overlay || !gal || !historico) return;

    // Devolver galería a su sitio (antes del histórico)
    historico.parentNode.insertBefore(gal, historico);

    // Desactivar estado
    sp.classList.remove("galeria-open");
    overlay.classList.add("d-none");
    overlay.setAttribute("aria-hidden", "true");
  };

  // Botones del overlay (una sola vez)
  document.getElementById("btn-volver-galeria")?.addEventListener("click", (e) => {
    e.preventDefault(); e.stopPropagation();
    window.galeria?.contraerGaleria(); // ya cierra overlay desde dentro
  });

  document.getElementById("btn-cerrar-galeria")?.addEventListener("click", (e) => {
    e.preventDefault(); e.stopPropagation();
    document.getElementById("side-close")?.click();
  });

  // Botones del overlay
  document.getElementById("btn-volver-galeria")?.addEventListener("click", (e) => {
    e.preventDefault(); e.stopPropagation();
    closeGaleriaPanel();
  });

  document.getElementById("btn-cerrar-galeria")?.addEventListener("click", (e) => {
    e.preventDefault(); e.stopPropagation();
    document.getElementById("side-close")?.click(); // cierra el split completo
  });


  document.getElementById("btn-cerrar-historico")?.addEventListener("click", (e) => {
    e.preventDefault();
    e.stopPropagation();
    sideCloseBtn?.click();
  });

  document.getElementById("btn-volver-historico")?.addEventListener("click", (e) => {
    e.preventDefault();
    e.stopPropagation();
    closeHistoricoPanel();
  });

  document.getElementById("btn-historico-cultivos")?.addEventListener("click", async (e) => {
    e.preventDefault();
    e.stopPropagation();

    if (!currentSideRecintoId) return;

    openHistoricoPanel();

    const listEl = document.getElementById("cultivos-historico-list");

    // Repinta histórico entero
    const reloadHistorico = async () => {
      if (!currentSideRecintoId) return;

      listEl.innerHTML = `<div class="text-muted">Cargando histórico...</div>`;

      let currentCultivoId = null;
      try {
        const cur = await getCultivoRecinto(currentSideRecintoId);
        currentCultivoId = cur?.id_cultivo ?? null;
      } catch (e) {
        if (!(e && e.status === 404)) throw e;
      }

      try {
        const [usos, productos, hist] = await Promise.all([
          loadUsosSigpac(),
          loadProductosFega(),
          fetchJson(`/api/mis-recinto/${currentSideRecintoId}/cultivos-historico`)
        ]);

        const usosMap = byCodigo(usos);
        const prodMap = byCodigo(productos);

        const arr = Array.isArray(hist) ? hist : [];
        const count = arr.length;

        listEl.innerHTML = `
          <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
            <div class="d-flex align-items-center gap-2">
              <i class="bi bi-journal-check text-success"></i>
              <span>Registro completo</span>
              <span class="badge bg-success">${count}</span>
            </div>

            <button id="btn-add-historico" class="btn btn-success btn-sm ms-auto">
              + Añadir al Histórico
            </button>
          </div>

          <div class="side-divider"></div>
          <div id="historico-cards"></div>
        `;

        const cardsEl = listEl.querySelector("#historico-cards");

        if (!arr.length) {
          cardsEl.innerHTML = `<div class="text-muted">No hay histórico todavía.</div>`;
        } else {
            const COLS = 9;

            cardsEl.innerHTML = `
              <div class="table-responsive historico-table-wrap">
                <table class="table table-sm table-hover align-middle historico-table mb-0">
                  <thead>
                    <tr>
                      <th style="min-width:140px;">Fechas</th>
                      <th style="min-width:180px;">Uso SIGPAC</th>
                      <th style="min-width:180px;">Tipo cultivo</th>
                      <th style="min-width:140px;">Variedad</th>
                      <th style="min-width:120px;">Explotación</th>
                      <th style="min-width:160px;">Campaña / Registro</th>
                      <th style="min-width:120px;">Estado</th>
                      <th style="min-width:220px;">Observaciones</th>
                      <th style="min-width:170px;" class="text-end">Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${arr.map((c) => {
                      const isCamp = String(c.tipo_registro || "").toUpperCase().includes("CAMP");
                      const inicio = isCamp ? c.fecha_siembra : c.fecha_implantacion;
                      const fin = c.fecha_cosecha_real || c.fecha_cosecha_estimada;

                      const isCurrent = currentCultivoId && String(c.id_cultivo) === String(currentCultivoId);

                      const u = usosMap.get(String(c.uso_sigpac));
                      const usoLbl = formatCodigoDesc(c.uso_sigpac, u?.descripcion || c.uso_sigpac);

                      let tipoLbl = "N/A";
                      const origen = String(c.origen_cultivo || "").toUpperCase();
                      if (origen === "F" && c.cod_producto != null) {
                        const p = prodMap.get(String(c.cod_producto));
                        tipoLbl = formatCodigoDesc(c.cod_producto, p?.descripcion || c.tipo_cultivo);
                      } else {
                        tipoLbl = formatCodigoDesc(null, c.cultivo_custom || c.tipo_cultivo);
                      }

                      const campOrReg = isCamp
                        ? safeText(c.campana, "N/A")
                        : safeText(tipoRegistroLabel(c.tipo_registro));

                      const obsText = (c.observaciones && String(c.observaciones).trim()) ? String(c.observaciones) : "";
                      const hasObs = !!obsText.trim();

                      // Preview corto (sin saltos) + botón Ver/Ocultar
                      const obsOneLine = hasObs ? obsText.replace(/\s+/g, " ").trim() : "";
                      const obsPreview = hasObs
                        ? escapeHtml(obsOneLine.slice(0, 70) + (obsOneLine.length > 70 ? "…" : ""))
                        : "";

                      const showToggle = hasObs || isCurrent; // aunque no haya obs, el actual tiene aviso útil
                      const targetId = `hist-obs-${c.id_cultivo}`;

                      const obsCellHtml = hasObs
                        ? `<span class="hist-obs-preview">${obsPreview}</span>`
                        : `<span class="text-muted">(Sin observaciones)</span>`;

                      const toggleBtn = showToggle
                        ? `<button type="button"
                                  class="btn btn-outline-success btn-sm btn-toggle-obs"
                                  data-target="${targetId}"
                                  aria-expanded="false">
                              Ver
                          </button>`
                        : ``;

                      const obsFullHtml = hasObs
                        ? `<div class="border rounded-3 p-2 hist-obs-box" style="white-space:pre-wrap;">${escapeHtml(obsText)}</div>`
                        : `<div class="text-muted">(Sin observaciones)</div>`;

                      return `
                        <tr>
                          <td class="hist-fechas">
                            ${safeText(formatDateOnly(inicio))} → ${safeText(formatDateOnly(fin))}
                            ${isCurrent ? `<span class="badge bg-success ms-2">Actual</span>` : ``}
                          </td>

                          <td>${safeText(usoLbl)}</td>
                          <td>${safeText(tipoLbl)}</td>
                          <td>${safeText(c.variedad, "N/A")}</td>
                          <td>${safeText(sistemaLabel(c.sistema_explotacion))}</td>
                          <td>${campOrReg}</td>
                          <td>${estadoLabel(c.estado)}</td>

                          <td>
                            <div class="d-flex align-items-center gap-2 flex-wrap">
                              ${obsCellHtml}
                              ${toggleBtn}
                            </div>
                          </td>

                          <td class="text-end">
                            <div class="d-flex gap-2 justify-content-end flex-wrap hist-actions">
                              <button class="btn btn-success btn-sm btn-edit-hist" data-id="${c.id_cultivo}">
                                <i class="bi bi-pencil-fill me-1"></i> Editar
                              </button>
                              <button class="btn btn-danger btn-sm btn-del-hist" data-id="${c.id_cultivo}" ${isCurrent ? "disabled" : ""}>
                                <i class="bi bi-trash-fill me-1"></i> Eliminar
                              </button>
                            </div>
                          </td>
                        </tr>

                        <tr id="${targetId}" class="hist-obs-row d-none">
                          <td colspan="${COLS}">
                            <div class="hist-obs-detail">
                              <div class="fw-bold mb-2">Observaciones</div>
                              ${obsFullHtml}

                              ${isCurrent ? `
                                <div class="text-muted mt-2" style="font-size:12px">
                                  Este es el cultivo actual. Para eliminarlo, hazlo desde la página principal del cultivo.
                                </div>
                              ` : ``}
                            </div>
                          </td>
                        </tr>
                      `;
                    }).join("")}
                  </tbody>
                </table>
              </div>
            `;

            // Toggle Observaciones (Ver/Ocultar)
            cardsEl.querySelectorAll(".btn-toggle-obs").forEach(btn => {
              btn.addEventListener("click", (ev) => {
                const b = ev.currentTarget;
                const targetId = b.dataset.target;
                const row = cardsEl.querySelector(`#${CSS.escape(targetId)}`);
                if (!row) return;

                const isHidden = row.classList.contains("d-none");
                row.classList.toggle("d-none", !isHidden);

                b.textContent = isHidden ? "Ocultar" : "Ver";
                b.setAttribute("aria-expanded", isHidden ? "true" : "false");
              });
            });

            // Eliminar registro (igual que antes)
            cardsEl.querySelectorAll(".btn-del-hist").forEach(btn => {
              btn.addEventListener("click", async (ev) => {
                const id = ev.currentTarget.dataset.id;

                const ok = await AppConfirm.open({
                  title: "Eliminar cultivo",
                  message: "¿Seguro que deseas eliminar el cultivo? Este proceso no es reversible.",
                  okText: "Eliminar",
                  cancelText: "Cancelar",
                  okClass: "btn-danger"
                });
                if (!ok) return;

                await fetchJson(`/api/cultivos/${id}`, { method: "DELETE" });
                await reloadHistorico();
              });
            });

            // Editar registro (igual que antes)
            cardsEl.querySelectorAll(".btn-edit-hist").forEach(btn => {
              btn.addEventListener("click", (ev) => {
                const id = ev.currentTarget.dataset.id;
                const item = arr.find(x => String(x.id_cultivo) === String(id));
                if (!item) return;

                renderCultivoForm(listEl, {
                  recintoId: currentSideRecintoId,
                  cultivo: item,
                  usos,
                  productos,
                  mode: "historico_edit",
                  cultivoId: Number(id),
                  currentCultivoId,
                  onDone: reloadHistorico,
                  onCancel: reloadHistorico
                });
              });
            });
          }

        // Añadir al histórico
        listEl.querySelector("#btn-add-historico")?.addEventListener("click", () => {
          renderCultivoForm(listEl, {
            recintoId: currentSideRecintoId,
            cultivo: null,
            usos,
            productos,
            mode: "historico_add",
            onDone: reloadHistorico,
            onCancel: reloadHistorico
          });
        });

      } catch (err) {
        console.warn(err);
        listEl.innerHTML = `<div class="text-danger">No se pudo cargar el histórico.</div>`;
      }
    };

    // Primer pintado al abrir
    await reloadHistorico();
  });

  function formatDateOnly(v) {
    if (!v) return "N/A";
    const d = new Date(v);
    if (Number.isNaN(d.getTime())) return safeText(v);
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const yy = d.getFullYear();
    return `${dd}/${mm}/${yy}`;
  }

  function escapeHtml(s) {
    const div = document.createElement("div");
    div.textContent = s ?? "";
    return div.innerHTML;
  }

  function cultivoTipoLabel(c) {
    const code = (c.cod_producto == null) ? "N/A" : String(c.cod_producto);
    const name = safeText(c.tipo_cultivo || c.cultivo_custom, "N/A");
    return `${code}-${name}`;
  }

  function cultivoUsoLabel(c, usosMap) {
    const u = usosMap.get(String(c.uso_sigpac));
    return formatCodigoDesc(c.uso_sigpac, u?.descripcion || c.uso_sigpac);
  }

  function sistemaLabel(val) {
    const v = String(val || "").toUpperCase();
    if (v === "R") return "Regadío";
    if (v === "S") return "Secano";
    return "N/A";
  }

  function tipoRegistroLabel(val) {
    const v = String(val || "").toUpperCase();
    if (v.includes("IMPL")) return "Plantación";
    if (v.includes("CAMP")) return "Campaña";
    return safeText(val, "N/A");
  }

  function renderCultivoView(container, recintoId, cultivo, usos, productos) {
    const usosMap = byCodigo(usos);
    const tipoReg = tipoRegistroLabel(cultivo.tipo_registro);
    const isCamp = String(cultivo.tipo_registro || "").toUpperCase().includes("CAMP");

    const inicio = isCamp ? cultivo.fecha_siembra : cultivo.fecha_implantacion;
    const fin = cultivo.fecha_cosecha_real || cultivo.fecha_cosecha_estimada;

    const variedad = cultivo.variedad ? safeText(cultivo.variedad) : "N/A";
    const obs = cultivo.observaciones || "";

    container.innerHTML = `
      <div class="cultivo-grid">
        <div class="cultivo-field">
          <div class="k">Uso SIGPAC</div>
          <div class="v">${safeText(cultivoUsoLabel(cultivo, usosMap))}</div>
        </div>
        <div class="cultivo-field">
          <div class="k">Tipo cultivo</div>
          <div class="v">${safeText(cultivoTipoLabel(cultivo))}</div>
        </div>

        <div class="cultivo-field">
          <div class="k">Variedad</div>
          <div class="v">${safeText(variedad)}</div>
        </div>
        <div class="cultivo-field">
          <div class="k">Explotación</div>
          <div class="v">${safeText(sistemaLabel(cultivo.sistema_explotacion))}</div>
        </div>

        <div class="cultivo-field">
          <div class="k">${isCamp ? "Campaña" : "Tipo registro"}</div>
          <div class="v">${isCamp ? safeText(cultivo.campana, "N/A") : safeText(tipoReg)}</div>
        </div>
        <div class="cultivo-field">
          <div class="k">Estado</div>
          <div class="v">${estadoLabel(cultivo.estado)}</div>
        </div>

        <div class="cultivo-field">
          <div class="k">Fecha inicio</div>
          <div class="v">${safeText(formatDateOnly(inicio))}</div>
        </div>
        <div class="cultivo-field">
          <div class="k">Fecha fin</div>
          <div class="v">${safeText(formatDateOnly(fin))}</div>
        </div>
      </div>

      <div class="side-soft-divider"></div>
      <div class="mt-3">
        <div class="fw-bold mb-1">Observaciones</div>

        <!-- Texto normal (no editable) -->
        <div id="obs-view" class="border rounded-3 p-2" style="min-height:90px; white-space:pre-wrap;"></div>

        <!-- Textarea sólo cuando el usuario pulsa “Editar observaciones” -->
        <textarea id="obs-edit" class="form-control d-none" rows="3" placeholder="(Opcional)"></textarea>

        <div class="cultivo-actions mt-2" id="obs-view-actions">
          <button id="btn-edit-obs" class="btn btn-outline-success btn-sm" type="button">
            Editar observaciones
          </button>
          <button id="btn-edit-cultivo" class="btn btn-outline-success btn-sm" type="button">
            Editar cultivo
          </button>
          <button id="btn-del-cultivo" class="btn btn-outline-danger btn-sm" type="button">
            Eliminar cultivo
          </button>
        </div>

            <div class="cultivo-actions mt-2 d-none" id="obs-edit-actions">
              <button id="btn-obs-accept" class="btn btn-success btn-sm" type="button">Aceptar</button>
              <button id="btn-obs-cancel" class="btn btn-secondary btn-sm" type="button">Cancelar</button>
            </div>
          </div>
    `;

    // --- Observaciones: render “texto normal” ---
    const obsView = container.querySelector("#obs-view");
    const obsEdit = container.querySelector("#obs-edit");
    const viewActions = container.querySelector("#obs-view-actions");
    const editActions = container.querySelector("#obs-edit-actions");

    function renderObsText(text) {
      const t = String(text || "");
      if (!t.trim()) {
        obsView.innerHTML = `<span class="text-muted">(Sin observaciones)</span>`;
      } else {
        obsView.textContent = t;
      }
    }

    renderObsText(obs);
    obsEdit.value = obs;

    let obsOriginal = obsEdit.value;

    container.querySelector("#btn-edit-obs").addEventListener("click", () => {
      obsOriginal = obsEdit.value;

      obsView.classList.add("d-none");
      obsEdit.classList.remove("d-none");

      viewActions.classList.add("d-none");
      editActions.classList.remove("d-none");

      obsEdit.focus();
    });

    container.querySelector("#btn-obs-cancel").addEventListener("click", () => {
      obsEdit.value = obsOriginal;

      obsEdit.classList.add("d-none");
      obsView.classList.remove("d-none");

      editActions.classList.add("d-none");
      viewActions.classList.remove("d-none");
    });

    container.querySelector("#btn-obs-accept").addEventListener("click", async () => {
      try {
        const val = obsEdit.value;

        await fetchJson(`/api/cultivos/${cultivo.id_cultivo}`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ observaciones: val }),
        });

        cultivo.observaciones = val;
        obsOriginal = val;

        renderObsText(val);

        obsEdit.classList.add("d-none");
        obsView.classList.remove("d-none");

        editActions.classList.add("d-none");
        viewActions.classList.remove("d-none");

        NotificationSystem.show({
          type: "success",
          title: "Observaciones guardadas",
          message: ""
        });
      } catch (e) {
        console.warn(e);
        NotificationSystem.show({
          type: "error",
          title: "Error",
          message: "No se pudieron guardar las observaciones"
        });
      }
    });

    // Editar cultivo
    container.querySelector("#btn-edit-cultivo").addEventListener("click", async () => {
      try {
        const cultivoFresh = await getCultivoRecinto(recintoId);
        renderCultivoForm(container, { recintoId: cultivoFresh.id_recinto || recintoId, cultivo: cultivoFresh, usos, productos });
      } catch (e) {
        console.warn("No se pudo refrescar cultivo antes de editar, uso el objeto en memoria.", e);
        renderCultivoForm(container, { recintoId: cultivo.id_recinto || recintoId, cultivo, usos, productos });
      }
    });

    // Eliminar cultivo
    container.querySelector("#btn-del-cultivo").addEventListener("click", () => {
      abrirConfirmacionEliminarCultivo(recintoId);
    });
  }

  async function abrirConfirmacionEliminarCultivo(recintoId) {
    const ok = await AppConfirm.open({
      title: "Eliminar cultivo",
      message: "¿Seguro que deseas eliminar el cultivo actual? Este proceso no es reversible y también se eliminará su entrada correspondiente en el histórico.",
      okText: "Eliminar",
      cancelText: "Cancelar",
      okClass: "btn-danger"
    });

    if (!ok) return;

    try {
      await fetchJson(`/api/mis-recinto/${recintoId}/cultivo`, { method: "DELETE" });
      NotificationSystem.show({
        type: "success",
        title: "Cultivo eliminado",
        message: ""
      });
      renderCultivosForRecinto(recintoId);
    } catch (e) {
      console.warn(e);
      NotificationSystem.show({
        type: "error",
        title: "Error",
        message: "No se pudo eliminar el cultivo"
      });
    }
  }

  function openSs(ssEl) { ssEl.classList.add("open"); }
  function closeSs(ssEl) { ssEl.classList.remove("open"); }

  function attachSearchSelect(ssEl, items, opts) {
    const input = ssEl.querySelector("input");
    const menu = ssEl.querySelector(".ss-menu");
    const hidden = ssEl.querySelector("input[type=hidden]");
    const {
      getLabel,
      getValue,
      onSelect,
      allowFreeText = false,
      emptyText = "Sin resultados",
    } = opts;

    function renderList(list) {
      menu.innerHTML = "";
      if (!list.length) {
        const d = document.createElement("div");
        d.className = "ss-item text-muted";
        d.textContent = emptyText;
        menu.appendChild(d);
        return;
      }
      for (const it of list) {
        const d = document.createElement("div");
        d.className = "ss-item";
        d.textContent = getLabel(it);
        d.addEventListener("mousedown", (ev) => {
          ev.preventDefault(); // evita perder foco antes de seleccionar
          const val = getValue(it);
          hidden.value = (val === null || val === undefined) ? "" : String(val);
          input.value = getLabel(it);
          closeSs(ssEl);
          onSelect?.(it);
        });
        menu.appendChild(d);
      }
    }

    function filterNow() {
      const q = norm(input.value);
      const list = items.filter(it => {
        const label = norm(getLabel(it));
        const val = norm(getValue(it));
        return !q || label.includes(q) || val.includes(q);
      });
      renderList(list.slice(0, 200));
    }

    input.addEventListener("focus", () => { openSs(ssEl); filterNow(); });
    input.addEventListener("input", () => { openSs(ssEl); filterNow(); });

    input.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeSs(ssEl);
      if (allowFreeText && e.key === "Enter") closeSs(ssEl);
    });

    document.addEventListener("click", (e) => {
      if (!ssEl.contains(e.target)) closeSs(ssEl);
    });

    // inicial
    renderList(items.slice(0, 50));
    return {
      setItems(newItems) {
        items = newItems;
        filterNow();
      },
      getSelectedValue() {
        return hidden.value || null;
      }
    };
  }

  function renderCultivoForm(container, { recintoId, cultivo, usos, productos, mode="actual", cultivoId=null, currentCultivoId=null, onDone=null, onCancel=null }) {
    const usosMap = byCodigo(usos);
    const productosAll = productos || [];

    const estadoOpts = [
      { v: "planificado", l: "Planificado" },
      { v: "implantado",  l: "Plantado" },
      { v: "en_curso",    l: "En cultivo" },
      { v: "cosechado",   l: "Cosechado" },
      { v: "abandonado",  l: "Abandonado" }
    ];

    const tipoRegOpts = [
      { v: "CAMPANA", l: "Campaña (año a año)" },
      { v: "IMPLANTACION", l: "Plantación (permanente)" },
    ];

    container.innerHTML = `
      <div class="card" style="border-radius:16px">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="fw-bold">${cultivo ? "Editar cultivo" : "Añadir cultivo"}</div>
            <button id="btn-cancel-cultivo" type="button" class="btn btn-sm btn-outline-secondary">Cancelar</button>
          </div>

          <div class="mb-3 ss" id="ss-uso">
            <label class="form-label fw-bold">Uso SIGPAC *</label>
            <input class="form-control" type="text" placeholder="Busca: CI-Cítricos, OV-Olivar, TA-Tierras arables..." autocomplete="off">
            <input type="hidden" id="uso_sigpac_val">
            <div class="ss-menu"></div>
          </div>

          <div class="d-flex justify-content-between align-items-center mb-1">
            <label class="form-label fw-bold mb-0">Tipo de cultivo *</label>
            <button id="btn-ver-todos" type="button" class="btn btn-sm btn-outline-success" disabled>Ver todos</button>
          </div>

          <div class="mb-3 ss" id="ss-prod">
            <input class="form-control" type="text" placeholder="Busca por código o nombre: 99-PATATA, N/A-ALTRAMUZ..." autocomplete="off" disabled>
            <input type="hidden" id="cod_producto_val">
            <div class="ss-menu"></div>
            <div class="form-text" id="prod-help">Selecciona primero el uso SIGPAC.</div>
          </div>

          <div class="mb-3" id="custom-wrap" style="display:none">
            <label class="form-label fw-bold">Cultivo personalizado</label>
            <input id="cultivo_custom" class="form-control" type="text" placeholder="Escribe el cultivo (p.ej. ALTRAMUZ)">
          </div>

          <div class="mb-3 position-relative">
          <label class="form-label fw-bold">Variedad (opcional)</label>
          <input id="variedad" class="form-control" type="text" 
                placeholder="Empieza a escribir: Picual, Arbequina..." 
                autocomplete="off">
          <div id="variedad-suggestions" class="list-group position-absolute w-100" style="z-index:1000; max-height:200px; overflow-y:auto; display:none;"></div>
          <div class="form-text">Selecciona una variedad de la lista o escribe una nueva.</div>
        </div>

          <div class="mb-3">
            <label class="form-label fw-bold">Estado</label>
            <select id="estado" class="form-select">
              ${estadoOpts.map(o => `<option value="${o.v}">${o.l}</option>`).join("")}
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">Explotación</label>
            <div class="d-flex gap-3">
              <div class="form-check">
                <input class="form-check-input" type="radio" name="sistema_explotacion" id="exp-sec" value="S" checked>
                <label class="form-check-label" for="exp-sec">Secano</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="sistema_explotacion" id="exp-reg" value="R">
                <label class="form-check-label" for="exp-reg">Regadío</label>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">Tipo de registro</label>
            <select id="tipo_registro" class="form-select">
              ${tipoRegOpts.map(o => `<option value="${o.v}">${o.l}</option>`).join("")}
            </select>
          </div>

          <div class="mb-3" id="campana-wrap" style="display:none">
            <label class="form-label fw-bold">Campaña</label>
            <input id="campana" class="form-control" type="number" min="1900" max="2200" placeholder="2026">
          </div>

          <div class="mb-3" id="fecha-inicio-wrap">
            <label class="form-label fw-bold" id="lbl-fecha-inicio">Fecha siembra</label>
            <input id="fecha_inicio" class="form-control" type="date">
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">Fecha fin (opcional)</label>
            <input id="fecha_fin" class="form-control" type="date">
            <div class="form-text">Si no indicas fecha fin, se estimará automáticamente.</div>
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">Observaciones (opcional)</label>
            <textarea id="observaciones" class="form-control" rows="3" placeholder="Escribe notas..."></textarea>
          </div>

          <button id="btn-save-cultivo" type="button" class="btn btn-success w-100">Guardar</button>
          <div id="cultivo-form-msg" class="text-muted" style="font-size:12px; margin-top:8px"></div>
        </div>
      </div>
    `;

    // Autocompletado de variedad
    const variedadInput = container.querySelector("#variedad");
    const suggestionsList = container.querySelector("#variedad-suggestions");
    let timeoutVariedad = null;

    variedadInput.addEventListener("input", async (e) => {
      const query = e.target.value.trim();
      
      // Limpiar timeout anterior
      if (timeoutVariedad) {
        clearTimeout(timeoutVariedad);
      }
      
      // Si está vacío, ocultar sugerencias
      if (query.length < 1) {
        suggestionsList.style.display = "none";
        suggestionsList.innerHTML = "";
        return;
      }
      
      // Esperar 200ms después de que el usuario deje de escribir
      timeoutVariedad = setTimeout(async () => {
        try {
          // Obtener el producto seleccionado (opcional, para filtrar)
          const productoId = container.querySelector("#cod_producto_val")?.value || "";
          
          // Construir URL con parámetros - CON /api
          let url = `/api/variedades/buscar?q=${encodeURIComponent(query)}`;
          if (productoId && productoId !== "") {
            url += `&producto_id=${productoId}`;
          }
          
          const response = await fetch(url);
          const variedades = await response.json();
          
          // Mostrar sugerencias SOLO si hay resultados
          if (variedades.length > 0) {
            suggestionsList.innerHTML = variedades.map(v => `
              <button type="button" class="list-group-item list-group-item-action" data-nombre="${v.nombre}">
                ${v.nombre}
              </button>
            `).join("");
            suggestionsList.style.display = "block";
          } else {
            // Si no hay resultados, simplemente ocultar las sugerencias
            // El usuario puede seguir escribiendo lo que quiera
            suggestionsList.style.display = "none";
            suggestionsList.innerHTML = "";
          }
        } catch (error) {
          console.error("Error buscando variedades:", error);
          suggestionsList.style.display = "none";
          suggestionsList.innerHTML = "";
        }
      }, 200); // Debounce de 200ms
    });

    // Click en una sugerencia
    suggestionsList.addEventListener("click", (e) => {
      const btn = e.target.closest("button");
      if (btn) {
        const nombre = btn.getAttribute("data-nombre");
        variedadInput.value = nombre;
        suggestionsList.style.display = "none";
        suggestionsList.innerHTML = "";
      }
    });

    // Cerrar sugerencias al hacer click fuera
    document.addEventListener("click", (e) => {
      if (!variedadInput.contains(e.target) && !suggestionsList.contains(e.target)) {
        suggestionsList.style.display = "none";
      }
    });

    // Cerrar sugerencias con Escape
    variedadInput.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        suggestionsList.style.display = "none";
      }
    });

    // Permitir enviar con Enter incluso sin seleccionar de la lista
    variedadInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        suggestionsList.style.display = "none";
        // El valor ya está en el input, no hace falta hacer nada más
      }
    });

    const ssUsoEl = container.querySelector("#ss-uso");
    const ssProdEl = container.querySelector("#ss-prod");
    const btnVerTodos = container.querySelector("#btn-ver-todos");

    const usoItems = usos.map(u => ({
      codigo: u.codigo,
      descripcion: u.descripcion,
      grupo: u.grupo,
      label: formatCodigoDesc(u.codigo, u.descripcion),
    }));

    let modoVerTodos = false;
    let selectedUso = null;
    let selectedProd = null;
    let productosUso = [];

    const ssUso = attachSearchSelect(ssUsoEl, usoItems, {
      getLabel: (it) => it.label,
      getValue: (it) => it.codigo,
      onSelect: async (it) => {
        selectedUso = it;

        ssProdEl.querySelector("input").disabled = false;
        ssProdEl.querySelector("#prod-help").style.display = "none";
        btnVerTodos.disabled = false;

        modoVerTodos = false;
        btnVerTodos.textContent = "Ver todos";

        try {
          productosUso = await loadProductosFegaPorUso(it.codigo);
        } catch (_) {
          productosUso = [];
        }

        actualizarListaProductos();
      }
    });

    function buildProductosList() {
      const base = productosAll.map(p => ({
        codigo: p.codigo,
        descripcion: p.descripcion,
        origen: "F",
        label: formatCodigoDesc(p.codigo, p.descripcion),
      }));
      const custom = _cultivosCustom.map(p => ({
        codigo: null,
        descripcion: p.descripcion,
        origen: "C",
        label: formatCodigoDesc(null, p.descripcion),
      }));
      // Añadimos "OTRO" para permitir escribir
      const otro = [{ codigo: "__OTRO__", descripcion: "OTRO (escribir...)", origen: "C", label: "N/A-OTRO (escribir...)" }];
      return [...base, ...custom, ...otro];
    }

    let productosItems = buildProductosList();
    let ssProd = attachSearchSelect(ssProdEl, [], {
      getLabel: (it) => it.label,
      getValue: (it) => (it.codigo === null ? "" : it.codigo),
      onSelect: (it) => {
        selectedProd = it;
        const customWrap = container.querySelector("#custom-wrap");
        const customInput = container.querySelector("#cultivo_custom");
        const codHidden = container.querySelector("#cod_producto_val");

        if (it.codigo === "__OTRO__") {
          customWrap.style.display = "";
          codHidden.value = ""; // null
          customInput.focus();
        } else if (it.origen === "C") {
          customWrap.style.display = "";
          codHidden.value = ""; // null
          customInput.value = it.descripcion;
        } else {
          customWrap.style.display = "none";
          codHidden.value = String(it.codigo);
          customInput.value = "";
        }
      }
    });

    function actualizarListaProductos() {
      const baseList = (modoVerTodos || !productosUso.length) ? productosAll : productosUso;

      const fega = (baseList || []).map(p => ({
        codigo: p.codigo,
        descripcion: p.descripcion,
        origen: "F",
        label: formatCodigoDesc(p.codigo, p.descripcion),
      }));

      const custom = _cultivosCustom.map(p => ({
        codigo: null,
        descripcion: p.descripcion,
        origen: "C",
        label: formatCodigoDesc(null, p.descripcion),
      }));

      const otro = [{
        codigo: "__OTRO__",
        descripcion: "OTRO (escribir...)",
        origen: "C",
        label: "N/A-OTRO (escribir...)"
      }];

      productosItems = [...fega, ...custom, ...otro];
      ssProd.setItems(productosItems);

      const help = container.querySelector("#prod-help");
      if (!modoVerTodos && !productosUso.length) {
        help.style.display = "";
        help.textContent = "No hay productos asociados a este uso (según histórico). Pulsa “Ver todos”.";
      } else {
        help.style.display = "none";
      }
    }

    btnVerTodos.addEventListener("click", () => {
      modoVerTodos = !modoVerTodos;
      btnVerTodos.textContent = modoVerTodos ? "Filtrar" : "Ver todos";
      actualizarListaProductos();
    });

    // Tipo registro: muestra campaña o cambia etiqueta de fecha
    const tipoRegSel = container.querySelector("#tipo_registro");
    const campWrap = container.querySelector("#campana-wrap");
    const lblInicio = container.querySelector("#lbl-fecha-inicio");

    function syncTipoRegistroUi() {
      const v = tipoRegSel.value;
      const isCamp = v === "CAMPANA";
      campWrap.style.display = isCamp ? "" : "none";
      lblInicio.textContent = isCamp ? "Fecha siembra" : "Fecha plantación";
    }
    tipoRegSel.addEventListener("change", syncTipoRegistroUi);
    syncTipoRegistroUi();

    // Si venimos de editar
    if (cultivo) {
      // Uso sigpac
      const u = usosMap.get(String(cultivo.uso_sigpac));
      if (cultivo.uso_sigpac) {
        ssUsoEl.querySelector("input").value = formatCodigoDesc(cultivo.uso_sigpac, u?.descripcion || cultivo.uso_sigpac);
        ssUsoEl.querySelector("#uso_sigpac_val").value = cultivo.uso_sigpac;
        selectedUso = { codigo: cultivo.uso_sigpac, grupo: u?.grupo };
        ssProdEl.querySelector("input").disabled = false;
        btnVerTodos.disabled = false;
        actualizarListaProductos();
      }

      // Tipo cultivo
      const customWrap = container.querySelector("#custom-wrap");
      const customInput = container.querySelector("#cultivo_custom");
      const codHidden = container.querySelector("#cod_producto_val");
      const isFega = (cultivo.origen_cultivo || "").toUpperCase() === "F";

      if (isFega && cultivo.cod_producto != null) {
        const p = productosAll.find(x => String(x.codigo) === String(cultivo.cod_producto));
        ssProdEl.querySelector("input").value = formatCodigoDesc(cultivo.cod_producto, p?.descripcion || cultivo.tipo_cultivo);
        codHidden.value = String(cultivo.cod_producto);
        customWrap.style.display = "none";
      } else {
        ssProdEl.querySelector("input").value = formatCodigoDesc(null, cultivo.cultivo_custom || cultivo.tipo_cultivo);
        codHidden.value = "";
        customWrap.style.display = "";
        customInput.value = cultivo.cultivo_custom || cultivo.tipo_cultivo || "";
      }

      // resto campos
      container.querySelector("#variedad").value = cultivo.variedad || "";
      container.querySelector("#estado").value = cultivo.estado || "en_curso";

      const exp = (cultivo.sistema_explotacion || "S").toUpperCase();
      container.querySelector("#exp-sec").checked = (exp === "S");
      container.querySelector("#exp-reg").checked = (exp === "R");

      const tr = String(cultivo.tipo_registro || "CAMPANA").toUpperCase().includes("IMPL") ? "IMPLANTACION" : "CAMPANA";
      tipoRegSel.value = tr;
      syncTipoRegistroUi();

      container.querySelector("#campana").value = cultivo.campana || "";
      const inicio = (tr === "CAMPANA") ? cultivo.fecha_siembra : cultivo.fecha_implantacion;
      container.querySelector("#fecha_inicio").value = inicio ? String(inicio).slice(0,10) : "";
      const fin = cultivo.fecha_cosecha_real || cultivo.fecha_cosecha_estimada;
      container.querySelector("#fecha_fin").value = fin ? String(fin).slice(0,10) : "";

      container.querySelector("#observaciones").value = cultivo.observaciones || "";
    } else {
      // defaults
      container.querySelector("#estado").value = "planificado";
    }

    container.querySelector("#btn-cancel-cultivo").addEventListener("click", () => {
      if (mode === "historico_add" || mode === "historico_edit") {
        if (mode === "historico_edit" && currentCultivoId && String(cultivoId) === String(currentCultivoId)) {
          // Si acabo de editar el actual desde el histórico, repintar la vista principal YA
          renderCultivosForRecinto(recintoId);
        }
        if (typeof onDone === "function") onDone();
      } else {
        renderCultivosForRecinto(recintoId);
      }
    });

    container.querySelector("#btn-save-cultivo").addEventListener("click", async () => {
      const msg = container.querySelector("#cultivo-form-msg");
      msg.textContent = "";

      const uso = container.querySelector("#uso_sigpac_val").value;
      if (!uso) {
        msg.textContent = "Selecciona un uso SIGPAC.";
        msg.className = "text-danger";
        return;
      }

      const cod = container.querySelector("#cod_producto_val").value;
      const custom = (container.querySelector("#cultivo_custom")?.value || "").trim();

      let origen = "F";
      let cod_producto = null;
      let cultivo_custom = null;

      if (cod) {
        origen = "F";
        cod_producto = Number(cod);
      } else {
        origen = "C";
        cultivo_custom = custom || (selectedProd?.descripcion || "");
      }

      if (origen === "C" && !cultivo_custom) {
        msg.textContent = "Indica el cultivo personalizado (o elige uno de la lista).";
        msg.className = "text-danger";
        return;
      }

      const variedad = (container.querySelector("#variedad")?.value || "").trim() || null;
      const estado = container.querySelector("#estado")?.value || "en_curso";
      const sistema = container.querySelector("input[name='sistema_explotacion']:checked")?.value || "S";

      const tipo_registro = container.querySelector("#tipo_registro")?.value || "CAMPANA";
      const campana = (tipo_registro === "CAMPANA")
        ? (Number(container.querySelector("#campana")?.value) || null)
        : null;

      const fechaInicioRaw = container.querySelector("#fecha_inicio")?.value || null;
      const fechaFinRaw = container.querySelector("#fecha_fin")?.value || null;

      const fechaInicio = parseDateToISO(fechaInicioRaw);
      const fechaFin = parseDateToISO(fechaFinRaw);

      if (fechaFin && fechaInicio && fechaFin < fechaInicio) {
        msg.textContent = "La fecha fin no puede ser anterior a la de inicio.";
        msg.className = "text-danger";
        return;
      }

      if (!fechaInicio) {
        msg.textContent = "Selecciona la fecha de inicio.";
        msg.className = "text-danger";
        return;
      }

      // --- Validación campaña vs fecha (error custom) ---
      if (tipo_registro === "CAMPANA") {
        if (!campana) {
          msg.textContent = "Selecciona un año de campaña.";
          msg.className = "text-danger";
          return;
        }

        // fechaInicio viene ISO: YYYY-MM-DD
        const yFecha = Number(String(fechaInicio).slice(0, 4));
        if (Number.isFinite(yFecha) && Math.abs(yFecha - campana) >= 2) {
          msg.textContent =
            `Año inválido: la fecha de siembra (${yFecha}) no cuadra con la campaña (${campana}). ` +
            `Debe ser el mismo año o como mucho ±1 año.`;
          msg.className = "text-danger";
          return;
        }
      }

      // Si no hay fecha fin: estimación simple
      let fechaCosechaEst = fechaFin;
      let cosechaAuto = false;

      if (!fechaFin) {
        cosechaAuto = true;
        const d = new Date(fechaInicio);
        const deltaDays = (tipo_registro === "CAMPANA") ? 120 : 365;
        d.setDate(d.getDate() + deltaDays);
        fechaCosechaEst = d.toISOString().slice(0, 10);
      }

      const observaciones = container.querySelector("#observaciones")?.value || null;

      const payload = {
        id_recinto: recintoId,
        uso_sigpac: uso,
        sistema_explotacion: sistema,
        tipo_registro: tipo_registro,
        campana: campana,
        estado: estado,
        variedad: variedad,
        origen_cultivo: origen,
        cod_producto: cod_producto,
        cultivo_custom: cultivo_custom,
        observaciones: observaciones,
        cosecha_estimada_auto: cosechaAuto,
      };

      // Fechas según tipo_registro
      if (tipo_registro === "CAMPANA") {
        payload.fecha_siembra = fechaInicio;
      } else {
        payload.fecha_implantacion = fechaInicio;
      }
      payload.fecha_cosecha_estimada = fechaCosechaEst;

      // -------------------------
      // ENDPOINT SEGÚN MODO
      // -------------------------
      let url, method;

      if (mode === "historico_add") {
        url = `/api/mis-recinto/${recintoId}/cultivo-historico`;
        method = "POST";
      } else if (mode === "historico_edit") {
        if (!cultivoId) {
          msg.textContent = "Error: falta id_cultivo para editar el histórico.";
          msg.className = "text-danger";
          return;
        }
        url = `/api/cultivos/${cultivoId}`;
        method = "PATCH";
      } else {
        // modo actual
        url = `/api/mis-recinto/${recintoId}/cultivo`;
        method = cultivo ? "PATCH" : "POST";
      }

      try {
        await fetchJson(url, {
          method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        NotificationSystem.show({
          type: "success",
          title: "Cultivo guardado",
          message: "El cultivo ha sido guardado correctamente",
        });
        
        if (mode === "historico_edit" && currentCultivoId && String(cultivoId) === String(currentCultivoId)) {
          needsRefreshActualCultivo = true;
          // Repinta ya el actual en background aunque esté oculto
          renderCultivosForRecinto(recintoId);
        }

        // -------------------------
        // POST-ACCIÓN SEGÚN MODO
        // -------------------------
        if (mode === "historico_add" || mode === "historico_edit") {
          // volver al overlay y refrescar histórico
          if (typeof onDone === "function") onDone();
        } else {
          renderCultivosForRecinto(recintoId);
        }
      } catch (e) {
          console.warn(e);

          const backendMsg = e?.data?.error || e?.data?.message || "";

          if (backendMsg.includes("fecha de inicio debe ser anterior")) {
            msg.textContent = "El cultivo no puede ser más reciente que el actual.";
          } else if (backendMsg.includes("La fecha fin no puede ser anterior")) {
            msg.textContent = "La fecha fin no puede ser anterior a la de inicio.";
          } else if (backendMsg) {
            msg.textContent = backendMsg;
          } else {
            msg.textContent = "No se pudo guardar el cultivo.";
          }

          msg.className = "text-danger";
      }
    });
  }

  async function guardarNombreRecinto(nombre) {
    if (!currentSideRecintoId) return;

    try {
      const r = await fetch(
        `/api/mis-recinto/${currentSideRecintoId}/nombre`,
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ nombre })
        }
      );

      if (!r.ok) throw new Error();
    } catch (e) {
      mostrarErrorInline("No se pudo guardar el nombre");
    }
  }

    // CHECKBOX activo
    const sideActive = document.getElementById("side-active");
    if (sideActive) {
      sideActive.addEventListener("change", async () => {
        if (!currentSideRecintoId) return;

        const prev = !sideActive.checked; // estado anterior
        const next = sideActive.checked;

        sideActive.disabled = true;

        try {
          const r = await fetch(`/api/mis-recinto/${currentSideRecintoId}/activa`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ activa: next }),
          });

          const resp = await r.json().catch(() => ({}));
          if (!r.ok || !resp.ok) {
            throw new Error(resp.error || "No se pudo actualizar 'activa'");
          }

          // asegurar checkbox según backend
          sideActive.checked = !!resp.activa;

        } catch (err) {
          console.error(err);
          // revertir si falla
          sideActive.checked = prev;

          NotificationSystem.show({
            type: "error",
            title: "No se pudo guardar",
            message: "No se ha podido actualizar el estado del recinto. Intenta de nuevo."
          });
        } finally {
          sideActive.disabled = false;
        }
      });
    }


  // -----------------------------------------
  // 3) Capas base
  // -----------------------------------------
  const baseOSM = L.tileLayer(
    "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
    {
      attribution: "&copy; OpenStreetMap contributors",
      minZoom: 8,
      maxZoom: 19,
    }
  ).addTo(map);

  const baseSat = L.tileLayer(
    "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
    {
      attribution: "Tiles &copy; Esri",
      minZoom: 8,
      maxZoom: 19,
    }
  );

 const baseSentinelRecent = L.imageOverlay(
    `/static/sentinel2/s2_rgb_latest.png?v={{ sentinel2_version }}`,
    ROI_BOUNDS,
    { opacity: 1.0, interactive: false, className: "ndvi-overlay" }
  );

  const baseNdvi = L.imageOverlay(
    `/static/ndvi/ndvi_latest_3857.png?v={{ ndvi_version }}`,
    NDVI_BOUNDS,
    { opacity: 1.0, className: "ndvi-overlay", interactive: false }
  );

  const highZoomLayers = {
    satellite: baseSat,
    sentinel_recent: baseSentinelRecent,
    ndvi: baseNdvi
  };

  let activeHighLayerKey = "satellite";
  function getActiveHighLayer() {
    return highZoomLayers[activeHighLayerKey];
  }

  // -----------------------------------------
  // 4) Capa de recintos
  // -----------------------------------------

  const RECINTO_STYLE_DEFAULT = {
    color: "#ff8800",
    weight: 1,
  };

  const RECINTO_STYLE_SELECTED = {
    color: "#0077ff",
    weight: 2,
    fillOpacity: 0.25,
  };

  let selectedRecintoLayer = null;
  

  const recintosLayer = L.geoJSON(null, {
    pane: 'sigpacPane',
    style: function () {
      return RECINTO_STYLE_DEFAULT;
    },
    onEachFeature: function (feature, layer) {
      const p = feature.properties || {};

      // Propietario: username o "N/A"
      const propietarioTexto =
        p.propietario && String(p.propietario).trim() !== ""
          ? p.propietario
          : "N/A";

      const tienePropietario = propietarioTexto !== "N/A";
      const disabledAttr = tienePropietario ? "disabled" : "";
      const disabledStyle = tienePropietario
        ? "opacity: 0.5; cursor: not-allowed;"
        : "";

      const html = `
        <div class="popup-recinto">
          <div class="popup-recinto-info">
            <strong>Provincia:</strong> ${p.provincia ?? " "} - ${p.nombre_provincia ?? " "}<br>
            <strong>Municipio:</strong> ${p.municipio ?? " "} - ${p.nombre_municipio ?? " "}<br>
            <strong>Polígono:</strong> ${p.poligono ?? "-"}<br>
            <strong>Parcela:</strong> ${p.parcela ?? "-"}<br>
            <strong>Recinto:</strong> ${p.recinto ?? "-"}<br>
            <strong>Propietario:</strong> ${propietarioTexto}
          </div>
          <div style="margin-top: 10px; text-align: right;">
            <button
              type="button"
              class="btn-add-recinto"
              data-id-recinto="${p.id_recinto ?? ""}"
              data-provincia="${p.provincia ?? ""}"
              data-municipio="${p.municipio ?? ""}"
              data-agregado="${p.agregado ?? ""}"
              data-zona="${p.zona ?? ""}"
              data-poligono="${p.poligono ?? ""}"
              data-parcela="${p.parcela ?? ""}"
              data-recinto="${p.recinto ?? ""}"
              ${disabledAttr}
              style="
                padding: 6px 10px;
                font-size: 0.85rem;
                border-radius: 999px;
                border: none;
                background-color: #198754;
                color: white;
                cursor: pointer;
                ${disabledStyle}
              "
              onclick="window._solicitarRecintoDesdePopup(this)"
            >
              Añadir a mis recintos
            </button>
          </div>
        </div>
      `;

      layer.bindPopup(html);

      // Marcar visualmente la selección
      layer.on("click", function () {
        if (selectedRecintoLayer && selectedRecintoLayer !== layer) {
          selectedRecintoLayer.setStyle(RECINTO_STYLE_DEFAULT);
        }
        selectedRecintoLayer = layer;
        layer.setStyle(RECINTO_STYLE_SELECTED);
        layer.openPopup();
      });
    },
  }).addTo(map);

  function openSigpacPopupForKey(key) {
    let targetLayer = null;

    recintosLayer.eachLayer((lyr) => {
      const p = (lyr.feature && lyr.feature.properties) || {};
      if (String(p.id_recinto) === String(key)) targetLayer = lyr;
    });

    if (!targetLayer) return false;

    if (selectedRecintoLayer && selectedRecintoLayer !== targetLayer) {
      selectedRecintoLayer.setStyle(RECINTO_STYLE_DEFAULT);
    }
    selectedRecintoLayer = targetLayer;
    targetLayer.setStyle(RECINTO_STYLE_SELECTED);
    targetLayer.openPopup();
    return true;
  }

  function openSigpacPopupForKeyWithRetry(key, tries = 12) {
    if (openSigpacPopupForKey(key)) return;
    if (tries <= 0) return;
    setTimeout(() => openSigpacPopupForKeyWithRetry(key, tries - 1), 250);
  }

  const MIS_RECINTO_STYLE = {
    color: "#00a86b",
    weight: 5,
    opacity: 1,
    fillColor: "#00a86b",
    fillOpacity: 0.22,
  };

  async function abrirRecintoEnPanel(data) {
    if (!data || !data.id) return;

    // abrir split
    setSplitMode(true);

    // setear id global
    currentSideRecintoId = data.id;

    // pintar panel
    renderSidePanelFromProps(data);

    // centrar y resaltar
    centrarEnRecinto(data);
  }

  async function abrirRecintoDesdeVer(dataFlask) {
    if (!dataFlask || !dataFlask.id) return;

    // Siempre centramos y resaltamos en rojo
    centrarEnRecinto(dataFlask);

    // Comprobar si es mío intentando pedir detalle "mis-recinto"
    try {
      const r = await fetch(`/api/mis-recinto/${dataFlask.id}`);
      if (!r.ok) throw new Error("No es mío");

      const dataDb = await r.json();

      // Es mío -> abrir panel con datos reales de BBDD
      setSplitMode(true);
      currentSideRecintoId = dataDb.id;
      renderSidePanelFromProps(dataDb);

    } catch (_) {
      // No es mío (admin u otro) -> NO abrir panel
      setSplitMode(false);
    }
  }

  async function abrirSidePanelSiEsMio(recintoId) {
    if (!recintoId) return false;

    try {
      const r = await fetch(`/api/mis-recinto/${recintoId}`);
      if (!r.ok) return false;

      const dataDb = await r.json();

      setSplitMode(true);
      currentSideRecintoId = dataDb.id;
      renderSidePanelFromProps(dataDb);

      return true;
    } catch (e) {
      return false;
    }
  }

  async function centrarYAbrirPanelSiEsMio(dataFlask) {
    if (!dataFlask || !dataFlask.id) return;
    centrarEnRecinto(dataFlask);
    await abrirSidePanelSiEsMio(dataFlask.id);
  }

  const misRecintosLayer = L.geoJSON(null, {
    pane: 'misPane',
    style: () => MIS_RECINTO_STYLE,
    onEachFeature: function (feature, layer) {
      layer.on("click", async function (e) {
        try { L.DomEvent.stop(e); } catch (_) {}

        const id = feature?.properties?.id_recinto;
        if (!id) return;

        try {
          const r = await fetch(`/api/mis-recinto/${id}`);
          if (!r.ok) throw new Error("No se pudo cargar detalle del recinto");
          const data = await r.json();

          abrirRecintoEnPanel(data);

        } catch (err) {
          console.error(err);
        }
      });
    }
  }).addTo(map);
    
  // Mis IDs para evitar duplicados
  const MIS_IDS = new Set();

  // Por defecto activos
  let misRecintosActivos = true;

  function cargarMisRecintosSiProcede() {
    const z = map.getZoom();

    if (z < ZOOM_RECINTOS || !misRecintosActivos) {
      misRecintosLayer.clearLayers();
      return;
    }

    const b = map.getBounds();
    const bbox = [
      b.getWest().toFixed(6),
      b.getSouth().toFixed(6),
      b.getEast().toFixed(6),
      b.getNorth().toFixed(6),
    ].join(",");

    fetch(`/api/mis-recintos?bbox=${bbox}`)
      .then((r) => {
        if (!r.ok) throw new Error("Respuesta no OK de /api/mis-recintos");
        return r.json();
      })
      .then((fc) => {
        misRecintosLayer.clearLayers();

        MIS_IDS.clear();
        if (fc && fc.features && fc.features.length) {
          fc.features.forEach(f => {
            const p = f.properties || {};
            if (p.id_recinto != null) MIS_IDS.add(String(p.id_recinto));
          });
          misRecintosLayer.addData(fc);
        }
      })
      .catch((err) => console.error("Error al cargar mis recintos:", err));
  }

  // *** Recintos activos por defecto ***
  let recintosActivos = true;

  // Función auxiliar para llamar a la API de solicitudes
  function solicitarRecinto(payload) {
    fetch("/api/solicitudes-recinto", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(payload),
    })
      .then((response) => response.json().catch(() => ({})))
      .then((data) => {
        if (data && data.ok) {
         NotificationSystem.show({
            type: 'success',
            title: '¡Solicitud enviada!',
            message: 'Tu solicitud ha sido enviada al administrador correctamente.'
          }); 
        } else {
          const msg = (data && data.error) || "No se ha podido crear la solicitud. ¿Estás identificado?";
          console.error("Error en la respuesta de la API:", data);

          NotificationSystem.show({
            type: 'error',
            title: 'Error en la solicitud',
            message: msg
          });
        }
      })
      .catch((err) => {
        console.error("Error al crear la solicitud de recinto:", err);

        NotificationSystem.show({
          type: 'warning',
          title: 'Error de comunicación',
          message: 'No se pudo conectar con el servidor. Por favor, intenta de nuevo.'
        });
      });
  }

  // Función auxiliar para mensajes tipo bootstrap
  function mostrarErrorInline(msg) {
    const c = document.getElementById("side-alerts");
    if (!c) return;

    c.innerHTML = `
      <div class="alert alert-danger alert-dismissible fade show" role="alert">
        ${msg}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    `;
  }

  // Handler global llamado desde el botón del popup
  window._solicitarRecintoDesdePopup = function (btn) {
    if (!btn || btn.disabled) return;

    const ds = btn.dataset;

    const payload = {
      id_recinto: ds.idrecinto || null,
      provincia: ds.provincia ? Number(ds.provincia) : null,
      municipio: ds.municipio ? Number(ds.municipio) : null,
      nombre_municipio: ds.nombre_municipio ? ds.nombre_municipio : null,
      nombre_provincia: ds.nombre_provincia ? ds.nombre_provincia : null,
      agregado: ds.agregado ? Number(ds.agregado) : null,
      zona: ds.zona ? Number(ds.zona) : null,
      poligono: ds.poligono ? Number(ds.poligono) : null,
      parcela: ds.parcela ? Number(ds.parcela) : null,
      recinto: ds.recinto ? Number(ds.recinto) : null,
    };

    solicitarRecinto(payload);
  };

  // -----------------------------------------
  // 5) Cargar recintos
  // -----------------------------------------
  function cargarRecintosSiProcede() {
    const z = map.getZoom();

    if (z < ZOOM_RECINTOS || !recintosActivos) {
      recintosLayer.clearLayers();
      return;
    }

    const b = map.getBounds();
    const bbox = [
      b.getWest().toFixed(6),
      b.getSouth().toFixed(6),
      b.getEast().toFixed(6),
      b.getNorth().toFixed(6),
    ].join(",");

    console.log("Solicitando recintos para bbox:", bbox);

    fetch(`/api/recintos?bbox=${bbox}`)
      .then((response) => {
        if (!response.ok) {
          throw new Error("Respuesta no OK de /api/recintos");
        }
        return response.json();
      })
      .then((fc) => {
        console.log("Recintos recibidos:", fc && fc.features ? fc.features.length : 0);
        recintosLayer.clearLayers();
        if (!fc || !fc.features || fc.features.length === 0) {
          return;
        }
        recintosLayer.addData(fc);
      })
      .catch((err) => {
        console.error("Error al cargar recintos:", err);
      });
  }

  // -----------------------------------------
  // 6) Actualizar mapa según zoom
  // -----------------------------------------
  function actualizarMapaSegunZoom() {
    const z = map.getZoom();
    const activeHighLayer = getActiveHighLayer();

    if (z >= ZOOM_RECINTOS) {
      if (map.hasLayer(baseOSM)) {
        map.removeLayer(baseOSM);
      }

      Object.values(highZoomLayers).forEach((layer) => {
        if (layer && layer !== activeHighLayer && map.hasLayer(layer)) {
          map.removeLayer(layer);
        }
      });

      if (activeHighLayer && !map.hasLayer(activeHighLayer)) {
        activeHighLayer.addTo(map);
      }
    } else {
      Object.values(highZoomLayers).forEach((layer) => {
        if (layer && map.hasLayer(layer)) {
          map.removeLayer(layer);
        }
      });

      if (!map.hasLayer(baseOSM)) {
        baseOSM.addTo(map);
      }

      recintosLayer.clearLayers();
    }
  }

  // -----------------------------------------
  // 7) Eventos del mapa
  // -----------------------------------------

  map.on("zoomend", () => {
    actualizarMapaSegunZoom();
    cargarRecintosSiProcede();
    cargarMisRecintosSiProcede();
  });

  map.on("moveend", () => {
    cargarRecintosSiProcede();
    cargarMisRecintosSiProcede();
  });

  actualizarMapaSegunZoom();
  cargarRecintosSiProcede();
  cargarMisRecintosSiProcede();

  // -----------------------------------------
  // 8) Lógica del panel y botones sincronizados
  // -----------------------------------------
  const toggleBtn = document.getElementById("basemap-toggle");
  const panel = document.getElementById("basemap-panel");
  const basemapContainer = document.getElementById("basemap-panel-container");
  const filtroContainer = document.getElementById("filtro-container");

  toggleBtn.addEventListener("click", () => {
    const isOpening = !panel.classList.contains("visible");

    panel.classList.toggle("visible");
    toggleBtn.classList.toggle("active");

    // Desplazar ambos contenedores
    if (isOpening) {
      basemapContainer.classList.add("panel-open");
      filtroContainer.classList.add("panel-open");
    } else {
      basemapContainer.classList.remove("panel-open");
      filtroContainer.classList.remove("panel-open");
    }
  });

  // --- Selección de mapa principal ---
  document
    .querySelectorAll(".basemap-option.basemap-main[data-layer]")
    .forEach((option) => {
      if (option.classList.contains("disabled")) return;
      option.addEventListener("click", () => {
        const layerKey = option.dataset.layer;
        if (!highZoomLayers[layerKey]) {
          return;
        }

        document
          .querySelectorAll(".basemap-option.basemap-main")
          .forEach((el) => el.classList.remove("active"));
        option.classList.add("active");

        activeHighLayerKey = layerKey;
        actualizarMapaSegunZoom();
      });
    });

  // --- Toggle Recintos SigPac ---
  const recintosOption = document.querySelector(
    '.basemap-option.basemap-detail[data-detail="sigpac"]'
  );

  if (recintosOption) {
    recintosOption.addEventListener("click", () => {
      recintosActivos = !recintosActivos;

      if (recintosActivos) {
        recintosOption.classList.add("active");
        cargarRecintosSiProcede();
      } else {
        recintosOption.classList.remove("active");
        recintosLayer.clearLayers();
      }
    });
  }

  // --- Toggle MisRecintos ---
  const misRecintosOption = document.querySelector(
    '.basemap-option.basemap-detail[data-detail="mis"]'
  );

  if (misRecintosOption) {
    misRecintosOption.addEventListener("click", () => {
      misRecintosActivos = !misRecintosActivos;

      if (misRecintosActivos) {
        misRecintosOption.classList.add("active");
        cargarMisRecintosSiProcede();
      } else {
        misRecintosOption.classList.remove("active");
        misRecintosLayer.clearLayers();
      }
    });
  }


  // ============================================
  // CENTRAR EN RECINTO ESPECÍFICO
  // ============================================

  // Recibir datos del recinto específico desde Flask
  const recintoData = {{ recinto_data| tojson | safe if recinto_data else 'null' }};

  // Variable para guardar la capa del recinto resaltado
  let recintoResaltado = null;

  // Función para limpieza de capa roja
  function clearHighlight() {
    if (recintoResaltado) {
      try {
        map.removeLayer(recintoResaltado); // Quita la capa roja
      } catch (e) { }
      recintoResaltado = null;
    }
  }

  // Función para centrar en un recinto específico
  function centrarEnRecinto(data) {
    if (!data) return;

    // Limpiar cualquier resaltado previo
    clearHighlight();

    console.log('Centrando en recinto:', data);

    try {
      // Parsear el GeoJSON del recinto
      const geojson = JSON.parse(data.geojson);

      // Crear el FeatureCollection completo
      const featureCollection = {
        type: 'FeatureCollection',
        features: [{
          type: 'Feature',
          geometry: geojson,
          properties: {
            id_recinto: data.id,
            provincia: data.provincia,
            municipio: data.municipio,
            nombre_municipio: data.nombre_municipio,
            nombre_provincia: data.nombre_provincia,
            poligono: data.poligono,
            parcela: data.parcela,
            recinto: data.recinto,
            nombre: data.nombre,
            superficie_ha: data.superficie_ha,
            propietario: data.propietario
          }
        }]
      };

      // Función para abrir popup del recinto en la capa de recintos
      function openSigpacPopupForKey(key) {
        let targetLayer = null;

        recintosLayer.eachLayer((lyr) => {
          const p = (lyr.feature && lyr.feature.properties) || {};
          if (String(p.id_recinto) === String(key)) {
            targetLayer = lyr;
          }
        });

        if (targetLayer) {
          const p = (targetLayer.feature && targetLayer.feature.properties) || {};
          const esMio = MIS_IDS.has(String(key));

          // Si es mío: NO abrir popup ni aplicar estilo azul
          if (esMio) {
            if (selectedRecintoLayer) {
              selectedRecintoLayer.setStyle(RECINTO_STYLE_DEFAULT);
              selectedRecintoLayer = null;
            }
            return; // no abrir popup si es mío
          }

          // Si NO es mío: comportamiento normal (abrir popup "Añadir a mis recintos")
          if (selectedRecintoLayer && selectedRecintoLayer !== targetLayer) {
            selectedRecintoLayer.setStyle(RECINTO_STYLE_DEFAULT);
          }
          selectedRecintoLayer = targetLayer;
          targetLayer.setStyle(RECINTO_STYLE_SELECTED);
          targetLayer.openPopup();
        }
      }

      // Guardar la clave del recinto rojo
      const highlightKey = String(data.id);

      // Crear la geometría con Leaflet con estilo destacado
      recintoResaltado = L.geoJSON(featureCollection, {
        pane: 'highlightPane',
        style: {
          color: '#FF0000',
          weight: 4,
          fillColor: '#FF6B6B',
          fillOpacity: 0.3,
          dashArray: '10, 5'
        }
      }).addTo(map);
      // asegurar arriba del todo
      recintoResaltado.bringToFront();


      // Crear contenido del popup
      const popupContent = `
      <div class="popup-recinto" style="min-width: 250px;">
        <div class="popup-recinto-info" style="font-size: 0.9rem;">
          <strong>Provincia:</strong> ${data.provincia} - ${data.nombre_provincia}<br>
          <strong>Municipio:</strong> ${data.municipio} - ${data.nombre_municipio}<br>
          <strong>Polígono:</strong> ${data.poligono}<br>
          <strong>Parcela:</strong> ${data.parcela}<br>
          <strong>Recinto:</strong> ${data.recinto}<br>
          <strong>Superficie:</strong> ${data.superficie_ha.toFixed(2)} ha<br>
          <strong>Propietario:</strong> ${data.propietario}
        </div>
      </div>
    `;

      // Añadir popup
      recintoResaltado.bindPopup(popupContent, {
        maxWidth: 300,
        className: 'recinto-destacado-popup'
      });

      // Cerrar popup al hacer clic en el recinto rojo
      recintoResaltado.eachLayer((lyr) => {
        lyr.on('click', () => {
          try { lyr.closePopup(); } catch (e) { }
        });
      });


      // Obtener bounds del recinto
      const bounds = recintoResaltado.getBounds();

      // Calcular el zoom apropiado
      const zoom = map.getBoundsZoom(bounds, false);
      const targetZoom = Math.min(zoom, 18); // Máximo zoom 18

      // Primero hacer zoom para que se cargue la capa correcta
      map.setView(bounds.getCenter(), Math.max(targetZoom, ZOOM_RECINTOS));

      // Después de un momento, ajustar el bounds con padding
      setTimeout(() => {
        map.fitBounds(bounds, {
          padding: [80, 80],
          maxZoom: 18,
          animate: true,
          duration: 0.5
        });

        // Abrir el popup después del zoom
        setTimeout(() => {
          recintoResaltado.openPopup();
        }, 600);
      }, 300);

    } catch (error) {
      console.error('Error al centrar en el recinto:', error);

      // Fallback: usar el bbox si falla el GeoJSON
      if (data.bbox && data.bbox.length === 4) {
        const [minx, miny, maxx, maxy] = data.bbox;
        const bounds = [[miny, minx], [maxy, maxx]];

        map.setView(
          [(miny + maxy) / 2, (minx + maxx) / 2],
          Math.max(ZOOM_RECINTOS, 16)
        );

        setTimeout(() => {
          map.fitBounds(bounds, {
            padding: [80, 80],
            maxZoom: 18
          });
        }, 300);
      }
    }
  }

  // Si hay datos de recinto, centrar en él cuando el mapa esté listo
  if (recintoData) {
    console.log('Recinto específico detectado, preparando centrado...');

    // Esperar a que el mapa esté completamente cargado
    map.whenReady(function () {
      console.log('Mapa listo, centrando en recinto...');

      // Activar recintos si están desactivados
      if (!recintosActivos) {
        recintosActivos = true;
        const recintosOption = document.querySelector(
          '.basemap-option.basemap-detail[data-detail="sigpac"]'
        );
        if (recintosOption) {
          recintosOption.classList.add('active');
        }
      }

      // Pequeño delay para asegurar que todo esté inicializado
      setTimeout(() => {
        abrirRecintoDesdeVer(recintoData);
      }, 300);
    });
  }


  if (recintoData) {
    // Crear control personalizado
    const RecentrarControl = L.Control.extend({
      options: {
        position: 'topleft'
      },

      onAdd: function (map) {
        const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control');
        const button = L.DomUtil.create('a', '', container);

        button.href = '#';
        button.title = 'Volver a centrar en el recinto';
        button.innerHTML = '<i class="bi bi-crosshair" style="font-size: 18px; line-height: 30px;"></i>';
        button.style.width = '30px';
        button.style.height = '30px';
        button.style.lineHeight = '30px';
        button.style.display = 'flex';
        button.style.alignItems = 'center';
        button.style.justifyContent = 'center';
        button.style.backgroundColor = 'white';
        button.style.textDecoration = 'none';
        button.style.color = '#333';

        L.DomEvent.on(button, 'click', function (e) {
          L.DomEvent.stopPropagation(e);
          L.DomEvent.preventDefault(e);
          centrarYAbrirPanelSiEsMio(recintoData);
        });

        return container;
      }
    });

    map.addControl(new RecentrarControl());
  }

  const editarBtn = document.getElementById('editar-btn');
  const dibujarBtn = document.getElementById('dibujar-btn');
  const poligonoBtn = document.getElementById('poligono-btn');
  const aceptarBtn = document.getElementById('aceptar-btn');
  const cancelarBtn = document.getElementById('cancelar-btn');
  const limpiarBtn = document.getElementById('limpiar-btn');

  // FeatureGroup para guardar los elementos dibujados
  const drawnItems = new L.FeatureGroup();
  map.addLayer(drawnItems);

 let rectangleDrawer = null;
  let polygonDrawer = null;
  let dibujosTemporales = [];
  let modoEdicion = false;

  // Función para deshabilitar/habilitar interacción con recintos
  function toggleInteraccionRecintos(enabled) {
    if (enabled) {
      // Reactivar popups
      recintosLayer.eachLayer(layer => {
        if (layer._popup) layer.bindPopup(layer._popup);
      });
    } else {
      // Desactivar popups
      recintosLayer.eachLayer(layer => layer.unbindPopup());
    }
  }

  // Al hacer clic en editar
  editarBtn.addEventListener('click', () => {
    editarBtn.classList.add('hidden');
    dibujarBtn.classList.remove('hidden');
    poligonoBtn.classList.remove('hidden');
    aceptarBtn.classList.remove('hidden');
    cancelarBtn.classList.remove('hidden');
    limpiarBtn.classList.remove('hidden');

    // Activar modo edición y deshabilitar interacción con recintos
    modoEdicion = true;
    toggleInteraccionRecintos(false);

    // Guardar estado actual
    dibujosTemporales = [];
    drawnItems.eachLayer(layer => {
      dibujosTemporales.push(layer);
    });

    console.log('Modo edición activado');
  });

  // Al hacer clic en dibujar rectángulo
  dibujarBtn.addEventListener('click', () => {
    // Desactivar polígono si está activo
    if (polygonDrawer) {
      polygonDrawer.disable();
      polygonDrawer = null;
    }

    // Crear y activar el dibujador de rectángulos
    rectangleDrawer = new L.Draw.Rectangle(map);
    rectangleDrawer.enable();

    console.log('Modo dibujo de rectángulo activado');
  });

  // Al hacer clic en dibujar polígono
  poligonoBtn.addEventListener('click', () => {
    // Desactivar rectángulo si está activo
    if (rectangleDrawer) {
      rectangleDrawer.disable();
      rectangleDrawer = null;
    }

    // Crear y activar el dibujador de polígonos
    polygonDrawer = new L.Draw.Polygon(map);
    polygonDrawer.enable();

    console.log('Modo dibujo de polígono activado - Haz clic para añadir puntos, doble clic para terminar');
  });

  // Evento cuando se completa el dibujo
  map.on(L.Draw.Event.CREATED, (e) => {
    const layer = e.layer;
    drawnItems.addLayer(layer);
    console.log('Forma dibujada:', layer);
  });

  // Al hacer clic en aceptar
  aceptarBtn.addEventListener('click', () => {
    dibujarBtn.classList.add('hidden');
    poligonoBtn.classList.add('hidden');
    aceptarBtn.classList.add('hidden');
    cancelarBtn.classList.add('hidden');
    limpiarBtn.classList.add('hidden');
    editarBtn.classList.remove('hidden');

    // Desactivar modo edición y reactivar interacción
    modoEdicion = false;
    toggleInteraccionRecintos(true);

    // Desactiva ambos modos de dibujo si están activos
    if (rectangleDrawer) {
      rectangleDrawer.disable();
      rectangleDrawer = null;
    }
    if (polygonDrawer) {
      polygonDrawer.disable();
      polygonDrawer = null;
    }

    console.log('Cambios guardados');
  });

  // Al hacer clic en cancelar
  cancelarBtn.addEventListener('click', () => {
    dibujarBtn.classList.add('hidden');
    poligonoBtn.classList.add('hidden');
    aceptarBtn.classList.add('hidden');
    cancelarBtn.classList.add('hidden');
    limpiarBtn.classList.add('hidden');
    editarBtn.classList.remove('hidden');

    // Desactivar modo edición y reactivar interacción
    modoEdicion = false;
    toggleInteraccionRecintos(true);

    // Desactiva ambos modos de dibujo
    if (rectangleDrawer) {
      rectangleDrawer.disable();
      rectangleDrawer = null;
    }
    if (polygonDrawer) {
      polygonDrawer.disable();
      polygonDrawer = null;
    }

    // Restaurar estado anterior (eliminar dibujos nuevos)
    drawnItems.clearLayers();
    dibujosTemporales.forEach(layer => {
      drawnItems.addLayer(layer);
    });

    console.log('Edición cancelada');
  });

  // Al hacer clic en limpiar
  limpiarBtn.addEventListener('click', () => {
    // Eliminar todos los dibujos
    drawnItems.clearLayers();
    console.log('Todos los dibujos eliminados');
  });
 
  });
</script>

{% endblock %}