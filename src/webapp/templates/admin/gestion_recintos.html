{% extends "base.html" %}
{% block title %}Gestión de recintos - Admin{% endblock %}
{% block content %}

<style>


@keyframes spin3d {
  0% {
    transform: rotate(0deg) scale(1);
  }
  50% {
    transform: rotate(180deg) scale(1.1);
  }
  100% {
    transform: rotate(360deg) scale(1);
  }
}

.spinning {
  animation: spin3d 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
  display: inline-block;
  transform-origin: center;
}

/* Efecto de pulso en el botón mientras carga */
@keyframes buttonPulse {
  0%, 100% {
    box-shadow: 0 0 0 0 rgba(13, 110, 253, 0.4);
  }
  50% {
    box-shadow: 0 0 0 8px rgba(13, 110, 253, 0);
  }
}

#btnRefrescar:disabled {
  animation: buttonPulse 1.5s ease-in-out infinite;
}

/* Efecto de fade-in suave al actualizar contenido */
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.contenido-actualizado {
  animation: fadeIn 0.5s ease-out;
}

/* Hover effect en el botón de refrescar */
#btnRefrescar {
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

#btnRefrescar:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);
}

#btnRefrescar:hover:not(:disabled) #iconoRefresh {
  transform: rotate(180deg);
  transition: transform 0.6s ease;
}

/* Efecto de éxito al completar */
@keyframes successPulse {
  0% {
    box-shadow: 0 0 0 0 rgba(25, 135, 84, 0.7);
  }
  70% {
    box-shadow: 0 0 0 10px rgba(25, 135, 84, 0);
  }
  100% {
    box-shadow: 0 0 0 0 rgba(25, 135, 84, 0);
  }
}

.btn-success-flash {
  animation: successPulse 0.6s;
}

/* Mejora visual del badge de solicitudes pendientes */
@keyframes badgePulse {
  0%, 100% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.15);
  }
}

.badge-pulse {
  animation: badgePulse 0.5s ease-in-out 3;
}
</style>

<div class="container py-4">
  <h1 class="mb-4">Gestión de recintos</h1>

  {# Mensajes flash #}
  {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
  <div class="mb-3">
    {% for category, message in messages %}
    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
  </div>
  {% endif %}
  {% endwith %}

  {# Tabs de navegación #}
  {% set solicitudes_pendientes = solicitudes|selectattr('estado', 'equalto', 'pendiente')|list|length %}
  <ul class="nav nav-tabs" id="recintosTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link {% if solicitudes_pendientes == 0 %}active{% endif %}" id="recintos-tab"
        data-bs-toggle="tab" data-bs-target="#recintos-panel" type="button" role="tab" aria-controls="recintos-panel"
        aria-selected="{% if solicitudes_pendientes == 0 %}true{% else %}false{% endif %}">
        <i class="bi bi-building"></i> Recintos con propietario
        {% if recintos %}
        <span class="badge bg-primary ms-1">{{ recintos|length }}</span>
        {% endif %}
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link {% if solicitudes_pendientes > 0 %}active{% endif %}" id="solicitudes-tab"
        data-bs-toggle="tab" data-bs-target="#solicitudes-panel" type="button" role="tab"
        aria-controls="solicitudes-panel"
        aria-selected="{% if solicitudes_pendientes > 0 %}true{% else %}false{% endif %}">
        <i class="bi bi-envelope"></i> Solicitudes
        <span class="badge bg-warning text-dark ms-1" id="badge-solicitudes-pendientes">
          {{ solicitudes_pendientes }}
        </span>
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="logs-tab" data-bs-toggle="tab" data-bs-target="#logs-panel" type="button" role="tab"
        aria-controls="logs-panel" aria-selected="false">
        <i class="bi bi-clock-history"></i> Log de solicitudes
        {% if logs %}
        <span class="badge bg-secondary ms-1">{{ logs|length }}</span>
        {% endif %}
      </button>
    </li>
  </ul>

  {# Contenido de los tabs #}
  <div class="tab-content border border-top-0 p-4" id="recintosTabsContent">

    {# =========================== TAB 1: RECINTOS ASIGNADOS =========================== #}
    <div class="tab-pane fade {% if solicitudes_pendientes == 0 %}show active{% endif %}" id="recintos-panel"
      role="tabpanel" aria-labelledby="recintos-tab">
      
      {% if recintos %}
      <!-- Botones de exportación para recintos -->
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">Listado de Recintos</h5>
        <div class="btn-group" role="group">
          <button id="exportarRecintosCSV" class="btn btn-outline-success btn-sm">
            <i class="bi bi-file-earmark-spreadsheet me-1"></i>Exportar CSV
          </button>
          <button id="exportarRecintosPDF" class="btn btn-outline-danger btn-sm">
            <i class="bi bi-file-earmark-pdf me-1"></i>Exportar PDF
          </button>
        </div>
      </div>

      <div class="table-responsive">
        <table id="tablaUsuarios" class="table table-hover table-bordered align-middle">
          <thead class="table-light">
            <tr>
              <th class="text-center">Nombre</th>
              <th class="text-center">Superficie (ha)</th>
              <th class="text-center">Propietario</th>
              <th class="text-center">Provincia</th>
              <th class="text-center">Municipio</th>
              <th class="text-center">Estado</th>
              <th class="text-center">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for recinto in recintos %}
            <tr onclick="window.location='{{ url_for("dashboard.detalle_recinto", id_recinto=recinto.id_recinto) }}'"
              style="cursor:pointer;"
              data-nombre="{{ recinto.nombre }}"
              data-superficie="{{ '%.2f'|format(recinto.superficie_ha|float) }}"
              data-propietario="{{ recinto.propietario.username if recinto.propietario else 'N/A' }}"
              data-provincia="{{ recinto.provincia }}{% if recinto.nombre_provincia %} - {{ recinto.nombre_provincia }}{% endif %}"
              data-municipio="{{ recinto.municipio }}{% if recinto.nombre_municipio %} - {{ recinto.nombre_municipio }}{% endif %}"
              data-estado="{{ 'Activa' if recinto.activa else 'Inactiva' }}">
              <td>{{ recinto.nombre }}</td>
              <td>{{ "%.2f"|format(recinto.superficie_ha|float) }}</td>
              <td>
                {% if recinto.propietario %}
                <i class="bi bi-person-fill text-primary"></i> {{ recinto.propietario.username }}
                {% else %}
                <span class="text-muted">N/A</span>
                {% endif %}
              </td>
              <td data-order="{{ recinto.nombre_provincia or recinto.provincia }}">
                {{ recinto.provincia }}
                {% if recinto.nombre_provincia %} - {{ recinto.nombre_provincia }}{% endif %}
              </td>
              <td data-order="{{ recinto.nombre_municipio or recinto.municipio }}">
                {{ recinto.municipio }}
                {% if recinto.nombre_municipio %} - {{ recinto.nombre_municipio }}{% endif %}
              </td>

              <td>
                {% if recinto.activa %}
                <span class="badge bg-success"><i class="bi bi-check-circle"></i> Activa</span>
                {% else %}
                <span class="badge bg-secondary"><i class="bi bi-dash-circle"></i> Inactiva</span>
                {% endif %}
              </td>
              <td>
                <a href="{{ url_for('dashboard.visor', recinto_id=recinto.id_recinto) }}" class="btn btn-sm btn-info"
                  onclick="event.stopPropagation();" title="Ver en el mapa">
                  <i class="bi bi-map"></i> Ver
                </a>
                <button class="btn btn-sm btn-warning" data-bs-toggle="modal"
                  data-bs-target="#editarModal{{ recinto.id_recinto }}" onclick="event.stopPropagation();"
                  title="Editar recinto">
                  <i class="bi bi-pencil"></i> Editar
                </button>
              </td>
            </tr>
            <div class="modal fade" id="editarModal{{ recinto.id_recinto }}" tabindex="-1" aria-hidden="true">
              <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                  <form method="post"
                    action="{{ url_for('admin.editar_recinto_admin', id_recinto=recinto.id_recinto) }}">

                    <div class="modal-header bg-warning">
                      <h5 class="modal-title">
                        <i class="bi bi-pencil"></i> Editar recinto
                      </h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>

                    <div class="modal-body">

                      <!-- INFO SIGPAC -->
                      <div class="mb-3">
                        <label class="form-label fw-bold">
                          <i class="bi bi-info-circle text-muted"></i> Información SIGPAC
                        </label>
                        <p class="mb-0 small text-muted">
                          <code>{{ recinto.provincia }}-{{ recinto.municipio }}-{{ recinto.poligono }}-{{ recinto.parcela }}</code>
                        </p>
                        <p class="mb-0 small text-muted">
                          {{ recinto.nombre_provincia }} - {{ recinto.nombre_municipio }}
                        </p>
                      </div>

                      <!-- NOMBRE -->
                      <div class="mb-3">
                        <label class="form-label">
                          <i class="bi bi-card-text"></i> Nombre del recinto <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" name="nombre" value="{{ recinto.nombre }}"
                          maxlength="200" required>
                      </div>

                      <!-- PROPIETARIO -->
                      <div class="mb-3">
                        <label class="form-label">
                          <i class="bi bi-person"></i> Propietario
                        </label>
                        <select name="propietario_id" class="form-select">
                          {% for usuario in usuarios %}
                          <option value="{{ usuario.id_usuario }}" {% if recinto.propietario and
                            recinto.propietario.id==usuario.id %}selected{% endif %}>{{ usuario.username }} ({{
                            usuario.email }})</option>
                          {% endfor %}
                        </select>
                        <div class="form-text">
                          Puedes asignar o cambiar el propietario del recinto
                        </div>
                      </div>

                      <!-- ESTADO -->
                      <div class="mb-3">
                        <label class="form-label">
                          <i class="bi bi-toggle-on"></i> Estado
                        </label>
                        <div class="form-check form-switch">
                          <input class="form-check-input" type="checkbox" name="activa" value="1" {% if recinto.activa
                            %}checked{% endif %}>
                          <label class="form-check-label">Recinto activo</label>
                        </div>
                      </div>

                      <!-- SUPERFICIE -->
                      <div class="alert alert-info mb-0">
                        <small>
                          <i class="bi bi-info-circle"></i>
                          <strong>Superficie:</strong> {{ "%.2f"|format(recinto.superficie_ha) }} ha
                        </small>
                      </div>

                    </div>

                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-lg"></i> Cancelar
                      </button>
                      <button type="submit" class="btn btn-warning">
                        <i class="bi bi-save"></i> Guardar cambios
                      </button>
                    </div>

                  </form>
                </div>
              </div>
            </div>

            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="alert alert-info mb-0">
        <i class="bi bi-info-circle"></i> No hay recintos con propietario asignado.
      </div>
      {% endif %}
    </div>

    {# =========================== TAB 2: SOLICITUDES =========================== #}
    <div class="tab-pane fade {% if solicitudes_pendientes > 0 %}show active{% endif %}" id="solicitudes-panel"
      role="tabpanel" aria-labelledby="solicitudes-tab">
      
      <!-- Botón de refrescar -->
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">Gestión de Solicitudes</h5>
        <button 
          onclick="refrescarSolicitudes()" 
          class="btn btn-primary btn-sm" 
          id="btnRefrescar" 
          data-url="{{ url_for('admin.obtener_solicitudes_ajax') }}"
          title="Refrescar solicitudes">
          <i class="bi bi-arrow-clockwise" id="iconoRefresh"></i> Refrescar
        </button>
      </div>

      <div id="contenido-solicitudes">
        {% include 'admin/partials/solicitudes_tabla.html' %}
      </div>
    </div>

    {# =========================== TAB 3: LOG DE SOLICITUDES =========================== #}
    <div class="tab-pane fade" id="logs-panel" role="tabpanel" aria-labelledby="logs-tab">
      {% if logs_solicitudes %}
      <div class="table-responsive">
        <table id="tablaLogs" class="table table-hover table-bordered align-middle">
          <thead class="table-light">
            <tr>
              <th style="width: 12%;" class="text-center">Fecha y hora</th>
              <th style="width: 10%;" class="text-center">Admin</th>
              <th style="width: 15%;" class="text-center">Operación</th>
              <th style="width: 63%;" class="text-center">Detalles</th>
            </tr>
          </thead>
          <tbody>
            {% for log in logs_solicitudes %}
            <tr>
              <td style="width: 12%;" data-order="{{ log.fecha_hora.strftime('%Y-%m-%d %H:%M:%S') }}">
                <small>
                  <i class="bi bi-calendar3"></i>
                  {{ log.fecha_hora.strftime('%d-%m-%Y %H:%M:%S') }}
                </small>
              </td>
              <td style="width: 10%;">
                <i class="bi bi-person-badge text-primary"></i>
                <small><strong>{{ log.usuario.username }}</strong></small>
              </td>
              <td style="width: 15%;">
                {% if log.tipo_operacion == 'APROBAR_SOLICITUD' %}
                <span class="badge bg-success"><i class="bi bi-check-circle"></i> Aprobación</span>
                {% elif log.tipo_operacion == 'RECHAZAR_SOLICITUD' %}
                <span class="badge bg-danger"><i class="bi bi-x-circle"></i> Rechazo manual</span>
                {% elif log.tipo_operacion == 'RECHAZO_AUTOMATICO_SOLICITUD' %}
                <span class="badge bg-warning text-dark"><i class="bi bi-exclamation-triangle"></i> Rechazo
                  automático</span>
                {% elif log.tipo_operacion == 'APROBAR_SOLICITUD_YA_PROCESADA' %}
                <span class="badge bg-secondary"><i class="bi bi-info-circle"></i> Intento aprobación procesada</span>
                {% elif log.tipo_operacion == 'RECHAZAR_SOLICITUD_YA_PROCESADA' %}
                <span class="badge bg-secondary"><i class="bi bi-info-circle"></i> Intento rechazo procesada</span>
                {% else %}
                <span class="badge bg-secondary">{{ log.tipo_operacion }}</span>
                {% endif %}
              </td>
              <td style="width: 63%;">
                <small>{{ log.mensaje }}</small>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="alert alert-info mb-0">
        <i class="bi bi-info-circle"></i> No hay registros de logs de solicitudes todavía.
      </div>
      {% endif %}
    </div>

  </div>
</div>

<script>
/**
 * Gestión de solicitudes de recintos - Admin Panel
 */
async function refrescarSolicitudes() {
  const btn = document.getElementById('btnRefrescar');
  const icono = document.getElementById('iconoRefresh');
  const contenedor = document.getElementById('contenido-solicitudes');
  const badgePendientes = document.getElementById('badge-solicitudes-pendientes');
  
  // Guardar el número actual de pendientes para detectar cambios
  const pendientesActuales = parseInt(badgePendientes.textContent) || 0;
  
  // Deshabilitar botón y animar icono
  btn.disabled = true;
  icono.classList.add('spinning');
  
  // Añadir overlay de carga suave
  contenedor.style.opacity = '0.6';
  contenedor.style.pointerEvents = 'none';
  
  try {
    // Hacer petición AJAX
    const url = btn.getAttribute('data-url');
    const response = await fetch(url);
    
    if (!response.ok) {
      throw new Error('Error al cargar las solicitudes');
    }
    
    const data = await response.json();
    
    // Reemplazar el contenido de la tabla
    contenedor.innerHTML = data.html;
    contenedor.classList.add('contenido-actualizado');
    
    // Actualizar el badge de solicitudes pendientes
    badgePendientes.textContent = data.solicitudes_pendientes;
    
    // Si hay nuevas solicitudes, animar el badge
    if (data.solicitudes_pendientes > pendientesActuales) {
      badgePendientes.classList.add('badge-pulse');
      setTimeout(() => {
        badgePendientes.classList.remove('badge-pulse');
      }, 1500);
    }
    
    // Restaurar opacidad con animación
    contenedor.style.opacity = '1';
    contenedor.style.pointerEvents = 'auto';
    
    // Reinicializar DataTable si existe
    if (typeof $ !== 'undefined' && $.fn.DataTable) {
      if ($.fn.DataTable.isDataTable('#tablaRoles')) {
        $('#tablaRoles').DataTable().destroy();
      }
      
      $('#tablaRoles').DataTable({
        language: { url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json' },
        pageLength: 25,
        responsive: true,
        order: [[4, 'desc']]
      });
    }
    
    // Efecto de éxito visual en el botón
    btn.classList.add('btn-success-flash');
    setTimeout(() => {
      btn.classList.remove('btn-success-flash');
    }, 600);
    
    console.log('✓ Solicitudes actualizadas correctamente');
    
  } catch (error) {
    console.error('Error al refrescar solicitudes:', error);
    
    // Restaurar estado visual
    contenedor.style.opacity = '1';
    contenedor.style.pointerEvents = 'auto';
    
    // Mostrar mensaje de error
    alert('Error al actualizar las solicitudes. Por favor, intenta de nuevo.');
    
  } finally {
    // Rehabilitar botón y detener animación
    btn.disabled = false;
    icono.classList.remove('spinning');
    
    // Limpiar clase de animación
    setTimeout(() => {
      contenedor.classList.remove('contenido-actualizado');
    }, 500);
  }
}
</script>

{% block extra_js %}
<!-- jsPDF para exportar PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

<script>
  $(document).ready(function () {
    // DataTable para recintos
    var tableRecintos = $('#tablaUsuarios').DataTable({
      language: { url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json' },
      pageLength: 25,
      responsive: true,
      columnDefs: [
        { orderable: false, targets: -1 },
        { searchable: false, targets: -1 }  // No buscar en columna Acciones
      ]
    });

    // DataTable para solicitudes
    $('#tablaRoles').DataTable({
      language: { url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json' },
      pageLength: 25,
      responsive: true,
      order: [[4, 'desc']]
    });

    // DataTable para logs
    $('#tablaLogs').DataTable({
      language: { url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json' },
      pageLength: 50,
      responsive: true,
      order: [[0, 'desc']]
    });

    // ==================== EXPORTAR RECINTOS A CSV ====================
    $('#exportarRecintosCSV').on('click', function () {
      var rows = tableRecintos.rows({ search: 'applied' }).nodes();

      if (rows.length === 0) {
        alert('No hay recintos para exportar con los filtros actuales.');
        return;
      }

      var csv = [];
      csv.push('Nombre;Superficie (ha);Propietario;Provincia;Municipio;Estado');

      $(rows).each(function() {
        var $row = $(this);
        
        var nombre = $row.attr('data-nombre') || '';
        var superficie = $row.attr('data-superficie') || '';
        var propietario = $row.attr('data-propietario') || '';
        var provincia = $row.attr('data-provincia') || '';
        var municipio = $row.attr('data-municipio') || '';
        var estado = $row.attr('data-estado') || '';

        var rowData = [nombre, superficie, propietario, provincia, municipio, estado];

        var escapedData = rowData.map(function(value) {
          value = String(value).replace(/"/g, '""');
          if (value.includes(';') || value.includes('"') || value.includes('\n')) {
            return '"' + value + '"';
          }
          return value;
        });

        csv.push(escapedData.join(';'));
      });

      var csvContent = csv.join('\n');
      var BOM = '\uFEFF';
      csvContent = BOM + csvContent;

      var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      var link = document.createElement('a');
      
      if (link.download !== undefined) {
        var url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', 'recintos_' + new Date().toISOString().split('T')[0] + '.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      }
    });

    // ==================== EXPORTAR RECINTOS A PDF ====================
    $('#exportarRecintosPDF').on('click', function () {
      var rows = tableRecintos.rows({ search: 'applied' }).nodes();

      if (rows.length === 0) {
        alert('No hay recintos para exportar con los filtros actuales.');
        return;
      }

      var dataPDF = [];
      
      $(rows).each(function() {
        var $row = $(this);
        
        var nombre = $row.attr('data-nombre') || '';
        var superficie = $row.attr('data-superficie') || '';
        var propietario = $row.attr('data-propietario') || '';
        var provincia = $row.attr('data-provincia') || '';
        var municipio = $row.attr('data-municipio') || '';
        var estado = $row.attr('data-estado') || '';

        dataPDF.push([nombre, superficie, propietario, provincia, municipio, estado]);
      });

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('landscape');

      doc.setFontSize(18);
      doc.text('Listado de Recintos', 14, 20);

      doc.setFontSize(10);
      doc.text('Generado el: ' + new Date().toLocaleString('es-ES'), 14, 28);

      doc.autoTable({
        head: [['Nombre', 'Superficie (ha)', 'Propietario', 'Provincia', 'Municipio', 'Estado']],
        body: dataPDF,
        startY: 35,
        styles: { 
          fontSize: 9,
          cellPadding: 3
        },
        headStyles: { 
          fillColor: [40, 167, 69],
          textColor: 255,
          fontStyle: 'bold'
        },
        alternateRowStyles: {
          fillColor: [245, 245, 245]
        },
        margin: { top: 35, left: 14, right: 14 }
      });

      doc.save('recintos_' + new Date().toISOString().split('T')[0] + '.pdf');
    });
  });
</script>
{% endblock %}
{% endblock %}